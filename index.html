<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Essay Writing Assistant</title>
  
  <!-- Victorian Font Stack -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=IM+Fell+English:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Marked for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Firebase Configuration - Loaded from Netlify Function -->
  <script>
    // Firebase config will be loaded from serverless function
    window.FIREBASE_ENABLED = false; // Will be set to true after config loads
    window.FIREBASE_CONFIG = null;
    
    // Load Firebase config from Netlify Function (keeps API key in environment variables)
    async function loadFirebaseConfig() {
      try {
        const response = await fetch('/.netlify/functions/firebase-config');
        if (!response.ok) {
          throw new Error('Failed to load Firebase config');
        }
        const config = await response.json();
        if (config.error) {
          console.error('Firebase config error:', config.error, config.hint);
          return false;
        }
        window.FIREBASE_CONFIG = config;
        window.FIREBASE_ENABLED = true;
        console.log('Firebase config loaded successfully');
        return true;
      } catch (error) {
        console.error('Could not load Firebase config:', error);
        console.log('Falling back to Netlify Blobs (if available)');
        return false;
      }
    }
  </script>
  
  <!-- Dynamic Essay Loading System -->
  <script>
    // Initialize global essay storage
    window.ESSAYS = {};
    window.ESSAY_LIST = [];
    window.ESSAYS_LOADED = false;
    
    // Dynamic essay loader - fetches manifest.json and loads essay configs
    async function loadEssays() {
      try {
        // Fetch manifest to get list of essay IDs
        const response = await fetch('manifest.json');
        if (!response.ok) {
          throw new Error(`Failed to fetch manifest: ${response.status}`);
        }
        const essayIds = await response.json();
        console.log('Found essays in manifest:', essayIds);
        
        // Load each essay config file dynamically
        const loadPromises = essayIds.map(id => {
          return new Promise((resolve) => {
            const script = document.createElement('script');
            script.src = `${id}.js`;
            script.onload = () => {
              console.log(`Loaded essay: ${id}`);
              resolve(true);
            };
            script.onerror = () => {
              console.warn(`Failed to load essay: ${id}`);
              resolve(false); // Continue even if one fails
            };
            document.head.appendChild(script);
          });
        });
        
        // Wait for all essays to load
        await Promise.all(loadPromises);
        
        // Build ESSAY_LIST from loaded ESSAYS object
        window.ESSAY_LIST = Object.values(window.ESSAYS);
        window.ESSAYS_LOADED = true;
        console.log('All essays loaded:', (window.ESSAY_LIST || []).map(e => e.id));
        
      } catch (error) {
        console.error('Failed to load essays:', error);
        window.ESSAYS_LOADED = true; // Mark as loaded even on error so app can render
      }
    }
  </script>
  
  <style>
    /* =====================================================
       HOMEWORK TEMPLATE v6.0 - VICTORIAN GOLD EDITION
       Aesthetic: Elegant Victorian / Dark Gold
       ===================================================== */
    
    :root {
      /* Color System - Victorian Gold on Dark */
      --color-primary: #b8860b;
      --color-primary-light: #daa520;
      --color-primary-dark: #8b6914;
      --color-primary-glow: rgba(184, 134, 11, 0.4);
      --color-secondary: #daa520;
      --color-accent: #ffd700;
      --color-accent-light: #ffe55c;
      
      /* Dark Theme Backgrounds */
      --color-bg: #1a1a2e;
      --color-bg-alt: #16213e;
      --color-bg-elevated: #0f3460;
      --color-surface: rgba(30, 30, 50, 0.9);
      --color-surface-elevated: rgba(40, 40, 60, 0.95);
      --color-surface-hover: rgba(184, 134, 11, 0.15);
      --color-border: rgba(184, 134, 11, 0.3);
      --color-border-light: rgba(184, 134, 11, 0.2);
      --color-border-strong: #b8860b;
      
      /* Frost glass effect */
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* Text on Dark */
      --color-text: #e8e8e8;
      --color-text-secondary: #e8e8e8;
      --color-text-muted: #c0c0c0;
      --color-text-inverse: #1a1a2e;
      --color-text-gold: #daa520;
      
      /* Semantic Colors */
      --color-success: #22c55e;
      --color-success-light: rgba(34, 197, 94, 0.3);
      --color-success-bg: rgba(34, 197, 94, 0.15);
      --color-error: #ef4444;
      --color-error-light: rgba(239, 68, 68, 0.3);
      --color-error-bg: rgba(239, 68, 68, 0.15);
      --color-warning: #f59e0b;
      --color-warning-light: rgba(245, 158, 11, 0.3);
      --color-warning-bg: rgba(245, 158, 11, 0.15);
      --color-info: #3b82f6;
      --color-info-light: rgba(59, 130, 246, 0.3);
      --color-info-bg: rgba(59, 130, 246, 0.15);
      
      /* Typography - Elegant Serif */
      --font-display: 'Cinzel', 'Fraunces', Georgia, serif;
      --font-body: 'Crimson Text', 'IM Fell English', Georgia, serif;
      --font-mono: 'JetBrains Mono', monospace;
      
      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;
      --space-3xl: 64px;
      
      /* Borders & Shadows */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;
      --radius-2xl: 28px;
      --radius-full: 9999px;
      
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
      --shadow-gold: 0 0 30px rgba(184, 134, 11, 0.3);
      --shadow-gold-strong: 0 5px 20px rgba(184, 134, 11, 0.4);
      --shadow-inset-gold: inset 0 0 20px rgba(184, 134, 11, 0.1);
      
      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 300ms ease;
      --transition-slow: 500ms ease;
    }
    
    /* =====================================================
       BASE STYLES
       ===================================================== */
    
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      font-family: var(--font-body);
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      background-attachment: fixed;
      color: var(--color-text);
      line-height: 1.7;
      min-height: 100vh;
    }
    
    body::before {
      display: none;
    }
    
    #root {
      position: relative;
      z-index: 1;
    }
    
    /* =====================================================
       TYPOGRAPHY
       ===================================================== */
    
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-display);
      font-weight: 600;
      line-height: 1.25;
      color: var(--color-text);
    }
    
    h1 { font-size: 2.25rem; letter-spacing: 0.03em; }
    h2 { font-size: 1.75rem; letter-spacing: 0.02em; }
    h3 { font-size: 1.375rem; letter-spacing: 0.01em; }
    h4 { font-size: 1.125rem; }
    
    p {
      color: var(--color-text-secondary);
    }
    
    strong {
      font-weight: 600;
      color: var(--color-text);
    }
    
    /* =====================================================
       VICTORIAN UTILITIES & ANIMATIONS
       ===================================================== */
    
    .gold-glow {
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
    }
    
    .victorian-border {
      border: 3px solid var(--color-primary);
      box-shadow: var(--shadow-inset-gold), var(--shadow-gold);
      position: relative;
    }
    
    .victorian-border::before {
      content: '';
      position: absolute;
      inset: 4px;
      border: 1px solid rgba(184, 134, 11, 0.3);
      pointer-events: none;
      border-radius: inherit;
    }
    
    .frost-glass {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
    }
    
    @keyframes ghostAppear {
      0% { opacity: 0; transform: scale(0.95) translateY(10px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    @keyframes scoreReveal {
      0% { transform: scale(0.5); opacity: 0; }
      60% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes candleFlicker {
      0%, 100% { opacity: 1; filter: brightness(1); }
      50% { opacity: 0.9; filter: brightness(1.1); }
    }
    
    .ghost-appear { animation: ghostAppear 0.8s ease-out; }
    .score-reveal { animation: scoreReveal 0.6s ease-out; }
    .candle-flicker { animation: candleFlicker 3s ease-in-out infinite; }
    
    /* =====================================================
       LAYOUT
       ===================================================== */
    
    .app-container {
      width: 100%;
      max-width: 880px;
      margin: 0 auto;
      padding: var(--space-lg);
      padding-top: var(--space-xl);
      padding-bottom: var(--space-3xl);
    }
    
    .dashboard-container {
      max-width: 1200px;
    }
    
    /* =====================================================
       HEADER - VICTORIAN GOLD
       ===================================================== */
    
    .app-header {
      position: relative;
      background: linear-gradient(145deg, rgba(30, 30, 50, 0.9), rgba(20, 20, 40, 0.95));
      color: var(--color-text);
      padding: var(--space-xl) var(--space-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-xl);
      border: 3px solid var(--color-primary);
      box-shadow: var(--shadow-inset-gold), var(--shadow-gold);
    }
    
    .app-header::before {
      content: '';
      position: absolute;
      inset: 4px;
      border: 1px solid rgba(184, 134, 11, 0.3);
      border-radius: calc(var(--radius-lg) - 4px);
      pointer-events: none;
    }
    
    .app-header::after {
      display: none;
    }
    
    .app-header h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--color-primary-light);
      margin-bottom: var(--space-xs);
      position: relative;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
    }
    
    .app-header .subtitle {
      font-size: 1.1rem;
      color: var(--color-text-secondary);
      font-weight: 400;
      font-style: italic;
    }
    
    .header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-md);
      margin-top: var(--space-md);
      padding-top: var(--space-md);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      font-size: 0.9rem;
    }
    
    .header-meta span {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      opacity: 0.85;
    }
    
    /* =====================================================
       CARDS
       ===================================================== */
    
    .card {
      background: linear-gradient(145deg, rgba(30, 30, 50, 0.9), rgba(20, 20, 40, 0.95));
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      margin-bottom: var(--space-lg);
      border: 2px solid var(--color-border);
      box-shadow: var(--shadow-inset-gold), var(--shadow-md);
      transition: all var(--transition-base);
      position: relative;
    }
    
    .card::before {
      content: '';
      position: absolute;
      inset: 3px;
      border: 1px solid rgba(184, 134, 11, 0.15);
      border-radius: calc(var(--radius-lg) - 3px);
      pointer-events: none;
    }
    
    .card:hover {
      border-color: var(--color-primary);
      box-shadow: var(--shadow-inset-gold), var(--shadow-gold);
    }
    
    .card-elevated {
      background: linear-gradient(145deg, rgba(40, 40, 60, 0.95), rgba(30, 30, 50, 0.98));
    }
    
    .card-accent {
      border-left: 4px solid var(--color-primary);
    }
    
    /* =====================================================
       PROGRESS SECTION
       ===================================================== */
    
    .progress-section {
      background: linear-gradient(145deg, rgba(30, 30, 50, 0.9), rgba(20, 20, 40, 0.95));
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      border: 2px solid var(--color-border);
      box-shadow: var(--shadow-inset-gold);
      margin-bottom: var(--space-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border-light);
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
    }
    
    .progress-label {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--color-text);
    }
    
    .progress-stats {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      font-family: var(--font-mono);
    }
    
    /* Question Tracker - Clickable Navigation */
    .question-tracker {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      margin-top: var(--space-md);
    }
    
    .question-tracker-item {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all var(--transition-base);
      border: 2px solid var(--color-border);
      background: rgba(30, 30, 50, 0.8);
      color: var(--color-text-muted);
      position: relative;
    }
    
    .question-tracker-item:hover:not(.locked) {
      border-color: var(--color-primary);
      background: var(--color-surface-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-gold);
    }
    
    .question-tracker-item.current {
      border-color: var(--color-primary);
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
      color: var(--color-text-inverse);
      box-shadow: 0 0 15px var(--color-primary-glow);
    }
    
    .question-tracker-item.correct {
      border-color: var(--color-success);
      background: var(--color-success-bg);
      color: var(--color-success);
    }
    
    .question-tracker-item.correct::after {
      content: '\2713';
      position: absolute;
      top: -5px;
      right: -5px;
      width: 16px;
      height: 16px;
      background: var(--color-success);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .question-tracker-item.incorrect {
      border-color: var(--color-error);
      background: var(--color-error-bg);
      color: var(--color-error);
    }
    
    .question-tracker-item.incorrect::after {
      content: '!';
      position: absolute;
      top: -5px;
      right: -5px;
      width: 16px;
      height: 16px;
      background: var(--color-error);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.65rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .question-tracker-item.in-progress {
      border-color: var(--color-info);
      background: var(--color-info-bg);
      color: var(--color-info);
    }
    
    .question-tracker-item.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .question-tracker-item.locked:hover {
      transform: none;
    }
    
    .progress-summary {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
      margin-top: var(--space-md);
      padding-top: var(--space-md);
      border-top: 1px solid var(--color-border-light);
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    
    .progress-summary-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .progress-summary-dot {
      width: 10px;
      height: 10px;
      border-radius: var(--radius-full);
    }
    
    .progress-summary-dot.correct {
      background: var(--color-success);
    }
    
    .progress-summary-dot.incorrect {
      background: var(--color-error);
    }
    
    .progress-summary-dot.pending {
      background: var(--color-border);
    }
    
    /* =====================================================
       QUESTION CARD
       ===================================================== */
    
    .question-card {
      position: relative;
    }
    
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-lg);
    }
    
    .question-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      background: var(--color-primary);
      color: var(--color-text-inverse);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    
    .points-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      background: linear-gradient(135deg, var(--color-accent), var(--color-accent-light));
      color: var(--color-primary-dark);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 700;
      box-shadow: var(--shadow-sm);
    }
    
    .question-text {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 500;
      line-height: 1.5;
      color: var(--color-text);
      margin-bottom: var(--space-xl);
    }
    
    /* =====================================================
       OPTIONS (MCQ & True/False)
       ===================================================== */
    
    .options-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    
    .option-button {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      background: rgba(30, 30, 50, 0.8);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
      text-align: left;
      font-size: 1rem;
      color: var(--color-text);
      position: relative;
      overflow: hidden;
    }
    
    .option-button::before {
      display: none;
    }
    
    .option-button:hover:not(:disabled) {
      border-color: var(--color-primary);
      background: var(--color-surface-hover);
      transform: translateX(5px);
    }
    
    .option-button.selected {
      border-color: var(--color-primary);
      background: rgba(184, 134, 11, 0.25);
    }
    
    .option-button.correct {
      border-color: var(--color-success);
      background: var(--color-success-bg);
    }
    
    .option-button.incorrect {
      border-color: var(--color-error);
      background: var(--color-error-bg);
    }
    
    .option-button:disabled {
      cursor: default;
    }
    
    .option-letter {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: rgba(184, 134, 11, 0.2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.85rem;
      flex-shrink: 0;
      transition: all var(--transition-base);
      font-family: var(--font-mono);
      color: var(--color-primary-light);
    }
    
    .option-button.selected .option-letter {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
      border-color: var(--color-primary);
      color: var(--color-text-inverse);
    }
    
    .option-button.correct .option-letter {
      background: var(--color-success);
      border-color: var(--color-success);
      color: var(--color-text-inverse);
    }
    
    .option-button.incorrect .option-letter {
      background: var(--color-error);
      border-color: var(--color-error);
      color: var(--color-text-inverse);
    }
    
    .option-text {
      flex: 1;
      position: relative;
      z-index: 1;
    }
    
    /* True/False specific */
    .tf-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
    }
    
    .tf-button {
      justify-content: center;
      padding: var(--space-lg);
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .tf-button .option-letter {
      width: 44px;
      height: 44px;
      font-size: 1.25rem;
    }
    
    /* =====================================================
       FREE TEXT INPUT
       ===================================================== */
    
    .free-text-container {
      position: relative;
    }
    
    .free-text-input {
      width: 100%;
      min-height: 180px;
      padding: var(--space-lg);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      font-family: var(--font-body);
      font-size: 1rem;
      line-height: 1.7;
      color: var(--color-text);
      background: rgba(30, 30, 50, 0.8);
      resize: vertical;
      transition: all var(--transition-base);
    }
    
    .free-text-input:focus {
      outline: none;
      border-color: var(--color-primary);
      background: rgba(40, 40, 60, 0.9);
      box-shadow: 0 0 15px var(--color-primary-glow);
    }
    
    .free-text-input:disabled {
      background: rgba(20, 20, 40, 0.8);
      color: var(--color-text-muted);
      cursor: not-allowed;
    }
    
    .free-text-input::placeholder {
      color: var(--color-text-muted);
    }
    
    .input-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--space-sm);
    }
    
    .char-count {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      font-family: var(--font-mono);
    }
    
    .paste-warning {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--color-warning-bg);
      border: 1px solid var(--color-warning-light);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      color: var(--color-warning);
      animation: shake 0.5s ease;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    /* =====================================================
       FEEDBACK BOXES
       ===================================================== */
    
    .feedback-box {
      margin-top: var(--space-xl);
      padding: var(--space-lg);
      border-radius: var(--radius-md);
      animation: feedbackSlide 0.4s ease;
      position: relative;
      overflow: hidden;
    }
    
    @keyframes feedbackSlide {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .feedback-correct {
      background: var(--color-success-bg);
      border: 1px solid var(--color-success);
      border-left: 3px solid var(--color-success);
    }
    
    .feedback-correct::before {
      display: none;
    }
    
    .feedback-incorrect {
      background: var(--color-error-bg);
      border: 1px solid var(--color-error);
      border-left: 3px solid var(--color-error);
    }
    
    .feedback-incorrect::before {
      display: none;
    }
    
    .feedback-partial {
      background: var(--color-warning-bg);
      border: 1px solid var(--color-warning);
      border-left: 3px solid var(--color-warning);
    }
    
    .feedback-partial::before {
      display: none;
    }
    
    .feedback-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }
    
    .feedback-icon {
      font-size: 1.5rem;
    }
    
    .feedback-title {
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--color-text);
    }
    
    .feedback-score {
      margin-left: auto;
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 1rem;
      padding: var(--space-xs) var(--space-sm);
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--radius-sm);
    }
    
    .feedback-explanation {
      color: var(--color-text-secondary);
      line-height: 1.6;
    }
    
    .correct-answer-reveal {
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--color-primary);
      border: 1px solid var(--color-border);
    }
    
    .correct-answer-label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-xs);
    }
    
    .correct-answer-text {
      color: var(--color-text);
      font-weight: 500;
    }
    
    /* Feedback Details */
    .ai-feedback {
      margin-top: var(--space-lg);
      padding-top: var(--space-lg);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .ai-feedback-section {
      margin-bottom: var(--space-md);
    }
    
    .ai-feedback-section:last-child {
      margin-bottom: 0;
    }
    
    .ai-feedback-label {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-xs);
    }
    
    .ai-feedback-label.good {
      color: var(--color-success);
    }
    
    .ai-feedback-label.improve {
      color: var(--color-error);
    }
    
    .ai-feedback-label.tip {
      color: var(--color-info);
    }
    
    .ai-feedback-list {
      list-style: none;
      padding-left: var(--space-md);
    }
    
    .ai-feedback-list li {
      position: relative;
      padding-left: var(--space-md);
      margin-bottom: var(--space-xs);
      font-size: 0.95rem;
      color: var(--color-text-secondary);
    }
    
    .ai-feedback-list li::before {
      content: '\2022';
      position: absolute;
      left: 0;
      color: var(--color-text-muted);
    }
    
    .ai-feedback-tip {
      font-style: italic;
      color: var(--color-text-secondary);
      padding-left: var(--space-md);
      border-left: 2px solid var(--color-info);
    }
    
    /* =====================================================
       SUPPLEMENTARY QUESTION
       ===================================================== */
    
    .supplementary-box {
      margin-top: var(--space-xl);
      padding: var(--space-xl);
      background: linear-gradient(145deg, rgba(30, 40, 60, 0.95), rgba(20, 30, 50, 0.98));
      border: 2px solid var(--color-info);
      border-radius: var(--radius-lg);
      animation: supplementarySlide 0.5s ease;
      position: relative;
    }
    
    @keyframes supplementarySlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .supplementary-box::before {
      content: '';
      position: absolute;
      top: -2px;
      left: var(--space-xl);
      right: var(--space-xl);
      height: 4px;
      background: linear-gradient(90deg, var(--color-info), #60a5fa, var(--color-info));
      border-radius: var(--radius-full);
    }
    
    .supplementary-box.complete {
      opacity: 0.9;
    }
    
    .supplementary-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }
    
    .supplementary-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      background: linear-gradient(135deg, var(--color-info), #2563eb);
      color: white;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .supplementary-title {
      font-weight: 600;
      color: var(--color-info);
      font-size: 0.9rem;
    }
    
    .supplementary-question {
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: var(--space-lg);
      line-height: 1.5;
    }
    
    .saved-answer-display {
      padding: var(--space-md);
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-md);
      border: 1px solid var(--color-border);
    }
    
    .saved-answer-label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-xs);
    }
    
    .saved-answer-text {
      color: var(--color-text);
      font-weight: 500;
    }
    
    .proceed-status {
      margin-top: var(--space-lg);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
    }
    
    .proceed-waiting {
      background: var(--color-warning-bg);
      color: var(--color-warning);
      border: 1px solid var(--color-warning-light);
    }
    
    .proceed-ready {
      background: var(--color-success-bg);
      color: var(--color-success);
      border: 1px solid var(--color-success-light);
    }
    
    /* =====================================================
       RETRY BANNER
       ===================================================== */
    
    .retry-banner {
      margin-top: var(--space-xl);
      padding: var(--space-xl);
      background: linear-gradient(145deg, rgba(40, 20, 20, 0.95), rgba(30, 15, 15, 0.98));
      border: 2px solid var(--color-error);
      border-radius: var(--radius-lg);
      text-align: center;
      animation: retryPulse 2s ease infinite;
    }
    
    @keyframes retryPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    }
    
    .retry-banner h3 {
      color: var(--color-error);
      margin-bottom: var(--space-sm);
      font-size: 1.25rem;
    }
    
    .retry-banner p {
      color: var(--color-text-secondary);
    }
    
    /* =====================================================
       ORDERING QUESTION
       ===================================================== */
    
    .ordering-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    
    .ordering-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      background: rgba(30, 30, 50, 0.8);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: grab;
      transition: all var(--transition-base);
      user-select: none;
    }
    
    .ordering-item:hover:not(.disabled) {
      border-color: var(--color-primary);
      background: var(--color-surface-hover);
    }
    
    .ordering-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .ordering-item.drag-over {
      border-color: var(--color-primary);
      background: var(--color-surface-hover);
      transform: scale(1.02);
    }
    
    .ordering-item.disabled {
      cursor: default;
    }
    
    .ordering-item.correct-position {
      border-color: var(--color-success);
      background: var(--color-success-bg);
    }
    
    .ordering-item.incorrect-position {
      border-color: var(--color-error);
      background: var(--color-error-bg);
    }
    
    .ordering-handle {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: var(--space-xs);
      color: var(--color-text-muted);
    }
    
    .ordering-handle span {
      display: block;
      width: 18px;
      height: 2px;
      background: currentColor;
      border-radius: 1px;
    }
    
    .ordering-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-full);
      font-weight: 700;
      font-size: 0.9rem;
      font-family: var(--font-mono);
      flex-shrink: 0;
    }
    
    .ordering-item.correct-position .ordering-number {
      background: var(--color-success);
      border-color: var(--color-success);
      color: white;
    }
    
    .ordering-item.incorrect-position .ordering-number {
      background: var(--color-error);
      border-color: var(--color-error);
      color: white;
    }
    
    .ordering-text {
      flex: 1;
    }
    
    .ordering-arrows {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .ordering-arrow-btn {
      padding: 4px 8px;
      background: var(--color-bg-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.75rem;
      line-height: 1;
      transition: all var(--transition-fast);
    }
    
    .ordering-arrow-btn:hover:not(:disabled) {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .ordering-arrow-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    /* =====================================================
       MATCHING QUESTION
       ===================================================== */
    
    .matching-container {
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }
    
    .matching-columns {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: var(--space-lg);
      align-items: start;
    }
    
    @media (max-width: 640px) {
      .matching-columns {
        grid-template-columns: 1fr;
        gap: var(--space-md);
      }
      
      .matching-lines {
        display: none;
      }
    }
    
    .matching-column {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    
    .matching-column-header {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--color-border-light);
      margin-bottom: var(--space-xs);
    }
    
    .matching-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      background: var(--color-bg);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .matching-item:hover:not(.disabled):not(.matched) {
      border-color: var(--color-primary-light);
      background: var(--color-surface);
    }
    
    .matching-item.selected {
      border-color: var(--color-primary);
      background: var(--color-info-bg);
      box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
    }
    
    .matching-item.matched {
      border-color: var(--color-secondary);
      background: var(--color-info-bg);
    }
    
    .matching-item.correct {
      border-color: var(--color-success);
      background: var(--color-success-bg);
    }
    
    .matching-item.incorrect {
      border-color: var(--color-error);
      background: var(--color-error-bg);
    }
    
    .matching-item.disabled {
      cursor: default;
    }
    
    .matching-letter {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-full);
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    
    .matching-item.selected .matching-letter,
    .matching-item.matched .matching-letter {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }
    
    .matching-item.correct .matching-letter {
      background: var(--color-success);
      border-color: var(--color-success);
    }
    
    .matching-item.incorrect .matching-letter {
      background: var(--color-error);
      border-color: var(--color-error);
    }
    
    .matching-pair-indicator {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      padding: 2px 6px;
      background: var(--color-accent);
      color: var(--color-primary-dark);
      border-radius: var(--radius-sm);
      margin-left: auto;
    }
    
    .matching-lines {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      font-size: 1.5rem;
    }
    
    .matching-instructions {
      font-size: 0.9rem;
      color: var(--color-text-muted);
      text-align: center;
      padding: var(--space-sm);
      background: var(--color-bg-alt);
      border-radius: var(--radius-sm);
    }
    
    /* =====================================================
       FILL IN THE BLANKS
       ===================================================== */
    
    .fill-blanks-container {
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }
    
    .fill-blanks-passage {
      font-size: 1.1rem;
      line-height: 2.2;
      padding: var(--space-lg);
      background: var(--color-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border-light);
    }
    
    .blank-input {
      display: inline-block;
      min-width: 120px;
      padding: var(--space-xs) var(--space-sm);
      margin: 0 var(--space-xs);
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      font-family: var(--font-body);
      font-size: 1rem;
      text-align: center;
      vertical-align: middle;
      transition: all var(--transition-fast);
    }
    
    .blank-input:focus {
      outline: none;
      border-color: var(--color-primary);
      border-style: solid;
      box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
    }
    
    .blank-input.correct {
      border-color: var(--color-success);
      border-style: solid;
      background: var(--color-success-bg);
      color: var(--color-success);
    }
    
    .blank-input.incorrect {
      border-color: var(--color-error);
      border-style: solid;
      background: var(--color-error-bg);
      color: var(--color-error);
    }
    
    .blank-input:disabled {
      cursor: default;
    }
    
    .word-bank {
      padding: var(--space-lg);
      background: var(--color-bg-alt);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border-light);
    }
    
    .word-bank-header {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-md);
    }
    
    .word-bank-words {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }
    
    .word-bank-word {
      padding: var(--space-sm) var(--space-md);
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-full);
      font-size: 0.95rem;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .word-bank-word:hover:not(.used):not(.disabled) {
      border-color: var(--color-primary);
      background: var(--color-info-bg);
    }
    
    .word-bank-word.used {
      opacity: 0.4;
      text-decoration: line-through;
      cursor: default;
    }
    
    .word-bank-word.selected {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }
    
    .word-bank-word.disabled {
      cursor: default;
    }
    
    /* =====================================================
       CATEGORISATION QUESTION
       ===================================================== */
    
    .categorise-container {
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }
    
    .categorise-items-pool {
      padding: var(--space-lg);
      background: var(--color-bg-alt);
      border-radius: var(--radius-md);
      border: 2px dashed var(--color-border);
      min-height: 60px;
    }
    
    .categorise-items-pool.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      font-style: italic;
    }
    
    .categorise-pool-header {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-md);
    }
    
    .categorise-pool-items {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }
    
    .categorise-item {
      padding: var(--space-sm) var(--space-md);
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: grab;
      transition: all var(--transition-fast);
      user-select: none;
    }
    
    .categorise-item:hover:not(.disabled) {
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .categorise-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .categorise-item.correct {
      border-color: var(--color-success);
      background: var(--color-success-bg);
    }
    
    .categorise-item.incorrect {
      border-color: var(--color-error);
      background: var(--color-error-bg);
    }
    
    .categorise-item.disabled {
      cursor: default;
    }
    
    .categorise-categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md);
    }
    
    .categorise-category {
      padding: var(--space-md);
      background: var(--color-bg);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      min-height: 120px;
      transition: all var(--transition-fast);
    }
    
    .categorise-category.drag-over {
      border-color: var(--color-primary);
      background: var(--color-info-bg);
    }
    
    .categorise-category-header {
      font-weight: 600;
      color: var(--color-text);
      padding-bottom: var(--space-sm);
      margin-bottom: var(--space-sm);
      border-bottom: 2px solid var(--color-border-light);
    }
    
    .categorise-category-items {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-xs);
      min-height: 40px;
    }
    
    .categorise-category-empty {
      color: var(--color-text-muted);
      font-size: 0.85rem;
      font-style: italic;
      padding: var(--space-sm);
    }
    
    /* =====================================================
       MULTIPLE RESPONSE QUESTION
       ===================================================== */
    
    .multiple-response-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    
    .multiple-response-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      background: var(--color-bg);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .multiple-response-item:hover:not(.disabled) {
      border-color: var(--color-primary-light);
      background: var(--color-surface);
    }
    
    .multiple-response-item.selected {
      border-color: var(--color-primary);
      background: var(--color-info-bg);
    }
    
    .multiple-response-item.correct {
      border-color: var(--color-success);
      background: var(--color-success-bg);
    }
    
    .multiple-response-item.incorrect {
      border-color: var(--color-error);
      background: var(--color-error-bg);
    }
    
    .multiple-response-item.missed {
      border-color: var(--color-warning);
      background: var(--color-warning-bg);
    }
    
    .multiple-response-item.disabled {
      cursor: default;
    }
    
    .multiple-response-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      flex-shrink: 0;
      transition: all var(--transition-fast);
    }
    
    .multiple-response-item.selected .multiple-response-checkbox {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }
    
    .multiple-response-item.correct .multiple-response-checkbox {
      background: var(--color-success);
      border-color: var(--color-success);
      color: white;
    }
    
    .multiple-response-item.incorrect .multiple-response-checkbox {
      background: var(--color-error);
      border-color: var(--color-error);
      color: white;
    }
    
    .multiple-response-item.missed .multiple-response-checkbox {
      background: var(--color-warning);
      border-color: var(--color-warning);
      color: white;
    }
    
    .multiple-response-hint {
      font-size: 0.85rem;
      color: var(--color-text-muted);
      font-style: italic;
      margin-top: var(--space-sm);
    }
    
    /* =====================================================
       CLOZE DROPDOWN QUESTION
       ===================================================== */
    
    .cloze-passage {
      font-size: 1.1rem;
      line-height: 2.4;
      padding: var(--space-lg);
      background: var(--color-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border-light);
    }
    
    .cloze-dropdown {
      display: inline-block;
      padding: var(--space-xs) var(--space-md);
      padding-right: var(--space-xl);
      margin: 0 var(--space-xs);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      font-family: var(--font-body);
      font-size: 1rem;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235c5347' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      min-width: 140px;
      transition: all var(--transition-fast);
    }
    
    .cloze-dropdown:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
    }
    
    .cloze-dropdown.correct {
      border-color: var(--color-success);
      background-color: var(--color-success-bg);
      color: var(--color-success);
    }
    
    .cloze-dropdown.incorrect {
      border-color: var(--color-error);
      background-color: var(--color-error-bg);
      color: var(--color-error);
    }
    
    .cloze-dropdown:disabled {
      cursor: default;
      opacity: 0.9;
    }

    /* =====================================================
       BUTTONS
       ===================================================== */
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-xl);
      font-family: var(--font-display);
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .btn::before {
      display: none;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #b8860b 0%, #daa520 50%, #b8860b 100%);
      color: var(--color-text-inverse);
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-gold-strong);
    }
    
    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background: rgba(30, 30, 50, 0.8);
      color: var(--color-text);
      border: 2px solid var(--color-border);
    }
    
    .btn-secondary:hover:not(:disabled) {
      border-color: var(--color-primary);
      background: var(--color-surface-hover);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--color-success), #34d399);
      color: white;
      box-shadow: var(--shadow-md);
    }
    
    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-large {
      padding: var(--space-lg) var(--space-2xl);
      font-size: 1.1rem;
    }
    
    .btn-icon {
      padding: var(--space-sm);
      border-radius: var(--radius-md);
    }
    
    /* =====================================================
       NAVIGATION
       ===================================================== */
    
    .question-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--space-xl);
      padding-top: var(--space-xl);
      border-top: 1px solid var(--color-border-light);
    }
    
    /* =====================================================
       LOGIN SCREEN
       ===================================================== */
    
    .login-container {
      max-width: 440px;
      margin: var(--space-3xl) auto;
    }
    
    .login-card {
      text-align: center;
      padding: var(--space-2xl);
    }
    
    .login-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto var(--space-lg);
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      box-shadow: var(--shadow-lg);
    }
    
    .login-card h2 {
      font-size: 1.75rem;
      margin-bottom: var(--space-xs);
      color: var(--color-primary);
    }
    
    .login-card .login-subtitle {
      color: var(--color-text-muted);
      margin-bottom: var(--space-xl);
    }
    
    .login-form {
      text-align: left;
    }
    
    .form-group {
      margin-bottom: var(--space-lg);
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: var(--space-sm);
      color: var(--color-text);
    }
    
    .form-input {
      width: 100%;
      padding: var(--space-md) var(--space-lg);
      font-family: var(--font-body);
      font-size: 1rem;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-bg);
      color: var(--color-text);
      transition: all var(--transition-fast);
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      background: var(--color-surface);
      box-shadow: 0 0 0 4px rgba(30, 58, 95, 0.1);
    }
    
    .form-input::placeholder {
      color: var(--color-text-muted);
    }
    
    .error-message {
      padding: var(--space-md);
      background: var(--color-error-bg);
      border: 1px solid var(--color-error-light);
      border-radius: var(--radius-md);
      color: var(--color-error);
      font-size: 0.9rem;
      margin-bottom: var(--space-lg);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .login-divider {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin: var(--space-lg) 0;
      color: var(--color-text-muted);
      font-size: 0.85rem;
    }
    
    .login-divider::before,
    .login-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--color-border);
    }
    
    /* =====================================================
       REVIEW SCREEN
       ===================================================== */
    
    .review-header {
      margin-bottom: var(--space-xl);
    }
    
    .review-header h2 {
      margin-bottom: var(--space-sm);
    }
    
    .review-list {
      margin-bottom: var(--space-xl);
    }
    
    .review-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      background: var(--color-bg);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      transition: all var(--transition-fast);
      cursor: pointer;
    }
    
    .review-item:hover {
      background: var(--color-bg-alt);
      transform: translateX(4px);
    }
    
    .review-status {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      flex-shrink: 0;
    }
    
    .review-status.correct {
      background: var(--color-success-bg);
    }
    
    .review-status.incorrect {
      background: var(--color-error-bg);
    }
    
    .review-status.partial {
      background: var(--color-warning-bg);
    }
    
    .review-content {
      flex: 1;
      min-width: 0;
    }
    
    .review-question {
      font-weight: 500;
      color: var(--color-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: var(--space-xs);
    }
    
    .review-score {
      font-size: 0.85rem;
      font-family: var(--font-mono);
      color: var(--color-text-muted);
    }
    
    .review-actions {
      display: flex;
      gap: var(--space-md);
      margin-top: var(--space-lg);
    }
    
    .review-actions .btn {
      flex: 1;
    }
    
    /* =====================================================
       SUBMISSION FORM
       ===================================================== */
    
    .submission-container {
      max-width: 560px;
      margin: 0 auto;
    }
    
    .score-display {
      text-align: center;
      padding: var(--space-2xl);
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      border-radius: var(--radius-xl);
      color: var(--color-text-inverse);
      margin-bottom: var(--space-xl);
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
    }
    
    .score-display::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -30%;
      width: 80%;
      height: 200%;
      background: radial-gradient(ellipse, rgba(255,255,255,0.1) 0%, transparent 70%);
    }
    
    .score-display.pass {
      background: linear-gradient(135deg, var(--color-success), #059669);
    }
    
    .score-display.fail {
      background: linear-gradient(135deg, var(--color-error), #b91c1c);
    }
    
    .score-value {
      font-family: var(--font-display);
      font-size: 5rem;
      font-weight: 700;
      line-height: 1;
      margin-bottom: var(--space-sm);
      position: relative;
    }
    
    .score-label {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .score-status {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      margin-top: var(--space-md);
      padding: var(--space-sm) var(--space-md);
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-full);
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
      padding: var(--space-lg);
      background: var(--color-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border-light);
      margin-bottom: var(--space-lg);
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 22px;
      height: 22px;
      margin-top: 2px;
      flex-shrink: 0;
      accent-color: var(--color-primary);
    }
    
    .checkbox-group label {
      color: var(--color-text-secondary);
      line-height: 1.5;
      cursor: pointer;
    }
    
    .form-buttons {
      display: flex;
      gap: var(--space-md);
    }
    
    .form-buttons .btn {
      flex: 1;
    }
    
    /* =====================================================
       SUCCESS SCREEN
       ===================================================== */
    
    .success-container {
      text-align: center;
      padding: var(--space-3xl) var(--space-xl);
    }
    
    .success-icon {
      font-size: 5rem;
      margin-bottom: var(--space-lg);
      animation: successBounce 0.6s ease;
    }
    
    @keyframes successBounce {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .success-container h2 {
      font-size: 1.75rem;
      color: var(--color-success);
      margin-bottom: var(--space-md);
    }
    
    .success-container p {
      font-size: 1rem;
      margin-bottom: var(--space-sm);
      color: var(--color-text-secondary);
    }
    
    .success-score {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      margin-top: var(--space-lg);
      padding: var(--space-md) var(--space-xl);
      background: var(--color-success-bg);
      border: 1px solid var(--color-success);
      border-radius: var(--radius-md);
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--color-success);
    }
    
    .success-details {
      margin-top: var(--space-xl);
      padding: var(--space-lg);
      background: var(--color-bg-alt);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      font-size: 0.9rem;
      color: var(--color-text-muted);
    }
    
    /* =====================================================
       TEACHER DASHBOARD
       ===================================================== */
    
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
      gap: var(--space-md);
    }
    
    .dashboard-title {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    .dashboard-title h1 {
      font-size: 1.75rem;
      color: var(--color-primary);
    }
    
    .dashboard-actions {
      display: flex;
      gap: var(--space-sm);
    }
    
    .dashboard-meta {
      color: var(--color-text-muted);
      font-size: 0.9rem;
      margin-bottom: var(--space-xl);
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xl);
      margin-bottom: var(--space-xl);
    }
    
    @media (max-width: 900px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .dashboard-section h3 {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: 1rem;
      margin-bottom: var(--space-lg);
    }
    
    .count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      padding: 0 var(--space-sm);
      background: var(--color-primary);
      color: var(--color-text-inverse);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 700;
      font-family: var(--font-mono);
    }
    
    .submission-list {
      max-height: 450px;
      overflow-y: auto;
      padding-right: var(--space-sm);
    }
    
    .submission-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .submission-list::-webkit-scrollbar-track {
      background: var(--color-bg);
      border-radius: var(--radius-full);
    }
    
    .submission-list::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: var(--radius-full);
    }
    
    .submission-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      background: var(--color-bg);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 2px solid transparent;
    }
    
    .submission-item:hover {
      background: var(--color-bg-alt);
      transform: translateX(4px);
    }
    
    .submission-item.selected {
      background: var(--color-info-bg);
      border-color: var(--color-primary);
    }
    
    .submission-checkbox {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      accent-color: var(--color-primary);
    }
    
    .submission-info {
      flex: 1;
      min-width: 0;
    }
    
    .submission-name {
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 2px;
    }
    
    .submission-meta {
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }
    
    .submission-score {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 1rem;
    }
    
    .submission-score.pass {
      color: var(--color-success);
    }
    
    .submission-score.fail {
      color: var(--color-error);
    }
    
    .empty-state {
      text-align: center;
      padding: var(--space-2xl);
      color: var(--color-text-muted);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: var(--space-md);
      opacity: 0.5;
    }
    
    /* In Progress Items */
    .progress-item {
      padding: var(--space-md) var(--space-lg);
      background: var(--color-warning-bg);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      border-left: 4px solid var(--color-warning);
    }
    
    .progress-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
    }
    
    .progress-item-name {
      font-weight: 600;
      color: var(--color-text);
    }
    
    .progress-item-percent {
      font-family: var(--font-mono);
      font-weight: 700;
      color: var(--color-warning);
    }
    
    .progress-item-time {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      margin-bottom: var(--space-sm);
    }
    
    .progress-item-bar {
      height: 6px;
      background: rgba(0,0,0,0.1);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    
    .progress-item-fill {
      height: 100%;
      background: var(--color-warning);
      border-radius: var(--radius-full);
      transition: width var(--transition-base);
    }
    
    /* Feedback Overview Button */
    .ai-overview-btn {
      width: 100%;
      margin-top: var(--space-lg);
      background: linear-gradient(135deg, #0284c7, #0369a1);
    }
    
    .ai-overview-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
    }
    
    /* Feedback Overview Panel */
    .ai-overview-panel {
      background: linear-gradient(145deg, rgba(30, 40, 60, 0.95), rgba(20, 30, 50, 0.98));
      border: 2px solid var(--color-info);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      margin-top: var(--space-xl);
      position: relative;
    }
    
    .ai-overview-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: var(--space-xl);
      right: var(--space-xl);
      height: 4px;
      background: linear-gradient(90deg, var(--color-info), #60a5fa, var(--color-info));
      border-radius: var(--radius-full);
    }
    
    .ai-overview-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }
    
    .ai-overview-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--color-info), #2563eb);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    
    .ai-overview-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--color-info);
    }
    
    .ai-overview-subtitle {
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    
    .ai-overview-summary {
      padding: var(--space-lg);
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-xl);
      line-height: 1.7;
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
    }
    
    .ai-overview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-lg);
      margin-bottom: var(--space-lg);
    }
    
    @media (max-width: 700px) {
      .ai-overview-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .ai-overview-section {
      margin-bottom: var(--space-lg);
    }
    
    .ai-overview-section:last-child {
      margin-bottom: 0;
    }
    
    .ai-overview-section h4 {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: 0.9rem;
      color: var(--color-text);
      margin-bottom: var(--space-md);
      font-weight: 600;
    }
    
    .ai-overview-section ul {
      list-style: none;
    }
    
    .ai-overview-section li {
      padding: var(--space-sm) var(--space-md);
      background: rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-xs);
      font-size: 0.95rem;
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border-light);
    }
    
    .ai-overview-quote {
      padding: var(--space-md);
      background: rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-sm);
      font-style: italic;
      color: var(--color-text-secondary);
      border-left: 3px solid var(--color-info);
      border: 1px solid var(--color-border);
    }
    
    /* Detail Panel */
    .detail-panel {
      margin-top: var(--space-xl);
    }
    
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: var(--space-lg);
      border-bottom: 1px solid var(--color-border-light);
      margin-bottom: var(--space-lg);
    }
    
    .detail-title {
      font-family: var(--font-display);
      font-size: 1.5rem;
      margin-bottom: var(--space-xs);
    }
    
    .detail-meta {
      font-size: 0.9rem;
      color: var(--color-text-muted);
    }
    
    .detail-score {
      font-family: var(--font-display);
      font-size: 2.5rem;
      font-weight: 700;
    }
    
    .detail-score.pass {
      color: var(--color-success);
    }
    
    .detail-score.fail {
      color: var(--color-error);
    }
    
    .student-comments {
      padding: var(--space-lg);
      background: var(--color-bg);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-lg);
      border-left: 3px solid var(--color-accent);
    }
    
    .student-comments-label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-sm);
    }
    
    .answer-detail {
      padding: var(--space-lg);
      background: var(--color-bg);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-md);
    }
    
    .answer-question-text {
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-md);
    }
    
    .answer-response {
      padding: var(--space-md);
      background: var(--color-surface);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-md);
      border: 1px solid var(--color-border-light);
    }
    
    .answer-response-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-xs);
    }
    
    .answer-ai-feedback {
      padding: var(--space-md);
      background: var(--color-info-bg);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
    }
    
    .answer-ai-score {
      font-family: var(--font-mono);
      font-weight: 700;
      margin-bottom: var(--space-sm);
    }
    
    /* =====================================================
       LOADING STATES
       ===================================================== */
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-3xl);
      gap: var(--space-lg);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .spinner-small {
      width: 20px;
      height: 20px;
      border-width: 2px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .loading-text {
      color: var(--color-text-muted);
      font-size: 0.95rem;
    }
    
    .grading-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      background: var(--color-info-bg);
      border-radius: var(--radius-md);
      margin-top: var(--space-lg);
      border: 1px solid var(--color-info-light);
    }
    
    .grading-indicator .spinner {
      width: 24px;
      height: 24px;
      border-width: 2px;
      border-top-color: var(--color-info);
    }
    
    .grading-text {
      color: var(--color-info);
      font-weight: 500;
    }
    
    /* =====================================================
       INSTRUCTIONS BOX
       ===================================================== */
    
    .instructions-box {
      background: var(--color-info-bg);
      border: 1px solid var(--color-info-light);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
      display: flex;
      gap: var(--space-md);
    }
    
    .instructions-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }
    
    .instructions-text {
      color: var(--color-text-secondary);
      line-height: 1.6;
    }
    
    /* =====================================================
       RESPONSIVE
       ===================================================== */
    
    @media (max-width: 640px) {
      .app-container {
        padding: var(--space-md);
      }
      
      .app-header {
        padding: var(--space-lg);
      }
      
      .app-header h1 {
        font-size: 1.5rem;
      }
      
      .card {
        padding: var(--space-lg);
      }
      
      .question-text {
        font-size: 1.1rem;
      }
      
      .tf-options {
        grid-template-columns: 1fr;
      }
      
      .form-buttons {
        flex-direction: column;
      }
      
      .dashboard-actions {
        width: 100%;
        justify-content: stretch;
      }
      
      .dashboard-actions .btn {
        flex: 1;
      }
      
      .question-nav {
        flex-direction: column;
        gap: var(--space-md);
      }
      
      .question-nav .btn {
        width: 100%;
      }
    }

    /* =====================================================
       ESSAY-SPECIFIC STYLES
       ===================================================== */
    
    .essay-title {
      font-size: 1.1rem;
      font-style: italic;
      color: var(--color-primary-light);
      margin-top: var(--space-sm);
      line-height: 1.5;
    }
    
    .learning-material {
      background: linear-gradient(145deg, rgba(25, 35, 55, 0.95), rgba(20, 30, 50, 0.98));
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      margin-bottom: var(--space-xl);
    }
    
    .learning-material h2,
    .learning-material h3,
    .learning-material h4 {
      color: var(--color-primary-light);
      margin-top: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    
    .learning-material h2:first-child,
    .learning-material h3:first-child {
      margin-top: 0;
    }
    
    .learning-material ul,
    .learning-material ol {
      margin-left: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    
    .learning-material li {
      margin-bottom: var(--space-sm);
      color: var(--color-text-secondary);
    }
    
    .learning-material strong {
      color: var(--color-accent);
    }
    
    .learning-material code {
      background: rgba(184, 134, 11, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      color: var(--color-accent);
    }
    
    .learning-material blockquote {
      border-left: 3px solid var(--color-primary);
      padding-left: var(--space-md);
      margin: var(--space-md) 0;
      font-style: italic;
      color: var(--color-text-muted);
    }
    
    /* Expandable hint styles */
    .expandable-hint {
      cursor: pointer;
      transition: all 0.2s ease;
      padding: var(--space-xs) var(--space-sm);
      margin: var(--space-xs) 0;
      border-radius: var(--radius-sm);
      border-left: 2px solid transparent;
    }
    
    .expandable-hint:hover {
      background: rgba(184, 134, 11, 0.1);
      border-left-color: var(--color-gold);
    }
    
    .expandable-hint::after {
      content: ' ';
      font-size: 0.8em;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .expandable-hint:hover::after {
      opacity: 1;
    }
    
    .expandable-hint.expanded {
      background: rgba(184, 134, 11, 0.15);
      border-left-color: var(--color-gold);
    }
    
    .expandable-hint.loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .hint-expansion {
      background: linear-gradient(145deg, rgba(25, 35, 55, 0.98), rgba(30, 40, 60, 0.95));
      border: 1px solid var(--color-gold);
      border-radius: var(--radius-md);
      padding: var(--space-md) var(--space-lg);
      margin: var(--space-sm) 0 var(--space-md) var(--space-lg);
      animation: expandIn 0.3s ease;
      position: relative;
    }
    
    .hint-expansion::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 20px;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid var(--color-gold);
    }
    
    @keyframes expandIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .hint-expansion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--color-border);
    }
    
    .hint-expansion-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-gold);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .hint-expansion-close {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
      line-height: 1;
    }
    
    .hint-expansion-close:hover {
      color: var(--color-text);
    }
    
    .hint-expansion-content {
      font-size: 0.95rem;
      line-height: 1.7;
      color: var(--color-text-secondary);
    }
    
    .hint-expansion-content p {
      margin-bottom: var(--space-sm);
    }
    
    .hint-expansion-content p:last-child {
      margin-bottom: 0;
    }
    
    .hint-loading {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      color: var(--color-text-muted);
      font-size: 0.9rem;
      padding: var(--space-sm) 0;
    }
    
    /* Text-to-Speech styles */
    .tts-button {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      background: var(--color-surface-hover);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: var(--space-xs) var(--space-sm);
      font-size: 0.8rem;
      color: var(--color-text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .tts-button:hover {
      background: var(--color-surface-alt);
      color: var(--color-text);
      border-color: var(--color-primary);
    }
    
    .tts-button.playing {
      background: var(--color-primary);
      color: var(--color-text-inverse);
      border-color: var(--color-primary);
    }
    
    .tts-button.playing:hover {
      background: var(--color-primary-light);
    }
    
    .tts-controls {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
    }
    
    .tts-speed {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: 0.75rem;
      color: var(--color-text-muted);
    }
    
    .tts-speed select {
      background: var(--color-surface-hover);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: 2px 4px;
      font-size: 0.75rem;
      color: var(--color-text);
      cursor: pointer;
    }
    
    .tts-icon {
      font-size: 1rem;
    }
    
    @keyframes pulse-speaking {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .tts-button.playing .tts-icon {
      animation: pulse-speaking 1s ease-in-out infinite;
    }
    
    .hint-loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    .writing-prompt {
      background: var(--color-surface-hover);
      border: 2px solid var(--color-primary);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
    }
    
    .writing-prompt-label {
      font-family: var(--font-display);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-primary-light);
      margin-bottom: var(--space-sm);
    }
    
    .writing-prompt-text {
      font-size: 1.1rem;
      color: var(--color-text);
      line-height: 1.6;
    }
    
    .attempt-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-md);
    }
    
    .attempt-badge {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
      color: var(--color-text-inverse);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .attempts-remaining {
      color: var(--color-text-muted);
      font-size: 0.9rem;
    }
    
    .paragraph-editor {
      width: 100%;
      min-height: 250px;
      padding: var(--space-lg);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      font-family: var(--font-body);
      font-size: 1.05rem;
      line-height: 1.8;
      color: var(--color-text);
      background: rgba(30, 30, 50, 0.8);
      resize: vertical;
      transition: all var(--transition-base);
    }
    
    .paragraph-editor:focus {
      outline: none;
      border-color: var(--color-primary);
      background: rgba(40, 40, 60, 0.9);
      box-shadow: 0 0 15px var(--color-primary-glow);
    }
    
    .paragraph-editor:disabled {
      background: rgba(20, 20, 40, 0.6);
      color: var(--color-text-muted);
      cursor: not-allowed;
    }
    
    .word-count {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-sm);
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    
    .word-count.warning {
      color: var(--color-warning);
    }
    
    .word-count.success {
      color: var(--color-success);
    }
    
    .feedback-panel {
      background: linear-gradient(145deg, rgba(30, 40, 60, 0.95), rgba(20, 30, 50, 0.98));
      border: 2px solid var(--color-info);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      margin-top: var(--space-xl);
      animation: ghostAppear 0.5s ease-out;
    }
    
    .feedback-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--color-border);
    }
    
    .feedback-score {
      font-size: 2rem;
      font-weight: 700;
      font-family: var(--font-display);
    }
    
    .feedback-score.excellent { color: var(--color-success); }
    .feedback-score.good { color: var(--color-info); }
    .feedback-score.satisfactory { color: var(--color-warning); }
    .feedback-score.needs-work { color: var(--color-error); }
    
    .criteria-scores {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }
    
    .criteria-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-sm);
      padding: var(--space-md);
    }
    
    .criteria-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-xs);
    }
    
    .criteria-score {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text);
    }
    
    .feedback-section {
      margin-bottom: var(--space-lg);
    }
    
    .feedback-section:last-child {
      margin-bottom: 0;
    }
    
    .feedback-section-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--color-primary-light);
      margin-bottom: var(--space-md);
    }
    
    .feedback-list {
      list-style: none;
    }
    
    .feedback-list li {
      padding: var(--space-sm) var(--space-md);
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-sm);
      border-left: 3px solid var(--color-border);
    }
    
    .feedback-list.strengths li {
      border-left-color: var(--color-success);
    }
    
    .feedback-list.improvements li {
      border-left-color: var(--color-warning);
    }
    
    .detailed-feedback {
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      line-height: 1.8;
      color: var(--color-text-secondary);
    }
    
    .example-revision {
      background: var(--color-success-bg);
      border: 1px solid var(--color-success);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-top: var(--space-md);
      font-style: italic;
    }
    
    .example-revision-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-success);
      margin-bottom: var(--space-xs);
    }
    
    .revision-actions {
      display: flex;
      gap: var(--space-md);
      margin-top: var(--space-lg);
      padding-top: var(--space-lg);
      border-top: 1px solid var(--color-border);
    }
    
    /* Essay compilation styles */
    .essay-compilation {
      background: linear-gradient(145deg, rgba(30, 30, 50, 0.95), rgba(20, 20, 40, 0.98));
      border: 3px solid var(--color-primary);
      border-radius: var(--radius-xl);
      padding: var(--space-2xl);
      margin-bottom: var(--space-xl);
    }
    
    .essay-compilation-header {
      text-align: center;
      margin-bottom: var(--space-2xl);
      padding-bottom: var(--space-xl);
      border-bottom: 2px solid var(--color-border);
    }
    
    .essay-compilation-title {
      font-size: 1.5rem;
      color: var(--color-primary-light);
      margin-bottom: var(--space-md);
    }
    
    .essay-compilation-meta {
      color: var(--color-text-muted);
      font-style: italic;
    }
    
    .compiled-essay {
      font-size: 1.1rem;
      line-height: 2;
      color: var(--color-text);
    }
    
    .compiled-paragraph {
      margin-bottom: var(--space-xl);
      text-indent: 2em;
    }
    
    .compiled-paragraph:first-child {
      text-indent: 0;
    }
    
    .holistic-feedback {
      background: linear-gradient(145deg, rgba(25, 40, 60, 0.95), rgba(20, 35, 55, 0.98));
      border: 2px solid var(--color-success);
      border-radius: var(--radius-xl);
      padding: var(--space-2xl);
    }
    
    .holistic-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-xl);
      flex-wrap: wrap;
      gap: var(--space-lg);
    }
    
    .final-grade {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    .grade-badge {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: var(--font-display);
      padding: var(--space-md) var(--space-xl);
      border-radius: var(--radius-lg);
    }
    
    .grade-badge.excellent {
      background: var(--color-success-bg);
      color: var(--color-success);
      border: 2px solid var(--color-success);
    }
    
    .grade-badge.good {
      background: var(--color-info-bg);
      color: var(--color-info);
      border: 2px solid var(--color-info);
    }
    
    .grade-badge.satisfactory {
      background: var(--color-warning-bg);
      color: var(--color-warning);
      border: 2px solid var(--color-warning);
    }
    
    .grade-badge.needs-improvement {
      background: var(--color-error-bg);
      color: var(--color-error);
      border: 2px solid var(--color-error);
    }
    
    .best-quote {
      background: var(--color-surface-hover);
      border-left: 4px solid var(--color-accent);
      padding: var(--space-lg);
      margin: var(--space-xl) 0;
      font-style: italic;
      font-size: 1.1rem;
    }
    
    .best-quote-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-accent);
      margin-bottom: var(--space-sm);
      font-style: normal;
    }
    
    .encouragement-box {
      background: var(--color-success-bg);
      border: 1px solid var(--color-success);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      text-align: center;
      margin-top: var(--space-xl);
    }
    
    .encouragement-box p {
      font-size: 1.1rem;
      color: var(--color-text);
      font-style: italic;
    }
    
    /* Print styles */
    @media print {
      body {
        background: white !important;
        color: black !important;
      }
      
      .app-container {
        max-width: 100%;
        padding: 0;
      }
      
      .card, .essay-compilation, .holistic-feedback {
        background: white !important;
        border: 1px solid #ccc !important;
        box-shadow: none !important;
        color: black !important;
      }
      
      .btn, .paragraph-tracker, .revision-actions {
        display: none !important;
      }
      
      .compiled-essay, .detailed-feedback, p, li {
        color: black !important;
      }
      
      h1, h2, h3, h4, .essay-compilation-title, .feedback-section-title {
        color: #333 !important;
      }
      
      .grade-badge {
        background: #f0f0f0 !important;
        color: #333 !important;
        border-color: #333 !important;
      }
      
      .task-panel {
        display: none !important;
      }
    }
    
    /* =====================================================
       TASK PANEL - DESKTOP SIDEBAR / MOBILE TOGGLE
       ===================================================== */
    
    .writing-layout {
      display: flex;
      gap: var(--space-xl);
      align-items: flex-start;
    }
    
    .writing-main {
      flex: 1;
      min-width: 0;
    }
    
    .task-panel {
      width: 380px;
      flex-shrink: 0;
      position: sticky;
      top: var(--space-lg);
      max-height: calc(100vh - var(--space-2xl));
      overflow-y: auto;
      background: linear-gradient(145deg, rgba(25, 35, 55, 0.95), rgba(20, 30, 50, 0.98));
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
    }
    
    .task-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--color-border);
    }
    
    .task-panel-title {
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--color-primary-light);
      margin: 0;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .task-panel-close {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      padding: var(--space-xs);
      font-size: 1.25rem;
      line-height: 1;
      display: none;
    }
    
    .task-panel-content {
      font-size: 0.95rem;
      line-height: 1.7;
      color: var(--color-text-secondary);
    }
    
    .task-panel-content h2 {
      font-size: 1.1rem;
      color: var(--color-primary-light);
      margin-top: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    
    .task-panel-content h2:first-child {
      margin-top: 0;
    }
    
    .task-panel-content h3 {
      font-size: 1rem;
      color: var(--color-text);
      margin-top: var(--space-md);
      margin-bottom: var(--space-sm);
    }
    
    .task-panel-content p {
      margin-bottom: var(--space-md);
    }
    
    .task-panel-content blockquote {
      background: rgba(184, 134, 11, 0.1);
      border-left: 3px solid var(--color-primary);
      padding: var(--space-md);
      margin: var(--space-md) 0;
      font-style: italic;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    
    .task-panel-content hr {
      border: none;
      border-top: 1px solid var(--color-border);
      margin: var(--space-lg) 0;
    }
    
    .task-panel-content ul,
    .task-panel-content ol {
      margin-left: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    
    .task-panel-content li {
      margin-bottom: var(--space-xs);
    }
    
    .task-panel-content strong {
      color: var(--color-accent);
    }
    
    .task-panel-content em {
      color: var(--color-text-muted);
    }
    
    
    /* Task Panel Sections */
    .task-section {
      margin-bottom: var(--space-xl);
      padding-bottom: var(--space-xl);
      border-bottom: 1px solid var(--color-border);
    }
    
    .task-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .task-section-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-family: var(--font-display);
      font-size: 1.1rem;
      color: var(--color-primary-light);
      margin-bottom: var(--space-md);
      font-weight: 600;
    }
    
    .task-section-title span {
      font-size: 1.3rem;
    }
    
    /* =====================================================
       SOURCE MATERIAL CARD - Prominent display at top of writing area
       ===================================================== */
    
    .source-material-card {
      background: linear-gradient(145deg, rgba(184, 134, 11, 0.08), rgba(30, 30, 50, 0.95));
      border: 2px solid var(--color-primary);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-xl);
      overflow: hidden;
      box-shadow: var(--shadow-md), inset 0 0 30px rgba(184, 134, 11, 0.05);
    }
    
    .source-material-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md) var(--space-lg);
      background: linear-gradient(135deg, rgba(184, 134, 11, 0.15), rgba(184, 134, 11, 0.08));
      border-bottom: 1px solid var(--color-border);
      cursor: pointer;
      user-select: none;
      transition: background var(--transition-fast);
    }
    
    .source-material-header:hover {
      background: linear-gradient(135deg, rgba(184, 134, 11, 0.2), rgba(184, 134, 11, 0.12));
    }
    
    .source-material-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--color-primary-light);
      margin: 0;
      font-weight: 600;
    }
    
    .source-material-title-icon {
      font-size: 1.2rem;
    }
    
    .source-material-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      color: var(--color-text-muted);
      font-size: 0.85rem;
      transition: color var(--transition-fast);
    }
    
    .source-material-header:hover .source-material-toggle {
      color: var(--color-primary-light);
    }
    
    .source-material-toggle-icon {
      font-size: 1rem;
      transition: transform var(--transition-fast);
    }
    
    .source-material-card.collapsed .source-material-toggle-icon {
      transform: rotate(-90deg);
    }
    
    .source-material-content {
      padding: var(--space-lg);
      max-height: 400px;
      overflow-y: auto;
      transition: max-height var(--transition-base), padding var(--transition-base), opacity var(--transition-base);
    }
    
    .source-material-card.collapsed .source-material-content {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      opacity: 0;
      overflow: hidden;
    }
    
    .source-material-text {
      font-family: var(--font-body);
      font-size: 1rem;
      line-height: 1.8;
      color: var(--color-text);
      white-space: pre-wrap;
    }
    
    .source-material-text p {
      margin-bottom: var(--space-md);
      text-indent: 2em;
    }
    
    .source-material-text p:first-child {
      text-indent: 0;
    }
    
    .source-material-text p:last-child {
      margin-bottom: 0;
    }
    
    /* Scrollbar styling for source material */
    .source-material-content::-webkit-scrollbar {
      width: 8px;
    }
    
    .source-material-content::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    
    .source-material-content::-webkit-scrollbar-thumb {
      background: var(--color-primary);
      border-radius: 4px;
    }
    
    .source-material-content::-webkit-scrollbar-thumb:hover {
      background: var(--color-primary-light);
    }
    
    /* Source material hint when collapsed */
    .source-material-hint {
      padding: var(--space-sm) var(--space-lg);
      font-size: 0.85rem;
      color: var(--color-text-muted);
      font-style: italic;
      display: none;
    }
    
    .source-material-card.collapsed .source-material-hint {
      display: block;
    }
    
    /* =====================================================
       TECHNICAL ERROR CORRECTION - Two-stage submission
       ===================================================== */
    
    .technical-check-panel {
      background: linear-gradient(145deg, rgba(30, 30, 50, 0.98), rgba(25, 25, 45, 0.95));
      border: 2px solid var(--color-warning);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
      box-shadow: 0 0 30px rgba(245, 158, 11, 0.15);
    }
    
    .technical-check-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--color-border);
    }
    
    .technical-check-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-family: var(--font-display);
      font-size: 1.1rem;
      color: var(--color-warning);
      margin: 0;
    }
    
    .technical-check-progress {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: 0.9rem;
      color: var(--color-text-muted);
    }
    
    .error-progress-dots {
      display: flex;
      gap: 4px;
    }
    
    .error-progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--color-surface-hover);
      transition: all var(--transition-fast);
    }
    
    .error-progress-dot.completed {
      background: var(--color-success);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }
    
    .error-progress-dot.current {
      background: var(--color-warning);
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
      transform: scale(1.2);
    }
    
    .error-progress-dot.skipped {
      background: var(--color-text-muted);
      opacity: 0.5;
    }
    
    .error-card {
      background: rgba(0, 0, 0, 0.2);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
    }
    
    .error-type-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: var(--space-md);
    }
    
    .error-type-badge.spelling {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    
    .error-type-badge.grammar {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }
    
    .error-type-badge.punctuation {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
    }
    
    .error-type-badge.expression {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }
    
    .error-context {
      background: rgba(255, 255, 255, 0.05);
      border-left: 3px solid var(--color-warning);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
      font-family: var(--font-body);
      font-size: 1rem;
      line-height: 1.6;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    
    .error-highlight {
      background: rgba(239, 68, 68, 0.3);
      border-bottom: 2px wavy #ef4444;
      padding: 0 2px;
      border-radius: 2px;
    }
    
    .error-rule {
      margin-bottom: var(--space-md);
    }
    
    .error-rule-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-primary-light);
      margin-bottom: var(--space-xs);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .error-rule-text {
      font-size: 0.95rem;
      color: var(--color-text);
      line-height: 1.5;
    }
    
    .error-hint {
      background: linear-gradient(135deg, rgba(184, 134, 11, 0.1), rgba(184, 134, 11, 0.05));
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-lg);
    }
    
    .error-hint-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-accent);
      margin-bottom: var(--space-xs);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .error-hint-text {
      font-size: 0.95rem;
      color: var(--color-text-secondary);
      font-style: italic;
    }
    
    .error-correction-area {
      margin-bottom: var(--space-md);
    }
    
    .error-correction-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-sm);
    }
    
    .error-correction-input {
      width: 100%;
      padding: var(--space-md);
      font-family: var(--font-body);
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      color: var(--color-text);
      transition: all var(--transition-fast);
    }
    
    .error-correction-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-glow);
    }
    
    .error-correction-input.error {
      border-color: var(--color-error);
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }
    
    .error-correction-input.success {
      border-color: var(--color-success);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }
    
    .correction-feedback {
      margin-top: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
    }
    
    .correction-feedback.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-error);
    }
    
    .correction-feedback.success {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }
    
    .correction-feedback.skipped {
      background: rgba(100, 100, 120, 0.2);
      color: var(--color-text-muted);
    }
    
    .technical-check-actions {
      display: flex;
      gap: var(--space-md);
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    
    .technical-all-clear {
      text-align: center;
      padding: var(--space-xl);
    }
    
    .technical-all-clear-icon {
      font-size: 3rem;
      margin-bottom: var(--space-md);
    }
    
    .technical-all-clear-title {
      font-family: var(--font-display);
      font-size: 1.3rem;
      color: var(--color-success);
      margin-bottom: var(--space-sm);
    }
    
    .technical-all-clear-text {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-lg);
    }
    
    /* Completion celebration */
    .errors-complete-celebration {
      text-align: center;
      padding: var(--space-xl);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
      border-radius: var(--radius-lg);
      border: 2px solid var(--color-success);
    }
    
    .celebration-icon {
      font-size: 3rem;
      margin-bottom: var(--space-md);
      animation: bounce 0.5s ease infinite alternate;
    }
    
    @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-10px); }
    }
    
    .celebration-title {
      font-family: var(--font-display);
      font-size: 1.3rem;
      color: var(--color-success);
      margin-bottom: var(--space-sm);
    }
    
    .celebration-text {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-lg);
    }
    
    /* =====================================================
       ESSAY COMPARISON - Original vs Improved
       ===================================================== */
    
    .essay-comparison {
      background: linear-gradient(145deg, rgba(25, 35, 55, 0.95), rgba(20, 30, 50, 0.98));
      border: 2px solid var(--color-primary);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      margin-bottom: var(--space-xl);
      box-shadow: var(--shadow-lg), var(--shadow-gold);
    }
    
    .comparison-header {
      text-align: center;
      margin-bottom: var(--space-xl);
    }
    
    .comparison-title {
      font-family: var(--font-display);
      font-size: 1.4rem;
      color: var(--color-primary-light);
      margin-bottom: var(--space-sm);
    }
    
    .comparison-subtitle {
      color: var(--color-text-muted);
      font-size: 0.95rem;
    }
    
    .grade-comparison-boxes {
      display: flex;
      gap: var(--space-xl);
      justify-content: center;
      align-items: center;
      margin-bottom: var(--space-xl);
      flex-wrap: wrap;
    }
    
    .grade-box {
      text-align: center;
      padding: var(--space-lg) var(--space-xl);
      border-radius: var(--radius-lg);
      min-width: 160px;
    }
    
    .grade-box.original {
      background: linear-gradient(135deg, rgba(100, 100, 120, 0.3), rgba(80, 80, 100, 0.2));
      border: 2px solid rgba(150, 150, 170, 0.3);
    }
    
    .grade-box.improved {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
      border: 2px solid var(--color-success);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
    }
    
    .grade-box-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--color-text-muted);
      margin-bottom: var(--space-sm);
    }
    
    .grade-box-grade {
      font-family: var(--font-display);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: var(--space-xs);
    }
    
    .grade-box.original .grade-box-grade {
      color: var(--color-text-secondary);
    }
    
    .grade-box.improved .grade-box-grade {
      color: var(--color-success);
    }
    
    .grade-box-marks {
      font-size: 0.9rem;
      color: var(--color-text-muted);
    }
    
    .comparison-arrow {
      font-size: 2rem;
      color: var(--color-primary);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
    
    .improvement-summary {
      text-align: center;
      padding: var(--space-lg);
      background: linear-gradient(135deg, rgba(184, 134, 11, 0.15), rgba(184, 134, 11, 0.08));
      border-radius: var(--radius-md);
      margin-bottom: var(--space-xl);
    }
    
    .improvement-headline {
      font-family: var(--font-display);
      font-size: 1.2rem;
      color: var(--color-accent);
      margin-bottom: var(--space-sm);
    }
    
    .marks-gained {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      background: var(--color-success-bg);
      color: var(--color-success);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: 1rem;
    }
    
    .improvement-details {
      margin-top: var(--space-xl);
    }
    
    .improvement-details-title {
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--color-primary-light);
      margin-bottom: var(--space-md);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .improvement-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
      border-left: 3px solid var(--color-success);
    }
    
    .improvement-item-area {
      font-weight: 600;
      color: var(--color-success);
      margin-bottom: var(--space-xs);
    }
    
    .improvement-item-before {
      font-size: 0.9rem;
      color: var(--color-text-muted);
      margin-bottom: var(--space-xs);
    }
    
    .improvement-item-before::before {
      content: "Before: ";
      color: var(--color-error);
      font-weight: 500;
    }
    
    .improvement-item-after {
      font-size: 0.9rem;
      color: var(--color-text);
    }
    
    .improvement-item-after::before {
      content: "After: ";
      color: var(--color-success);
      font-weight: 500;
    }
    
    .comparison-progress-comment {
      padding: var(--space-lg);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
      border-radius: var(--radius-md);
      border: 1px solid rgba(34, 197, 94, 0.3);
      margin-top: var(--space-lg);
    }
    
    .comparison-progress-label {
      font-size: 0.85rem;
      color: var(--color-success);
      font-weight: 600;
      margin-bottom: var(--space-sm);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .comparison-progress-text {
      font-size: 1rem;
      color: var(--color-text);
      line-height: 1.6;
    }
    
        /* Mobile task toggle button */
    .task-toggle-btn {
      display: none;
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
      color: var(--color-text-inverse);
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-lg), var(--shadow-gold);
      z-index: 100;
      transition: transform var(--transition-base), box-shadow var(--transition-base);
    }
    
    .task-toggle-btn:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-xl), var(--shadow-gold-strong);
    }
    
    .task-toggle-btn.has-task {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Mobile styles */
    @media (max-width: 1024px) {
      .writing-layout {
        flex-direction: column;
      }
      
      .task-panel {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-height: 100vh;
        border-radius: 0;
        z-index: 200;
        padding: var(--space-xl);
        padding-top: var(--space-lg);
      }
      
      .task-panel.mobile-open {
        display: block;
      }
      
      .task-panel-close {
        display: block;
      }
      
      .task-toggle-btn.has-task {
        display: flex;
      }
    }
    
    @media (min-width: 1025px) {
      .task-toggle-btn {
        display: none !important;
      }
    }
    
    /* =====================================================
       ESSAY SELECTION SCREEN
       ===================================================== */
    
    .essay-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--space-lg);
      margin-top: var(--space-xl);
    }
    
    .essay-card {
      background: linear-gradient(145deg, var(--color-surface) 0%, rgba(30, 40, 60, 0.95) 100%);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      cursor: pointer;
      transition: all var(--transition-base);
      position: relative;
      overflow: hidden;
    }
    
    .essay-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light));
      opacity: 0;
      transition: opacity var(--transition-base);
    }
    
    .essay-card:hover {
      border-color: var(--color-primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg), var(--shadow-gold);
    }
    
    .essay-card:hover::before {
      opacity: 1;
    }
    
    .essay-card-icon {
      font-size: 2.5rem;
      margin-bottom: var(--space-md);
    }
    
    .essay-card-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--color-primary-light);
      margin-bottom: var(--space-sm);
    }
    
    .essay-card-meta {
      display: flex;
      gap: var(--space-md);
      margin-bottom: var(--space-md);
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    
    .essay-card-meta span {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .essay-card-description {
      color: var(--color-text-secondary);
      font-size: 0.95rem;
      line-height: 1.6;
    }
    
    .essay-card-stats {
      display: flex;
      gap: var(--space-lg);
      margin-top: var(--space-lg);
      padding-top: var(--space-md);
      border-top: 1px solid var(--color-border);
      font-size: 0.85rem;
    }
    
    .essay-card-stat {
      color: var(--color-text-muted);
    }
    
    .essay-card-stat strong {
      color: var(--color-accent);
    }
    
    /* Teacher dashboard essay filter */
    .essay-filter {
      display: flex;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
    }
    
    .essay-filter-btn {
      padding: var(--space-sm) var(--space-md);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all var(--transition-base);
      font-size: 0.85rem;
    }
    
    .essay-filter-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary-light);
    }
    
    .essay-filter-btn.active {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
      border-color: var(--color-primary);
      color: var(--color-text-inverse);
    }
  

    /* =====================================================
       TARGET GRADE SELECTOR
       ===================================================== */

    .grade-selector {
      margin-bottom: var(--space-lg);
    }

    .grade-selector-label {
      display: block;
      margin-bottom: var(--space-sm);
      font-weight: 600;
    }

    .grade-selector-hint {
      font-size: 0.85rem;
      color: var(--color-text-muted);
      margin-bottom: var(--space-md);
      font-style: italic;
    }

    .grade-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .grade-button {
      min-width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(30, 30, 50, 0.8);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      color: var(--color-text);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .grade-button:hover {
      border-color: var(--color-primary);
      background: var(--color-surface-hover);
      transform: translateY(-2px);
    }

    .grade-button.selected {
      border-color: var(--color-primary);
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
      color: var(--color-text-inverse);
      box-shadow: 0 0 15px var(--color-primary-glow);
    }

    .grade-button.high-tier {
      border-color: rgba(34, 197, 94, 0.5);
    }

    .grade-button.high-tier.selected {
      background: linear-gradient(135deg, var(--color-success) 0%, #34d399 100%);
      border-color: var(--color-success);
    }

    .grade-button.foundation-tier {
      border-color: rgba(59, 130, 246, 0.5);
    }

    .grade-button.foundation-tier.selected {
      background: linear-gradient(135deg, var(--color-info) 0%, #60a5fa 100%);
      border-color: var(--color-info);
    }

    .grade-info-box {
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: var(--color-surface-hover);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--color-primary);
    }

    .grade-info-box.high {
      border-left-color: var(--color-success);
      background: var(--color-success-bg);
    }

    .grade-info-box.foundation {
      border-left-color: var(--color-info);
      background: var(--color-info-bg);
    }

    .grade-info-title {
      font-weight: 600;
      margin-bottom: var(--space-xs);
      color: var(--color-text);
    }

    .grade-info-text {
      font-size: 0.9rem;
      color: var(--color-text-secondary);
    }

    .target-grade-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      background: var(--color-surface-hover);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }

    .target-grade-badge strong {
      color: var(--color-primary-light);
    }
</style>

</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // Helper: allow writing inline styles as CSS strings in JSX.
    // Converts "margin-top: 8px; background: var(--color-bg);" -> { marginTop: "8px", background: "var(--color-bg)" }
    const parseStyle = (input) => {
      if (!input) return {};
      if (typeof input === 'object') return input;
      const out = {};
      String(input).split(';').forEach((chunk) => {
        const idx = chunk.indexOf(':');
        if (idx === -1) return;
        const rawKey = chunk.slice(0, idx).trim();
        let rawVal = chunk.slice(idx + 1).trim();
        if (!rawKey || !rawVal) return;
        // Strip wrapping quotes inside the style string (common in older templates)
        if ((rawVal.startsWith("'") && rawVal.endsWith("'")) || (rawVal.startsWith('"') && rawVal.endsWith('"'))) {
          rawVal = rawVal.slice(1, -1);
        }
        const jsKey = rawKey.replace(/-([a-z])/g, (_, c) => c.toUpperCase());
        out[jsKey] = rawVal;
      });
      return out;
    };
    
    
    // =====================================================
    // MULTI-ESSAY CONFIGURATION
    // =====================================================
    
    // Global settings
    const GLOBAL = window.GLOBAL_CONFIG || {};
    // ESSAY_LIST and ESSAYS are populated by the dynamic loader before React renders
    // Access them via window to get the loaded values
    const getEssayList = () => window.ESSAY_LIST || [];
    const getEssays = () => window.ESSAYS || {};
    const THEME = window.THEME_CONFIG || {};
    
    // =====================================================
    // FIREBASE INITIALIZATION
    // =====================================================
    
    let db = null;
    let FIREBASE_ENABLED = false;
    
    // Initialize Firebase (called after config is loaded)
    async function initializeFirebase() {
      // First, load the config from Netlify Function
      if (typeof loadFirebaseConfig === 'function') {
        await loadFirebaseConfig();
      }
      
      // Debug Firebase configuration
      console.log('Firebase Config Check:');
      console.log('  window.FIREBASE_ENABLED:', window.FIREBASE_ENABLED);
      console.log('  window.FIREBASE_CONFIG:', window.FIREBASE_CONFIG);
      console.log('  apiKey present:', !!window.FIREBASE_CONFIG?.apiKey);
      
      FIREBASE_ENABLED = window.FIREBASE_ENABLED && window.FIREBASE_CONFIG?.apiKey;
      console.log('  FIREBASE_ENABLED result:', FIREBASE_ENABLED);
      
      if (FIREBASE_ENABLED) {
        try {
          // Check if already initialized
          if (!firebase.apps.length) {
            firebase.initializeApp(window.FIREBASE_CONFIG);
          }
          db = firebase.firestore();
          console.log('Firebase initialized successfully');
          return true;
        } catch (error) {
          console.error('Firebase initialization failed:', error);
          FIREBASE_ENABLED = false;
          return false;
        }
      } else {
        console.log('Firebase not configured - using Netlify Blobs fallback');
        return false;
      }
    }
    
    // Store the initialization promise so methods can wait for it
    let firebaseReadyPromise = initializeFirebase();
    
    // Helper to ensure Firebase is ready before operations
    async function ensureFirebaseReady() {
      await firebaseReadyPromise;
      return FIREBASE_ENABLED && db;
    }
    
    // Firebase Database Helper Functions
    const FirebaseDB = {
      // Check if Firebase is available
      async isReady() {
        await firebaseReadyPromise;
        return FIREBASE_ENABLED && db !== null;
      },
      
      // Save student progress (in-progress essays)
      async saveProgress(progressData) {
        await firebaseReadyPromise;
        if (!db) return null;
        try {
          const docId = `${progressData.studentEmail}_${progressData.essayId}`;
          await db.collection('progress').doc(docId).set({
            ...progressData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          return true;
        } catch (error) {
          console.error('Firebase saveProgress error:', error);
          return null;
        }
      },
      
      // Submit completed essay
      async submitEssay(submissionData) {
        await firebaseReadyPromise;
        if (!db) return null;
        try {
          const docRef = await db.collection('submissions').add({
            ...submissionData,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          // Remove from progress collection
          const progressDocId = `${submissionData.studentEmail}_${submissionData.essayId}`;
          await db.collection('progress').doc(progressDocId).delete().catch(() => {});
          return docRef.id;
        } catch (error) {
          console.error('Firebase submitEssay error:', error);
          return null;
        }
      },
      
      // Get all submissions (for teacher dashboard)
      async getSubmissions() {
        await firebaseReadyPromise;
        if (!db) return null;
        try {
          const snapshot = await db.collection('submissions')
            .orderBy('submittedAt', 'desc')
            .limit(100)
            .get();
          return snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            submittedAt: doc.data().submittedAt?.toDate?.()?.toISOString() || doc.data().submittedAt
          }));
        } catch (error) {
          console.error('Firebase getSubmissions error:', error);
          return null;
        }
      },
      
      // Get in-progress students (for teacher dashboard)
      async getProgress() {
        await firebaseReadyPromise;
        if (!db) return null;
        try {
          // Only get progress from last 24 hours
          const cutoff = new Date();
          cutoff.setHours(cutoff.getHours() - 24);
          
          const snapshot = await db.collection('progress')
            .where('updatedAt', '>', cutoff)
            .orderBy('updatedAt', 'desc')
            .get();
          return snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            lastUpdate: doc.data().updatedAt?.toDate?.()?.toISOString() || doc.data().lastUpdate
          }));
        } catch (error) {
          console.error('Firebase getProgress error:', error);
          return null;
        }
      },
      
      // Get progress for a specific student (all essays)
      async getStudentProgress(studentEmail) {
        await firebaseReadyPromise;
        if (!db || !studentEmail) return [];
        try {
          const snapshot = await db.collection('progress')
            .where('studentEmail', '==', studentEmail.toLowerCase())
            .get();
          return snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            lastUpdate: doc.data().updatedAt?.toDate?.()?.toISOString() || doc.data().lastUpdate
          }));
        } catch (error) {
          console.error('Firebase getStudentProgress error:', error);
          return [];
        }
      },
      
      // Get progress for a specific student and essay
      async getStudentEssayProgress(studentEmail, essayId) {
        await firebaseReadyPromise;
        if (!db || !studentEmail || !essayId) return null;
        try {
          const docId = `${studentEmail.toLowerCase()}_${essayId}`;
          const doc = await db.collection('progress').doc(docId).get();
          if (!doc.exists) return null;
          const data = doc.data();
          return {
            id: doc.id,
            ...data,
            lastUpdate: data.updatedAt?.toDate?.()?.toISOString() || data.lastUpdate
          };
        } catch (error) {
          console.error('Firebase getStudentEssayProgress error:', error);
          return null;
        }
      },
      
      // Subscribe to real-time submissions updates
      subscribeToSubmissions(callback) {
        if (!db) return () => {};
        return db.collection('submissions')
          .orderBy('submittedAt', 'desc')
          .limit(100)
          .onSnapshot(snapshot => {
            const submissions = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data(),
              submittedAt: doc.data().submittedAt?.toDate?.()?.toISOString() || doc.data().submittedAt
            }));
            callback(submissions);
          }, error => {
            console.error('Submissions subscription error:', error);
          });
      },
      
      // Subscribe to real-time progress updates
      subscribeToProgress(callback) {
        if (!db) return () => {};
        const cutoff = new Date();
        cutoff.setHours(cutoff.getHours() - 24);
        
        return db.collection('progress')
          .where('updatedAt', '>', cutoff)
          .orderBy('updatedAt', 'desc')
          .onSnapshot(snapshot => {
            const progress = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data(),
              lastUpdate: doc.data().updatedAt?.toDate?.()?.toISOString() || doc.data().lastUpdate
            }));
            callback(progress);
          }, error => {
            console.error('Progress subscription error:', error);
          });
      },
      
      // =====================================================
      // STUDENT AUTHENTICATION METHODS
      // =====================================================
      
      // Simple hash function for passwords
      async hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      },
      
      // Generate random password
      generatePassword(length = 8) {
        const chars = 'abcdefghjkmnpqrstuvwxyz23456789';
        let password = '';
        const array = new Uint8Array(length);
        crypto.getRandomValues(array);
        for (let i = 0; i < length; i++) {
          password += chars[array[i] % chars.length];
        }
        return password;
      },
      
      // Student login
      async studentLogin(email, password) {
        await firebaseReadyPromise;
        if (!db) return { success: false, error: 'Database not available' };
        try {
          const emailLower = email.trim().toLowerCase();
          const doc = await db.collection('students').doc(emailLower).get();
          
          if (!doc.exists) {
            return { success: false, error: 'Account not found. Please contact your teacher.' };
          }
          
          const studentData = doc.data();
          const inputHash = await this.hashPassword(password);
          
          if (inputHash !== studentData.passwordHash) {
            return { success: false, error: 'Incorrect password' };
          }
          
          // Generate session token
          const tokenArray = new Uint8Array(32);
          crypto.getRandomValues(tokenArray);
          const sessionToken = Array.from(tokenArray).map(b => b.toString(16).padStart(2, '0')).join('');
          
          // Save session
          const sessionExpiry = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
          await db.collection('sessions').doc(sessionToken).set({
            email: emailLower,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            expiresAt: sessionExpiry
          });
          
          // Update last login
          await db.collection('students').doc(emailLower).update({
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Get assignments from ALL classes (support multiple classes)
          let classAssignments = [];
          const classIds = studentData.classIds || (studentData.classId ? [studentData.classId] : []);
          
          for (const cid of classIds) {
            try {
              const classDoc = await db.collection('classes').doc(cid).get();
              if (classDoc.exists) {
                const classEssays = classDoc.data().assignedEssays || [];
                classAssignments.push(...classEssays);
              }
            } catch (e) {
              console.log('Error fetching class:', cid, e);
            }
          }
          
          const allAssignments = [...new Set([
            ...classAssignments,
            ...(studentData.individualAssignments || [])
          ])];
          
          const { passwordHash, ...safeData } = studentData;
          return {
            success: true,
            sessionToken,
            student: { ...safeData, assignedEssays: allAssignments }
          };
        } catch (error) {
          console.error('Login error:', error);
          return { success: false, error: 'Login failed. Please try again.' };
        }
      },
      
      // Verify session
      async verifySession(sessionToken) {
        if (!db || !sessionToken) return { success: false };
        try {
          const sessionDoc = await db.collection('sessions').doc(sessionToken).get();
          if (!sessionDoc.exists) return { success: false };
          
          const session = sessionDoc.data();
          const expiresAt = session.expiresAt?.toDate?.() || new Date(session.expiresAt);
          
          if (expiresAt < new Date()) {
            await db.collection('sessions').doc(sessionToken).delete();
            return { success: false, error: 'Session expired' };
          }
          
          const studentDoc = await db.collection('students').doc(session.email).get();
          if (!studentDoc.exists) return { success: false };
          
          const studentData = studentDoc.data();
          
          // Get assignments from ALL classes (support multiple classes)
          let classAssignments = [];
          const classIds = studentData.classIds || (studentData.classId ? [studentData.classId] : []);
          
          for (const cid of classIds) {
            try {
              const classDoc = await db.collection('classes').doc(cid).get();
              if (classDoc.exists) {
                const classEssays = classDoc.data().assignedEssays || [];
                classAssignments.push(...classEssays);
              }
            } catch (e) {
              console.log('Error fetching class:', cid, e);
            }
          }
          
          const allAssignments = [...new Set([
            ...classAssignments,
            ...(studentData.individualAssignments || [])
          ])];
          
          const { passwordHash, ...safeData } = studentData;
          return {
            success: true,
            student: { ...safeData, assignedEssays: allAssignments }
          };
        } catch (error) {
          console.error('Session verify error:', error);
          return { success: false };
        }
      },
      
      // Logout
      async studentLogout(sessionToken) {
        if (!db || !sessionToken) return;
        try {
          await db.collection('sessions').doc(sessionToken).delete();
        } catch (error) {
          console.error('Logout error:', error);
        }
      },
      
      // Change password
      async changePassword(sessionToken, currentPassword, newPassword) {
        await firebaseReadyPromise;
        await firebaseReadyPromise;
        if (!db) return { success: false, error: 'Database not available' };
        try {
          const sessionDoc = await db.collection('sessions').doc(sessionToken).get();
          if (!sessionDoc.exists) return { success: false, error: 'Invalid session' };
          
          const email = sessionDoc.data().email;
          const studentDoc = await db.collection('students').doc(email).get();
          if (!studentDoc.exists) return { success: false, error: 'Student not found' };
          
          const studentData = studentDoc.data();
          const currentHash = await this.hashPassword(currentPassword);
          
          if (currentHash !== studentData.passwordHash) {
            return { success: false, error: 'Current password is incorrect' };
          }
          
          const newHash = await this.hashPassword(newPassword);
          await db.collection('students').doc(email).update({
            passwordHash: newHash,
            passwordChangedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          return { success: true };
        } catch (error) {
          console.error('Change password error:', error);
          return { success: false, error: 'Failed to change password' };
        }
      },
      
      // =====================================================
      // STUDENT MANAGEMENT METHODS
      // =====================================================
      
      // Get all students
      async getStudents(classId = null) {
        await firebaseReadyPromise;
        if (!db) return [];
        try {
          let query = db.collection('students');
          if (classId) {
            query = query.where('classId', '==', classId);
          }
          const snapshot = await query.get();
          return snapshot.docs.map(doc => {
            const { passwordHash, ...safeData } = doc.data();
            return { ...safeData, email: doc.id };
          }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        } catch (error) {
          console.error('Get students error:', error);
          return [];
        }
      },
      
      // Create student
      async createStudent(studentData) {
        await firebaseReadyPromise;
        if (!db) return { success: false, error: 'Database not available' };
        try {
          const emailLower = studentData.email.trim().toLowerCase();
          
          const existing = await db.collection('students').doc(emailLower).get();
          if (existing.exists) {
            return { success: false, error: 'Student already exists' };
          }
          
          const password = studentData.password || this.generatePassword();
          const passwordHash = await this.hashPassword(password);
          
          // Support both single classId and array of classIds
          const classIds = studentData.classIds || (studentData.classId ? [studentData.classId] : []);
          
          // Fetch class info for display (use first class for backwards compatibility)
          const classNames = [];
          const teachers = [];
          let yearGroup = studentData.yearGroup || null;
          
          for (const cid of classIds) {
            try {
              const classDoc = await db.collection('classes').doc(cid).get();
              if (classDoc.exists) {
                const classInfo = classDoc.data();
                classNames.push(classInfo.name);
                if (classInfo.teacher && !teachers.includes(classInfo.teacher)) {
                  teachers.push(classInfo.teacher);
                }
                if (!yearGroup && classInfo.yearGroup) {
                  yearGroup = classInfo.yearGroup;
                }
              }
            } catch (e) {
              console.log('Error fetching class:', cid, e);
            }
          }
          
          const newStudent = {
            email: emailLower,
            name: studentData.name.trim(),
            classIds: classIds,
            classNames: classNames,
            yearGroup: yearGroup,
            teachers: teachers,
            individualAssignments: [],
            passwordHash,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: null
          };
          
          await db.collection('students').doc(emailLower).set(newStudent);
          
          // Add to all class rosters
          for (const cid of classIds) {
            try {
              await db.collection('classes').doc(cid).update({
                students: firebase.firestore.FieldValue.arrayUnion(emailLower)
              });
            } catch (e) {
              console.log('Error adding to class roster:', cid, e);
            }
          }
          
          const { passwordHash: _, ...safeStudent } = newStudent;
          return { success: true, student: safeStudent, generatedPassword: password };
        } catch (error) {
          console.error('Create student error:', error);
          return { success: false, error: error.message };
        }
      },
      
      // Delete student
      async deleteStudent(email) {
        await firebaseReadyPromise;
        if (!db) return { success: false };
        try {
          const emailLower = email.trim().toLowerCase();
          const studentDoc = await db.collection('students').doc(emailLower).get();
          
          if (studentDoc.exists) {
            const studentData = studentDoc.data();
            // Remove from ALL class rosters
            const classIds = studentData.classIds || (studentData.classId ? [studentData.classId] : []);
            for (const cid of classIds) {
              await db.collection('classes').doc(cid).update({
                students: firebase.firestore.FieldValue.arrayRemove(emailLower)
              }).catch(() => {});
            }
          }
          
          await db.collection('students').doc(emailLower).delete();
          return { success: true };
        } catch (error) {
          console.error('Delete student error:', error);
          return { success: false, error: error.message };
        }
      },
      
      // Reset student password
      async resetStudentPassword(email) {
        await firebaseReadyPromise;
        if (!db) return { success: false };
        try {
          const emailLower = email.trim().toLowerCase();
          const newPassword = this.generatePassword();
          const passwordHash = await this.hashPassword(newPassword);
          
          await db.collection('students').doc(emailLower).update({
            passwordHash,
            passwordResetAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          return { success: true, newPassword };
        } catch (error) {
          console.error('Reset password error:', error);
          return { success: false, error: error.message };
        }
      },
      
      // Import students from CSV data
      // classIds: optional array of class IDs to add ALL students to (from checkboxes)
      // allClasses: array of all class objects for looking up class names from CSV
      async importStudents(students, classIds = null, allClasses = []) {
        await firebaseReadyPromise;
        if (!db) return { success: false };
        
        // Build a lookup map from class name to class info (case-insensitive)
        const classNameToInfo = {};
        for (const cls of allClasses) {
          const nameLower = (cls.name || '').toLowerCase().trim();
          if (nameLower) {
            classNameToInfo[nameLower] = cls;
          }
        }
        
        // Normalize global classIds to array
        const globalClassIds = classIds ? (Array.isArray(classIds) ? classIds : [classIds]) : [];
        
        // Pre-fetch info for global classes
        const globalClassInfo = {};
        for (const cid of globalClassIds) {
          const cls = allClasses.find(c => c.id === cid);
          if (cls) globalClassInfo[cid] = cls;
        }
        
        const results = { created: [], skipped: [], errors: [] };
        
        for (const student of students) {
          try {
            const emailLower = student.email.trim().toLowerCase();
            
            // Determine this student's classes:
            // 1. From CSV "class" or "classes" column
            // 2. Plus any globally selected classes (checkboxes)
            let studentClassIds = [...globalClassIds];
            let studentClassNames = Object.values(globalClassInfo).map(c => c.name);
            let studentTeachers = [...new Set(Object.values(globalClassInfo).map(c => c.teacher).filter(Boolean))];
            let studentYearGroup = student.yearGroup || null;
            
            // Check for class column in CSV (could be single or comma-separated)
            const csvClassValue = student.class || student.classes || null;
            if (csvClassValue) {
              const csvClassNames = csvClassValue.split(',').map(c => c.trim()).filter(Boolean);
              
              for (const className of csvClassNames) {
                const classInfo = classNameToInfo[className.toLowerCase()];
                if (classInfo) {
                  if (!studentClassIds.includes(classInfo.id)) {
                    studentClassIds.push(classInfo.id);
                    studentClassNames.push(classInfo.name);
                    if (classInfo.teacher && !studentTeachers.includes(classInfo.teacher)) {
                      studentTeachers.push(classInfo.teacher);
                    }
                    if (!studentYearGroup && classInfo.yearGroup) {
                      studentYearGroup = classInfo.yearGroup;
                    }
                  }
                }
                // If class name not found, we silently skip it (class might not exist yet)
              }
            }
            
            // Deduplicate
            studentClassIds = [...new Set(studentClassIds)];
            studentClassNames = [...new Set(studentClassNames)];
            studentTeachers = [...new Set(studentTeachers)];
            
            const existing = await db.collection('students').doc(emailLower).get();
            
            if (existing.exists) {
              results.skipped.push({ email: emailLower, name: student.name, reason: 'Already exists' });
              
              // Still add to all classes if needed
              for (const cid of studentClassIds) {
                await db.collection('classes').doc(cid).update({
                  students: firebase.firestore.FieldValue.arrayUnion(emailLower)
                }).catch(() => {});
              }
              
              // Update existing student to add new classes
              if (studentClassIds.length > 0) {
                const existingData = existing.data();
                const existingClassIds = existingData.classIds || (existingData.classId ? [existingData.classId] : []);
                const mergedClassIds = [...new Set([...existingClassIds, ...studentClassIds])];
                const mergedClassNames = [...new Set([...(existingData.classNames || []), ...studentClassNames])];
                const mergedTeachers = [...new Set([...(existingData.teachers || []), ...studentTeachers])];
                
                await db.collection('students').doc(emailLower).update({
                  classIds: mergedClassIds,
                  classNames: mergedClassNames,
                  teachers: mergedTeachers
                });
              }
              continue;
            }
            
            const password = student.password || this.generatePassword();
            const passwordHash = await this.hashPassword(password);
            
            const newStudent = {
              email: emailLower,
              name: student.name.trim(),
              classIds: studentClassIds,
              classNames: studentClassNames,
              yearGroup: studentYearGroup,
              teachers: studentTeachers,
              individualAssignments: [],
              passwordHash,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              lastLogin: null
            };
            
            await db.collection('students').doc(emailLower).set(newStudent);
            
            // Add to all class rosters
            for (const cid of studentClassIds) {
              await db.collection('classes').doc(cid).update({
                students: firebase.firestore.FieldValue.arrayUnion(emailLower)
              }).catch(() => {});
            }
            
            results.created.push({ email: emailLower, name: student.name, password });
          } catch (err) {
            results.errors.push({ email: student.email, error: err.message });
          }
        }
        
        return { success: true, results };
      },
      
      // =====================================================
      // CLASS MANAGEMENT METHODS
      // =====================================================
      
      // Get all classes
      async getClasses() {
        await firebaseReadyPromise;
        if (!db) return [];
        try {
          const snapshot = await db.collection('classes').get();
          return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
            .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        } catch (error) {
          console.error('Get classes error:', error);
          return [];
        }
      },
      
      // Create class
      async createClass(classData) {
        await firebaseReadyPromise;
        if (!db) return { success: false };
        try {
          const classId = classData.name.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '') + '-' + Date.now().toString(36);
          
          const newClass = {
            id: classId,
            name: classData.name.trim(),
            subject: classData.subject || 'English',
            yearGroup: classData.yearGroup || null,
            teacher: classData.teacher || null,
            teacherEmail: classData.teacherEmail?.toLowerCase() || null,
            students: [],
            assignedEssays: [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await db.collection('classes').doc(classId).set(newClass);
          return { success: true, class: newClass };
        } catch (error) {
          console.error('Create class error:', error);
          return { success: false, error: error.message };
        }
      },
      
      // Delete class
      async deleteClass(classId) {
        await firebaseReadyPromise;
        if (!db) return { success: false };
        try {
          const classDoc = await db.collection('classes').doc(classId).get();
          if (classDoc.exists) {
            const classData = classDoc.data();
            // Remove class reference from all students
            for (const studentEmail of (classData.students || [])) {
              await db.collection('students').doc(studentEmail).update({
                classId: null,
                className: null,
                teacher: null,
                teacherEmail: null
              }).catch(() => {});
            }
          }
          await db.collection('classes').doc(classId).delete();
          return { success: true };
        } catch (error) {
          console.error('Delete class error:', error);
          return { success: false, error: error.message };
        }
      },
      
      // Assign essay to class
      async assignToClass(classId, essayId) {
        await firebaseReadyPromise;
        if (!db) return { success: false };
        try {
          await db.collection('classes').doc(classId).update({
            assignedEssays: firebase.firestore.FieldValue.arrayUnion(essayId)
          });
          return { success: true };
        } catch (error) {
          console.error('Assign to class error:', error);
          return { success: false, error: error.message };
        }
      },
      
      // Remove essay from class
      async unassignFromClass(classId, essayId) {
        await firebaseReadyPromise;
        if (!db) return { success: false };
        try {
          await db.collection('classes').doc(classId).update({
            assignedEssays: firebase.firestore.FieldValue.arrayRemove(essayId)
          });
          return { success: true };
        } catch (error) {
          console.error('Unassign from class error:', error);
          return { success: false, error: error.message };
        }
      },
      
      // Assign essay to individual student
      async assignToStudent(studentEmail, essayId) {
        await firebaseReadyPromise;
        if (!db) return { success: false };
        try {
          await db.collection('students').doc(studentEmail.toLowerCase()).update({
            individualAssignments: firebase.firestore.FieldValue.arrayUnion(essayId)
          });
          return { success: true };
        } catch (error) {
          console.error('Assign to student error:', error);
          return { success: false, error: error.message };
        }
      },
      
      // Remove essay from individual student
      async unassignFromStudent(studentEmail, essayId) {
        await firebaseReadyPromise;
        if (!db) return { success: false };
        try {
          await db.collection('students').doc(studentEmail.toLowerCase()).update({
            individualAssignments: firebase.firestore.FieldValue.arrayRemove(essayId)
          });
          return { success: true };
        } catch (error) {
          console.error('Unassign from student error:', error);
          return { success: false, error: error.message };
        }
      }
    };
    
    // Helper to get essay config by ID
    const getEssayConfig = (essayId) => {
      const essay = getEssays()[essayId];
      if (!essay) return null;
      return {
        TEACHER_PASSWORD: 'teacher123',
        LOCAL_STORAGE_KEY: `essay_app_${essayId}`,
        AUTO_SAVE_INTERVAL: 30000,
        DASHBOARD_REFRESH_INTERVAL: 15000,
        ...essay
      };
    };
    
    // Default grading criteria if not specified
    const getGradingCriteria = (config) => config?.gradingCriteria || {
      content: { weight: 25, description: "Content and understanding" },
      analysis: { weight: 25, description: "Analysis of language" },
      structure: { weight: 25, description: "Paragraph structure" },
      expression: { weight: 25, description: "Written expression" }
    };
    
    // Apply custom theme colors
    if (THEME.colors) {
      const root = document.documentElement;
      const colorMap = {
        primary: '--color-primary',
        secondary: '--color-secondary',
        accent: '--color-accent',
        background: '--color-bg',
        surface: '--color-surface',
        text: '--color-text',
        success: '--color-success',
        error: '--color-error',
        warning: '--color-warning'
      };
      Object.entries(THEME.colors).forEach(([key, value]) => {
        if (colorMap[key]) {
          root.style.setProperty(colorMap[key], value);
        }
      });
    }
    
    // =====================================================
    // UTILITY FUNCTIONS
    // =====================================================
    
    const countWords = (text) => {
      if (!text || !text.trim()) return 0;
      return text.trim().split(/\s+/).filter(w => w.length > 0).length;
    };
    
    const formatDateTime = (date) => {
      return new Date(date).toLocaleString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    };
    
    const getScoreClass = (score) => {
      if (score >= 80) return 'excellent';
      if (score >= 65) return 'good';
      if (score >= 50) return 'satisfactory';
      return 'needs-work';
    };
    
    const getGradeClass = (grade) => {
      const g = (grade || '').toLowerCase();
      if (g.includes('excellent')) return 'excellent';
      if (g.includes('good')) return 'good';
      if (g.includes('satisfactory')) return 'satisfactory';
      return 'needs-improvement';
    };
    
    const renderMarkdown = (text) => {
      if (!text) return '';
      if (typeof marked !== 'undefined') {
        return marked.parse(text);
      }
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^### (.*$)/gm, '<h4>$1</h4>')
        .replace(/^## (.*$)/gm, '<h3>$1</h3>')
        .replace(/^# (.*$)/gm, '<h2>$1</h2>')
        .replace(/\n/g, '<br>');
    };
    
    // =====================================================
    // TEXT-TO-SPEECH COMPONENT
    // =====================================================
    
    function TextToSpeech({ text, label = "Read aloud", targetGrade }) {
      const [isPlaying, setIsPlaying] = useState(false);
      const [isPaused, setIsPaused] = useState(false);
      const [speechRate, setSpeechRate] = useState(null);
      const utteranceRef = useRef(null);
      
      // Check if speech synthesis is available
      const isSpeechAvailable = typeof window !== 'undefined' && 'speechSynthesis' in window;
      
      // Determine default speed based on target grade
      useEffect(() => {
        if (speechRate === null) {
          const getDefaultRate = (grade) => {
            const foundationGrades = ['1', '2', '3', 'E', 'D'];
            const highGrades = ['8', '9', 'A*', 'A'];
            if (foundationGrades.includes(grade)) return 0.8;  // Slower for foundation
            if (highGrades.includes(grade)) return 1.0;  // Normal for high achievers
            return 0.9;  // Slightly slower for middle
          };
          setSpeechRate(getDefaultRate(targetGrade || '5'));
        }
      }, [targetGrade, speechRate]);
      
      // Clean up on unmount
      useEffect(() => {
        return () => {
          if (isSpeechAvailable) {
            window.speechSynthesis.cancel();
          }
        };
      }, []);
      
      const stripHtml = (html) => {
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || '';
      };
      
      const handlePlay = () => {
        if (!isSpeechAvailable) {
          alert('Text-to-speech is not supported in your browser. Please try Chrome, Firefox, Safari, or Edge.');
          return;
        }
        
        if (isPaused) {
          window.speechSynthesis.resume();
          setIsPaused(false);
          setIsPlaying(true);
          return;
        }
        
        // Cancel any existing speech
        window.speechSynthesis.cancel();
        
        // Clean the text
        const cleanText = stripHtml(text);
        
        // Create utterance
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.rate = speechRate || 0.9;
        utterance.pitch = 1;
        
        // Try to find a good English voice
        const voices = window.speechSynthesis.getVoices();
        const englishVoice = voices.find(v => 
          v.lang.startsWith('en-GB') || v.lang.startsWith('en-US')
        ) || voices.find(v => v.lang.startsWith('en'));
        
        if (englishVoice) {
          utterance.voice = englishVoice;
        }
        
        utterance.onend = () => {
          setIsPlaying(false);
          setIsPaused(false);
        };
        
        utterance.onerror = () => {
          setIsPlaying(false);
          setIsPaused(false);
        };
        
        utteranceRef.current = utterance;
        window.speechSynthesis.speak(utterance);
        setIsPlaying(true);
      };
      
      const handlePause = () => {
        if (isSpeechAvailable && isPlaying) {
          window.speechSynthesis.pause();
          setIsPaused(true);
          setIsPlaying(false);
        }
      };
      
      const handleStop = () => {
        if (isSpeechAvailable) {
          window.speechSynthesis.cancel();
          setIsPlaying(false);
          setIsPaused(false);
        }
      };
      
      const handleRateChange = (e) => {
        setSpeechRate(parseFloat(e.target.value));
        // If currently playing, restart with new rate
        if (isPlaying || isPaused) {
          handleStop();
        }
      };
      
      if (!isSpeechAvailable) {
        return null;
      }
      
      return (
        <div className="tts-controls">
          {!isPlaying && !isPaused ? (
            <button className="tts-button" onClick={handlePlay} title={label}>
              <span className="tts-icon"></span>
              <span>{label}</span>
            </button>
          ) : (
            <>
              {isPlaying ? (
                <button className="tts-button playing" onClick={handlePause} title="Pause">
                  <span className="tts-icon"></span>
                  <span>Pause</span>
                </button>
              ) : (
                <button className="tts-button" onClick={handlePlay} title="Resume">
                  <span className="tts-icon"></span>
                  <span>Resume</span>
                </button>
              )}
              <button className="tts-button" onClick={handleStop} title="Stop">
                <span className="tts-icon"></span>
                <span>Stop</span>
              </button>
            </>
          )}
          <div className="tts-speed">
            <label>Speed:</label>
            <select value={speechRate || 0.9} onChange={handleRateChange}>
              <option value="0.6">Slower</option>
              <option value="0.8">Slow</option>
              <option value="0.9">Normal</option>
              <option value="1.0">Fast</option>
              <option value="1.2">Faster</option>
            </select>
          </div>
        </div>
      );
    }
    
    // =====================================================
    // LOADING SPINNER
    // =====================================================
    
    function LoadingSpinner({ text = "Loading..." }) {
      return (
        <div className="grading-indicator">
          <div className="spinner"></div>
          <span className="grading-text">{text}</span>
        </div>
      );
    }
    
    // =====================================================
    // STUDENT LOGIN SCREEN
    // =====================================================
    
    function StudentLoginScreen({ onLoginSuccess, onTeacherLogin }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [showPassword, setShowPassword] = useState(false);
      const [showTeacherLogin, setShowTeacherLogin] = useState(false);

      const REQUIRED_EMAIL_DOMAIN = '@bb-hs.co.uk';

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');

        const emailLower = email.trim().toLowerCase();
        
        if (!emailLower) {
          setError('Please enter your school email');
          return;
        }

        if (!emailLower.endsWith(REQUIRED_EMAIL_DOMAIN)) {
          setError('Please use your school email (must end with ' + REQUIRED_EMAIL_DOMAIN + ')');
          return;
        }

        if (!password) {
          setError('Please enter your password');
          return;
        }

        setIsLoading(true);

        try {
          let result;
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            result = await FirebaseDB.studentLogin(emailLower, password);
          } else {
            const response = await fetch('/.netlify/functions/student-auth', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'login', email: emailLower, password })
            });
            result = await response.json();
          }

          if (result.success) {
            localStorage.setItem('studentSession', result.sessionToken);
            localStorage.setItem('studentData', JSON.stringify(result.student));
            onLoginSuccess(result.student, result.sessionToken);
          } else {
            setError(result.error || 'Login failed');
          }
        } catch (err) {
          console.error('Login error:', err);
          setError('Unable to connect. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };
      
      // Show teacher login form
      if (showTeacherLogin) {
        return (
          <div className="app-container">
            <div className="app-header" style={parseStyle("margin-bottom: var(--space-xl);")}>
              <h1 className="gold-glow">Essay Writing Assistant</h1>
            </div>
            <TeacherLoginForm
              onSuccess={(teacher) => onTeacherLogin(teacher)}
              onBack={() => setShowTeacherLogin(false)}
            />
          </div>
        );
      }

      return (
        <div className="app-container">
          <div className="card ghost-appear" style={parseStyle("max-width: 480px; margin: 0 auto;")}>
            <div className="app-header" style={parseStyle("margin-bottom: var(--space-xl); border: none; background: transparent; padding: var(--space-lg) 0;")}>
              <h1 className="gold-glow">Essay Writing Assistant</h1>
              <p className="subtitle">Sign in to continue</p>
            </div>

            <form onSubmit={handleLogin}>
              <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-sm); font-weight: 600;")}>
                  School Email
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => { setEmail(e.target.value); setError(''); }}
                  placeholder={'e.g. jsmith' + REQUIRED_EMAIL_DOMAIN}
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-md);")}
                  autoFocus
                  disabled={isLoading}
                />
              </div>

              <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-sm); font-weight: 600;")}>
                  Password
                </label>
                <div style={parseStyle("position: relative;")}>
                  <input
                    type={showPassword ? "text" : "password"}
                    value={password}
                    onChange={(e) => { setPassword(e.target.value); setError(''); }}
                    placeholder="Enter your password"
                    className="paragraph-editor"
                    style={parseStyle("min-height: auto; padding: var(--space-md); padding-right: 50px;")}
                    disabled={isLoading}
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    style={parseStyle("position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--color-text-muted); cursor: pointer; font-size: 0.9rem;")}
                  >
                    {showPassword ? 'Hide' : 'Show'}
                  </button>
                </div>
              </div>

              {error && (
                <div style={parseStyle("margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-md); color: var(--color-error);")}>
                  {error}
                </div>
              )}

              <button 
                type="submit" 
                className="btn btn-primary" 
                style={parseStyle("width: 100%; justify-content: center;")}
                disabled={isLoading}
              >
                {isLoading ? 'Signing in...' : 'Sign In'}
              </button>
            </form>

            <div style={parseStyle("margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 1px solid var(--color-border); text-align: center;")}>
              <p style={parseStyle("color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: var(--space-sm);")}>
                Forgot your password? Ask your teacher to reset it.
              </p>
              <button 
                type="button"
                onClick={() => setShowTeacherLogin(true)}
                style={parseStyle("background: none; border: none; color: var(--color-primary-light); cursor: pointer; font-size: 0.9rem; text-decoration: underline;")}
              >
                Teacher Login
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // =====================================================
    // STUDENT DASHBOARD
    // =====================================================
    
    function StudentDashboard({ student, sessionToken, onSelectEssay, onLogout, onExploreEssay }) {
      const [essaysLoading, setEssaysLoading] = useState(true);
      const [progressData, setProgressData] = useState({});
      const [submissionData, setSubmissionData] = useState({});
      const [showExplore, setShowExplore] = useState(false);
      const [showPasswordModal, setShowPasswordModal] = useState(false);

      const assignedEssays = (window.ESSAY_LIST || []).filter(essay => 
        (student.assignedEssays || []).includes(essay.id)
      );

      const otherEssays = (window.ESSAY_LIST || []).filter(essay => 
        !(student.assignedEssays || []).includes(essay.id)
      );

      useEffect(() => {
        const loadData = async () => {
          try {
            // Load progress for assigned essays
            const progressMap = {};
            const firebaseReady = await FirebaseDB.isReady();
            
            if (firebaseReady) {
              // Load all progress for this student from Firebase
              const allProgress = await FirebaseDB.getStudentProgress(student.email);
              allProgress.forEach(prog => {
                if (prog.essayId) {
                  progressMap[prog.essayId] = prog;
                }
              });
            } else {
              // Fallback to Netlify function
              for (const essay of assignedEssays) {
                try {
                  const response = await fetch('/.netlify/functions/save-progress?email=' + encodeURIComponent(student.email) + '&essayId=' + essay.id);
                  const data = await response.json();
                  if (data.success && data.found) {
                    progressMap[essay.id] = data.progress;
                  }
                } catch (e) {
                  console.log('Progress load error:', e);
                }
              }
            }
            setProgressData(progressMap);

            // Load submissions
            let submissions = [];
            if (firebaseReady) {
              submissions = await FirebaseDB.getSubmissions() || [];
            } else {
              const response = await fetch('/.netlify/functions/get-submissions');
              const data = await response.json();
              if (data.success) submissions = data.submissions || [];
            }
            
            const studentSubmissions = {};
            submissions.forEach(sub => {
              if (sub.studentEmail === student.email) {
                studentSubmissions[sub.essayId] = sub;
              }
            });
            setSubmissionData(studentSubmissions);
          } catch (err) {
            console.error('Error loading data:', err);
          } finally {
            setEssaysLoading(false);
          }
        };

        loadData();
      }, [student.email]);

      const getEssayStatus = (essayId) => {
        if (submissionData[essayId]) return 'submitted';
        if (progressData[essayId]?.percentComplete > 0) return 'in-progress';
        return 'not-started';
      };

      const handleLogout = async () => {
        try {
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            await FirebaseDB.studentLogout(sessionToken);
          } else {
            await fetch('/.netlify/functions/student-auth', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'logout', sessionToken })
            });
          }
        } catch (e) {
          console.log('Logout error:', e);
        }
        localStorage.removeItem('studentSession');
        localStorage.removeItem('studentData');
        onLogout();
      };

      const EssayCard = ({ essay, isAssigned }) => {
        const status = getEssayStatus(essay.id);
        const progress = progressData[essay.id];
        const submission = submissionData[essay.id];

        return (
          <div 
            className="essay-card"
            onClick={() => isAssigned ? onSelectEssay(essay.id) : onExploreEssay(essay.id)}
            style={parseStyle(status === 'submitted' ? "border-color: var(--color-success);" : "")}
          >
            {isAssigned && (
              <div style={parseStyle("position: absolute; top: var(--space-sm); right: var(--space-sm); background: var(--color-primary); color: var(--color-text-inverse); padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; font-weight: 600;")}>
                ASSIGNED
              </div>
            )}
            
            <h3 className="essay-card-title">{essay.title}</h3>
            <p className="essay-card-subject">{essay.subject} - {essay.yearGroup}</p>
            
            {essay.essayTitle && (
              <p style={parseStyle("font-style: italic; color: var(--color-text-muted); font-size: 0.9rem; margin-top: var(--space-sm);")}>
                "{essay.essayTitle}"
              </p>
            )}

            <div style={parseStyle("margin-top: var(--space-md);")}>
              {status === 'submitted' && (
                <div style={parseStyle("display: flex; align-items: center; gap: var(--space-sm); color: var(--color-success);")}>
                  <span>Submitted</span>
                  {submission?.grade && (
                    <span style={parseStyle("background: var(--color-success-bg); padding: 2px 8px; border-radius: var(--radius-sm); font-weight: 600;")}>
                      {submission.grade}
                    </span>
                  )}
                </div>
              )}
              
              {status === 'in-progress' && (
                <div>
                  <div style={parseStyle("display: flex; justify-content: space-between; margin-bottom: var(--space-xs); font-size: 0.85rem;")}>
                    <span style={parseStyle("color: var(--color-warning);")}>In Progress</span>
                    <span>{progress?.percentComplete || 0}%</span>
                  </div>
                  <div style={parseStyle("height: 4px; background: var(--color-border); border-radius: 2px; overflow: hidden;")}>
                    <div style={{ width: (progress?.percentComplete || 0) + '%', height: '100%', background: 'var(--color-warning)' }} />
                  </div>
                </div>
              )}
              
              {status === 'not-started' && (
                <span style={parseStyle("color: var(--color-text-muted); font-size: 0.85rem;")}>
                  Not started
                </span>
              )}
            </div>
          </div>
        );
      };

      return (
        <div className="app-container">
          <div className="card ghost-appear">
            <div style={parseStyle("display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-xl); flex-wrap: wrap; gap: var(--space-md);")}>
              <div>
                <h1 className="gold-glow" style={parseStyle("font-size: 1.8rem; margin-bottom: var(--space-xs);")}>
                  Welcome, {student.name.split(' ')[0]}!
                </h1>
                <p style={parseStyle("color: var(--color-text-muted);")}>
                  {(student.classNames?.length > 0 || student.className) && (
                    <span>{(student.classNames || [student.className]).filter(Boolean).join(', ')} - </span>
                  )}
                  {student.yearGroup && <span>{student.yearGroup} - </span>}
                  {(student.teachers?.length > 0 || student.teacher) && (
                    <span>{(student.teachers || [student.teacher]).filter(Boolean).join(', ')}</span>
                  )}
                </p>
              </div>
              <div style={parseStyle("display: flex; gap: var(--space-sm);")}>
                <button 
                  className="btn btn-secondary"
                  onClick={() => setShowPasswordModal(true)}
                  style={parseStyle("font-size: 0.85rem;")}
                >
                  Change Password
                </button>
                <button 
                  className="btn btn-secondary"
                  onClick={handleLogout}
                  style={parseStyle("font-size: 0.85rem;")}
                >
                  Sign Out
                </button>
              </div>
            </div>

            {assignedEssays.length > 0 && (
              <div style={parseStyle("margin-bottom: var(--space-2xl);")}>
                <h2 style={parseStyle("font-family: var(--font-display); font-size: 1.3rem; color: var(--color-primary-light); margin-bottom: var(--space-lg);")}>
                  Your Assigned Work
                </h2>
                
                {essaysLoading ? (
                  <p style={parseStyle("color: var(--color-text-muted);")}>Loading...</p>
                ) : (
                  <div className="essay-grid">
                    {assignedEssays.map(essay => (
                      <EssayCard key={essay.id} essay={essay} isAssigned={true} />
                    ))}
                  </div>
                )}
              </div>
            )}

            {assignedEssays.length === 0 && (
              <div style={parseStyle("text-align: center; padding: var(--space-2xl); background: var(--glass-bg); border-radius: var(--radius-lg); margin-bottom: var(--space-xl);")}>
                <p style={parseStyle("font-size: 1.1rem; color: var(--color-text-muted); margin-bottom: var(--space-md);")}>
                  No work has been assigned to you yet.
                </p>
                <p style={parseStyle("color: var(--color-text-muted);")}>
                  Your teacher will assign essays when they are ready. In the meantime, you can explore available essays below.
                </p>
              </div>
            )}

            {otherEssays.length > 0 && (
              <div>
                <div 
                  onClick={() => setShowExplore(!showExplore)}
                  style={parseStyle("display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: var(--space-md); background: var(--glass-bg); border-radius: var(--radius-md); margin-bottom: var(--space-lg);")}
                >
                  <h2 style={parseStyle("font-family: var(--font-display); font-size: 1.1rem; color: var(--color-text-muted); margin: 0;")}>
                    Explore Other Essays ({otherEssays.length})
                  </h2>
                  <span style={parseStyle("color: var(--color-text-muted); font-size: 1.2rem;")}>
                    {showExplore ? '[-]' : '[+]'}
                  </span>
                </div>
                
                {showExplore && (
                  <div className="essay-grid">
                    {otherEssays.map(essay => (
                      <EssayCard key={essay.id} essay={essay} isAssigned={false} />
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>

          {showPasswordModal && (
            <ChangePasswordModal 
              sessionToken={sessionToken}
              onClose={() => setShowPasswordModal(false)}
              onSuccess={() => {
                setShowPasswordModal(false);
                alert('Password changed successfully!');
              }}
            />
          )}
        </div>
      );
    }

    // =====================================================
    // CHANGE PASSWORD MODAL
    // =====================================================

    function ChangePasswordModal({ sessionToken, onClose, onSuccess }) {
      const [currentPassword, setCurrentPassword] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        if (!currentPassword || !newPassword || !confirmPassword) {
          setError('Please fill in all fields');
          return;
        }

        if (newPassword.length < 6) {
          setError('New password must be at least 6 characters');
          return;
        }

        if (newPassword !== confirmPassword) {
          setError('New passwords do not match');
          return;
        }

        setIsLoading(true);

        try {
          let result;
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            result = await FirebaseDB.changePassword(sessionToken, currentPassword, newPassword);
          } else {
            const response = await fetch('/.netlify/functions/student-auth', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: 'changePassword',
                sessionToken,
                currentPassword,
                newPassword
              })
            });
            result = await response.json();
          }

          if (result.success) {
            onSuccess();
          } else {
            setError(result.error || 'Failed to change password');
          }
        } catch (err) {
          setError('Unable to connect. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div style={parseStyle("position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg);")}>
          <div className="card" style={parseStyle("max-width: 400px; width: 100%;")}>
            <h2 style={parseStyle("font-family: var(--font-display); margin-bottom: var(--space-lg);")}>Change Password</h2>
            
            <form onSubmit={handleSubmit}>
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Current Password
                </label>
                <input
                  type="password"
                  value={currentPassword}
                  onChange={(e) => setCurrentPassword(e.target.value)}
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>

              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  New Password
                </label>
                <input
                  type="password"
                  value={newPassword}
                  onChange={(e) => setNewPassword(e.target.value)}
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>

              <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Confirm New Password
                </label>
                <input
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>

              {error && (
                <div style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-sm); color: var(--color-error); font-size: 0.9rem;")}>
                  {error}
                </div>
              )}

              <div style={parseStyle("display: flex; gap: var(--space-sm); justify-content: flex-end;")}>
                <button type="button" className="btn btn-secondary" onClick={onClose} disabled={isLoading}>
                  Cancel
                </button>
                <button type="submit" className="btn btn-primary" disabled={isLoading}>
                  {isLoading ? 'Saving...' : 'Change Password'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    // =====================================================
    // STUDENT PERFORMANCE PANEL (Teacher Dashboard)
    // =====================================================

    function StudentPerformancePanel() {
      const [students, setStudents] = useState([]);
      const [classes, setClasses] = useState([]);
      const [submissions, setSubmissions] = useState([]);
      const [progress, setProgress] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedClass, setSelectedClass] = useState('all');
      const [selectedEssay, setSelectedEssay] = useState('all');
      const [viewMode, setViewMode] = useState('by-essay'); // 'by-essay' or 'by-student'
      const [expandedEssay, setExpandedEssay] = useState(null);

      const loadData = async () => {
        setLoading(true);
        try {
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            const [studentList, classList, submissionList, progressList] = await Promise.all([
              FirebaseDB.getStudents(),
              FirebaseDB.getClasses(),
              FirebaseDB.getSubmissions(),
              FirebaseDB.getProgress()
            ]);
            setStudents(studentList || []);
            setClasses(classList || []);
            setSubmissions(submissionList || []);
            setProgress(progressList || []);
          } else {
            const [studentsRes, classesRes, submissionsRes, progressRes] = await Promise.all([
              fetch('/.netlify/functions/manage-students'),
              fetch('/.netlify/functions/manage-classes'),
              fetch('/.netlify/functions/get-submissions'),
              fetch('/.netlify/functions/save-progress')
            ]);
            const studentsData = await studentsRes.json();
            const classesData = await classesRes.json();
            const submissionsData = await submissionsRes.json();
            const progressData = await progressRes.json();
            if (studentsData.success) setStudents(studentsData.students || []);
            if (classesData.success) setClasses(classesData.classes || []);
            if (submissionsData.submissions) setSubmissions(submissionsData.submissions || []);
            if (progressData.inProgress) setProgress(progressData.inProgress || []);
          }
        } catch (err) {
          console.error('Load error:', err);
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadData();
      }, []);

      // Get students filtered by class
      const getFilteredStudents = () => {
        if (selectedClass === 'all') return students;
        return students.filter(s => {
          const studentClassIds = s.classIds || (s.classId ? [s.classId] : []);
          return studentClassIds.includes(selectedClass);
        });
      };

      // Get student emails for filtering
      const filteredStudentEmails = new Set(getFilteredStudents().map(s => s.email?.toLowerCase()));

      // Filter submissions by class (via student membership)
      const filteredSubmissions = selectedClass === 'all'
        ? submissions
        : submissions.filter(s => filteredStudentEmails.has(s.studentEmail?.toLowerCase()));

      // Filter progress by class
      const filteredProgress = selectedClass === 'all'
        ? progress
        : progress.filter(p => filteredStudentEmails.has(p.studentEmail?.toLowerCase()));

      // Get all available essays from submissions and progress
      const availableEssays = [...new Set([
        ...submissions.map(s => s.essayId).filter(Boolean),
        ...progress.map(p => p.essayId).filter(Boolean)
      ])];

      // Get essay info helper
      const getEssayInfo = (essayId) => {
        const essays = typeof getEssayList === 'function' ? getEssayList() : [];
        return essays.find(e => e.id === essayId) || { id: essayId, title: essayId, icon: '' };
      };

      // Calculate performance stats per essay
      const getEssayStats = (essayId) => {
        const essaySubmissions = filteredSubmissions.filter(s => s.essayId === essayId);
        const essayProgress = filteredProgress.filter(p => p.essayId === essayId);

        const completedStudents = essaySubmissions.length;
        const inProgressStudents = essayProgress.length;
        const totalAttempted = completedStudents + inProgressStudents;

        const scores = essaySubmissions.map(s => s.score).filter(s => typeof s === 'number');
        const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : null;
        const highestScore = scores.length > 0 ? Math.max(...scores) : null;
        const lowestScore = scores.length > 0 ? Math.min(...scores) : null;

        // Grade distribution
        const gradeDistribution = {};
        essaySubmissions.forEach(s => {
          const grade = s.grade || 'Ungraded';
          gradeDistribution[grade] = (gradeDistribution[grade] || 0) + 1;
        });

        return {
          completedStudents,
          inProgressStudents,
          totalAttempted,
          avgScore,
          highestScore,
          lowestScore,
          gradeDistribution,
          submissions: essaySubmissions,
          progress: essayProgress
        };
      };

      // Calculate student performance across all essays
      const getStudentStats = (studentEmail) => {
        const studentSubmissions = filteredSubmissions.filter(s => s.studentEmail?.toLowerCase() === studentEmail.toLowerCase());
        const studentProgress = filteredProgress.filter(p => p.studentEmail?.toLowerCase() === studentEmail.toLowerCase());

        const completedEssays = studentSubmissions.length;
        const inProgressEssays = studentProgress.length;

        const scores = studentSubmissions.map(s => s.score).filter(s => typeof s === 'number');
        const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : null;

        return {
          completedEssays,
          inProgressEssays,
          avgScore,
          submissions: studentSubmissions,
          progress: studentProgress
        };
      };

      // Get grade color
      const getGradeColor = (grade) => {
        if (!grade) return 'var(--color-text-muted)';
        const g = grade.toUpperCase();
        if (g.includes('A') || g === '9' || g === '8') return 'var(--color-success)';
        if (g.includes('B') || g === '7' || g === '6') return '#22d3ee';
        if (g.includes('C') || g === '5' || g === '4') return 'var(--color-warning)';
        return 'var(--color-error)';
      };

      // Get score color
      const getScoreColor = (score) => {
        if (score === null || score === undefined) return 'var(--color-text-muted)';
        if (score >= 80) return 'var(--color-success)';
        if (score >= 60) return '#22d3ee';
        if (score >= 40) return 'var(--color-warning)';
        return 'var(--color-error)';
      };

      if (loading) {
        return (
          <div className="card" style={parseStyle("padding: var(--space-xl); text-align: center;")}>
            <LoadingSpinner text="Loading performance data..." />
          </div>
        );
      }

      return (
        <div>
          {/* Filters */}
          <div className="card" style={parseStyle("margin-bottom: var(--space-lg);")}>
            <h4 style={parseStyle("margin-bottom: var(--space-md);")}>Student Performance Dashboard</h4>
            <div style={parseStyle("display: flex; gap: var(--space-lg); flex-wrap: wrap; align-items: flex-end;")}>
              {/* Class Filter */}
              <div>
                <label style={parseStyle("display: block; font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: var(--space-xs);")}>
                  Filter by Class
                </label>
                <select
                  value={selectedClass}
                  onChange={(e) => setSelectedClass(e.target.value)}
                  style={parseStyle("padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--color-border); background: var(--color-bg); color: var(--color-text); min-width: 200px;")}
                >
                  <option value="all">All Classes</option>
                  {classes.map(c => (
                    <option key={c.id} value={c.id}>{c.name} ({c.teacher || 'No teacher'})</option>
                  ))}
                </select>
              </div>

              {/* View Mode Toggle */}
              <div>
                <label style={parseStyle("display: block; font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: var(--space-xs);")}>
                  View Mode
                </label>
                <div style={parseStyle("display: flex; gap: var(--space-xs);")}>
                  <button
                    className={viewMode === 'by-essay' ? 'btn btn-primary' : 'btn btn-secondary'}
                    onClick={() => setViewMode('by-essay')}
                    style={parseStyle("padding: var(--space-xs) var(--space-md); font-size: 0.9rem;")}
                  >
                    By Essay
                  </button>
                  <button
                    className={viewMode === 'by-student' ? 'btn btn-primary' : 'btn btn-secondary'}
                    onClick={() => setViewMode('by-student')}
                    style={parseStyle("padding: var(--space-xs) var(--space-md); font-size: 0.9rem;")}
                  >
                    By Student
                  </button>
                  <button
                    className={viewMode === 'grades-table' ? 'btn btn-primary' : 'btn btn-secondary'}
                    onClick={() => setViewMode('grades-table')}
                    style={parseStyle("padding: var(--space-xs) var(--space-md); font-size: 0.9rem;")}
                  >
                    Grades Table
                  </button>
                </div>
              </div>

              {/* Refresh Button */}
              <button className="btn btn-secondary" onClick={loadData} style={parseStyle("padding: var(--space-sm) var(--space-md);")}>
                Refresh
              </button>
            </div>
          </div>

          {/* Summary Stats */}
          <div className="card" style={parseStyle("margin-bottom: var(--space-lg);")}>
            <h4 style={parseStyle("margin-bottom: var(--space-md);")}>Overview</h4>
            <div style={parseStyle("display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-md);")}>
              <div style={parseStyle("text-align: center; padding: var(--space-md); background: var(--color-bg); border-radius: var(--radius-md);")}>
                <div style={parseStyle("font-size: 2rem; font-weight: 700; color: var(--color-primary);")}>{getFilteredStudents().length}</div>
                <div style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted);")}>Total Students</div>
              </div>
              <div style={parseStyle("text-align: center; padding: var(--space-md); background: var(--color-bg); border-radius: var(--radius-md);")}>
                <div style={parseStyle("font-size: 2rem; font-weight: 700; color: var(--color-success);")}>{filteredSubmissions.length}</div>
                <div style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted);")}>Completed Essays</div>
              </div>
              <div style={parseStyle("text-align: center; padding: var(--space-md); background: var(--color-bg); border-radius: var(--radius-md);")}>
                <div style={parseStyle("font-size: 2rem; font-weight: 700; color: var(--color-warning);")}>{filteredProgress.length}</div>
                <div style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted);")}>In Progress</div>
              </div>
              <div style={parseStyle("text-align: center; padding: var(--space-md); background: var(--color-bg); border-radius: var(--radius-md);")}>
                <div style={parseStyle("font-size: 2rem; font-weight: 700; color: var(--color-info);")}>{availableEssays.length}</div>
                <div style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted);")}>Essays Attempted</div>
              </div>
            </div>
          </div>

          {/* By Essay View */}
          {viewMode === 'by-essay' && (
            <div>
              {availableEssays.length === 0 ? (
                <div className="card" style={parseStyle("padding: var(--space-xl); text-align: center; color: var(--color-text-muted);")}>
                  No essays have been attempted yet.
                </div>
              ) : (
                availableEssays.map(essayId => {
                  const essayInfo = getEssayInfo(essayId);
                  const stats = getEssayStats(essayId);
                  const isExpanded = expandedEssay === essayId;

                  return (
                    <div key={essayId} className="card" style={parseStyle("margin-bottom: var(--space-md);")}>
                      {/* Essay Header */}
                      <div
                        style={parseStyle("display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: var(--space-sm);") }
                        onClick={() => setExpandedEssay(isExpanded ? null : essayId)}
                      >
                        <div style={parseStyle("display: flex; align-items: center; gap: var(--space-md);")}>
                          <span style={parseStyle("font-size: 1.5rem;")}>{essayInfo.icon}</span>
                          <div>
                            <h4 style={parseStyle("margin: 0;")}>{essayInfo.title || essayId}</h4>
                            <div style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted);")}>
                              {stats.completedStudents} completed, {stats.inProgressStudents} in progress
                            </div>
                          </div>
                        </div>
                        <div style={parseStyle("display: flex; align-items: center; gap: var(--space-lg);")}>
                          {stats.avgScore !== null && (
                            <div style={parseStyle("text-align: center;")}>
                              <div style={{ fontSize: '1.25rem', fontWeight: '700', color: getScoreColor(stats.avgScore) }}>{stats.avgScore}%</div>
                              <div style={parseStyle("font-size: 0.75rem; color: var(--color-text-muted);")}>Avg Score</div>
                            </div>
                          )}
                          <div style={parseStyle("font-size: 1.2rem; color: var(--color-text-muted);")}>
                            {isExpanded ? '' : ''}
                          </div>
                        </div>
                      </div>

                      {/* Expanded Details */}
                      {isExpanded && (
                        <div style={parseStyle("margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--color-border);")}>
                          {/* Stats Row */}
                          <div style={parseStyle("display: flex; gap: var(--space-lg); margin-bottom: var(--space-lg); flex-wrap: wrap;")}>
                            {stats.highestScore !== null && (
                              <div>
                                <span style={parseStyle("color: var(--color-text-muted); font-size: 0.85rem;")}>Highest: </span>
                                <span style={{ fontWeight: '600', color: getScoreColor(stats.highestScore) }}>{stats.highestScore}%</span>
                              </div>
                            )}
                            {stats.lowestScore !== null && (
                              <div>
                                <span style={parseStyle("color: var(--color-text-muted); font-size: 0.85rem;")}>Lowest: </span>
                                <span style={{ fontWeight: '600', color: getScoreColor(stats.lowestScore) }}>{stats.lowestScore}%</span>
                              </div>
                            )}
                            {Object.keys(stats.gradeDistribution).length > 0 && (
                              <div>
                                <span style={parseStyle("color: var(--color-text-muted); font-size: 0.85rem;")}>Grades: </span>
                                {Object.entries(stats.gradeDistribution).map(([grade, count], i) => (
                                  <span key={grade} style={{ marginLeft: i > 0 ? '8px' : '0', color: getGradeColor(grade) }}>
                                    {grade}: {count}
                                  </span>
                                ))}
                              </div>
                            )}
                          </div>

                          {/* Completed Students Table */}
                          {stats.submissions.length > 0 && (
                            <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                              <h5 style={parseStyle("margin-bottom: var(--space-sm); color: var(--color-success);")}>Completed ({stats.submissions.length})</h5>
                              <div style={parseStyle("overflow-x: auto;")}>
                                <table style={parseStyle("width: 100%; border-collapse: collapse; font-size: 0.9rem;")}>
                                  <thead>
                                    <tr style={parseStyle("border-bottom: 1px solid var(--color-border);")}>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: left;")}>Student</th>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: left;")}>Email</th>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: center;")}>Score</th>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: center;")}>Grade</th>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: left;")}>Submitted</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {stats.submissions.map((sub, idx) => (
                                      <tr key={idx} style={parseStyle("border-bottom: 1px solid var(--color-border-light);")}>
                                        <td style={parseStyle("padding: var(--space-sm);")}>{sub.studentName || '-'}</td>
                                        <td style={parseStyle("padding: var(--space-sm); color: var(--color-text-muted);")}>{sub.studentEmail || '-'}</td>
                                        <td style={{ padding: 'var(--space-sm)', textAlign: 'center', fontWeight: '600', color: getScoreColor(sub.score) }}>
                                          {sub.score !== undefined ? `${sub.score}%` : '-'}
                                        </td>
                                        <td style={{ padding: 'var(--space-sm)', textAlign: 'center', fontWeight: '600', color: getGradeColor(sub.grade) }}>
                                          {sub.grade || '-'}
                                        </td>
                                        <td style={parseStyle("padding: var(--space-sm); color: var(--color-text-muted);")}>
                                          {sub.submittedAt ? formatDateTime(sub.submittedAt) : '-'}
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          )}

                          {/* In Progress Students Table */}
                          {stats.progress.length > 0 && (
                            <div>
                              <h5 style={parseStyle("margin-bottom: var(--space-sm); color: var(--color-warning);")}>In Progress ({stats.progress.length})</h5>
                              <div style={parseStyle("overflow-x: auto;")}>
                                <table style={parseStyle("width: 100%; border-collapse: collapse; font-size: 0.9rem;")}>
                                  <thead>
                                    <tr style={parseStyle("border-bottom: 1px solid var(--color-border);")}>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: left;")}>Student</th>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: left;")}>Email</th>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: center;")}>Progress</th>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: left;")}>Current Section</th>
                                      <th style={parseStyle("padding: var(--space-sm); text-align: left;")}>Last Active</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {stats.progress.map((prog, idx) => (
                                      <tr key={idx} style={parseStyle("border-bottom: 1px solid var(--color-border-light);")}>
                                        <td style={parseStyle("padding: var(--space-sm);")}>{prog.studentName || '-'}</td>
                                        <td style={parseStyle("padding: var(--space-sm); color: var(--color-text-muted);")}>{prog.studentEmail || '-'}</td>
                                        <td style={parseStyle("padding: var(--space-sm); text-align: center;")}>
                                          <div style={parseStyle("display: flex; align-items: center; justify-content: center; gap: var(--space-xs);")}>
                                            <div style={parseStyle("width: 60px; height: 6px; background: var(--color-border); border-radius: 3px; overflow: hidden;")}>
                                              <div style={{ width: `${prog.percentComplete || 0}%`, height: '100%', background: 'var(--color-warning)', borderRadius: '3px' }} />
                                            </div>
                                            <span style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted);")}>
                                              {prog.completedParagraphs || 0}/{prog.totalParagraphs || '?'}
                                            </span>
                                          </div>
                                        </td>
                                        <td style={parseStyle("padding: var(--space-sm); color: var(--color-text-muted);")}>
                                          {prog.currentParagraph || `Paragraph ${prog.currentParagraphIndex || 1}`}
                                        </td>
                                        <td style={parseStyle("padding: var(--space-sm); color: var(--color-text-muted);")}>
                                          {prog.lastUpdate ? formatDateTime(prog.lastUpdate) : '-'}
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })
              )}
            </div>
          )}

          {/* By Student View */}
          {viewMode === 'by-student' && (
            <div className="card">
              <h4 style={parseStyle("margin-bottom: var(--space-md);")}>Student Performance</h4>
              {getFilteredStudents().length === 0 ? (
                <p style={parseStyle("color: var(--color-text-muted); text-align: center; padding: var(--space-lg);")}>
                  No students found{selectedClass !== 'all' ? ' in this class' : ''}.
                </p>
              ) : (
                <div style={parseStyle("overflow-x: auto;")}>
                  <table style={parseStyle("width: 100%; border-collapse: collapse;")}>
                    <thead>
                      <tr style={parseStyle("border-bottom: 2px solid var(--color-border);")}>
                        <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Student</th>
                        <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Email</th>
                        <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Class</th>
                        <th style={parseStyle("padding: var(--space-md); text-align: center;")}>Completed</th>
                        <th style={parseStyle("padding: var(--space-md); text-align: center;")}>In Progress</th>
                        <th style={parseStyle("padding: var(--space-md); text-align: center;")}>Avg Score</th>
                      </tr>
                    </thead>
                    <tbody>
                      {getFilteredStudents().map((student, idx) => {
                        const stats = getStudentStats(student.email);
                        const studentClasses = classes.filter(c => {
                          const studentClassIds = student.classIds || (student.classId ? [student.classId] : []);
                          return studentClassIds.includes(c.id);
                        });

                        return (
                          <tr key={idx} style={parseStyle("border-bottom: 1px solid var(--color-border-light);")}>
                            <td style={parseStyle("padding: var(--space-md);")}>{student.name || '-'}</td>
                            <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted); font-size: 0.85rem;")}>{student.email || '-'}</td>
                            <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted); font-size: 0.85rem;")}>
                              {studentClasses.map(c => c.name).join(', ') || '-'}
                            </td>
                            <td style={parseStyle("padding: var(--space-md); text-align: center;")}>
                              {stats.completedEssays > 0 ? (
                                <span style={parseStyle("color: var(--color-success); font-weight: 600;")}>{stats.completedEssays}</span>
                              ) : (
                                <span style={parseStyle("color: var(--color-text-muted);")}>0</span>
                              )}
                            </td>
                            <td style={parseStyle("padding: var(--space-md); text-align: center;")}>
                              {stats.inProgressEssays > 0 ? (
                                <span style={parseStyle("color: var(--color-warning); font-weight: 600;")}>{stats.inProgressEssays}</span>
                              ) : (
                                <span style={parseStyle("color: var(--color-text-muted);")}>0</span>
                              )}
                            </td>
                            <td style={{ padding: 'var(--space-md)', textAlign: 'center', fontWeight: stats.avgScore !== null ? '600' : 'normal', color: getScoreColor(stats.avgScore) }}>
                              {stats.avgScore !== null ? `${stats.avgScore}%` : '-'}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* Grades Table View */}
          {viewMode === 'grades-table' && (
            <div className="card">
              <h4 style={parseStyle("margin-bottom: var(--space-md);")}>Comprehensive Grades Table</h4>
              <p style={parseStyle("color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: var(--space-lg);")}>
                Showing 1st draft and final draft scores for assigned essays. {selectedClass !== 'all' && 'Students who have not attempted any essays are also shown.'}
              </p>

              {(() => {
                // Get students to display - when class filtered, show ALL class members
                const studentsToShow = getFilteredStudents();

                // Get assigned essays based on filter
                let assignedEssayIds = [];

                if (selectedClass !== 'all') {
                  // Get essays assigned to the selected class
                  const selectedClassData = classes.find(c => c.id === selectedClass);
                  const classAssignedEssays = selectedClassData?.assignedEssays || [];

                  // Also get individual assignments for students in this class
                  const individualAssignments = studentsToShow.flatMap(s => s.individualAssignments || []);

                  assignedEssayIds = [...new Set([...classAssignedEssays, ...individualAssignments])];
                } else {
                  // Get all essays assigned to any class
                  const allClassAssignments = classes.flatMap(c => c.assignedEssays || []);

                  // Get all individual assignments
                  const allIndividualAssignments = students.flatMap(s => s.individualAssignments || []);

                  assignedEssayIds = [...new Set([...allClassAssignments, ...allIndividualAssignments])];
                }

                // If no assignments yet, show message
                if (assignedEssayIds.length === 0) {
                  return (
                    <p style={parseStyle("color: var(--color-text-muted); text-align: center; padding: var(--space-lg);")}>
                      No essays have been assigned yet. Assign essays in the Assignments tab.
                    </p>
                  );
                }

                // Build a map of student email -> essay submissions for quick lookup
                const studentSubmissionMap = {};
                const studentProgressMap = {};

                submissions.forEach(sub => {
                  const email = sub.studentEmail?.toLowerCase();
                  if (!email) return;
                  if (!studentSubmissionMap[email]) studentSubmissionMap[email] = {};
                  studentSubmissionMap[email][sub.essayId] = sub;
                });

                progress.forEach(prog => {
                  const email = prog.studentEmail?.toLowerCase();
                  if (!email) return;
                  if (!studentProgressMap[email]) studentProgressMap[email] = {};
                  studentProgressMap[email][prog.essayId] = prog;
                });

                // Check if student has any activity on assigned essays
                const hasAnyActivity = (email) => {
                  const emailLower = email?.toLowerCase();
                  const subs = studentSubmissionMap[emailLower] || {};
                  const prog = studentProgressMap[emailLower] || {};
                  // Check if they have activity on any of the assigned essays
                  return assignedEssayIds.some(essayId => subs[essayId] || prog[essayId]);
                };

                // Students with no activity on assigned essays (only shown when class filtered)
                const studentsWithNoActivity = selectedClass !== 'all'
                  ? studentsToShow.filter(s => !hasAnyActivity(s.email))
                  : [];

                return (
                  <div style={parseStyle("overflow-x: auto;")}>
                    <table style={parseStyle("width: 100%; border-collapse: collapse; font-size: 0.85rem;")}>
                      <thead>
                        <tr style={parseStyle("border-bottom: 2px solid var(--color-border);")}>
                          <th style={parseStyle("padding: var(--space-sm); text-align: left; position: sticky; left: 0; background: var(--color-surface); min-width: 150px;")}>Student</th>
                          {assignedEssayIds.map(essayId => {
                            const essayInfo = getEssayInfo(essayId);
                            return (
                              <th key={essayId} colSpan="2" style={parseStyle("padding: var(--space-sm); text-align: center; border-left: 2px solid var(--color-border);")}>
                                <div style={parseStyle("font-size: 0.8rem;")}>{essayInfo.icon}</div>
                                <div style={parseStyle("max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;")} title={essayInfo.title}>
                                  {essayInfo.title || essayId}
                                </div>
                              </th>
                            );
                          })}
                        </tr>
                        <tr style={parseStyle("border-bottom: 1px solid var(--color-border); background: var(--color-bg);")}>
                          <th style={parseStyle("padding: var(--space-xs); position: sticky; left: 0; background: var(--color-bg);")}></th>
                          {assignedEssayIds.map(essayId => (
                            <React.Fragment key={essayId}>
                              <th style={parseStyle("padding: var(--space-xs); text-align: center; font-size: 0.75rem; color: var(--color-text-muted); border-left: 2px solid var(--color-border);")}>1st Draft</th>
                              <th style={parseStyle("padding: var(--space-xs); text-align: center; font-size: 0.75rem; color: var(--color-text-muted);")}>Final</th>
                            </React.Fragment>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {studentsToShow.length === 0 ? (
                          <tr>
                            <td colSpan={1 + assignedEssayIds.length * 2} style={parseStyle("padding: var(--space-lg); text-align: center; color: var(--color-text-muted);")}>
                              No students found{selectedClass !== 'all' ? ' in this class' : ''}.
                            </td>
                          </tr>
                        ) : (
                          studentsToShow.map((student, idx) => {
                            const emailLower = student.email?.toLowerCase();
                            const studentSubs = studentSubmissionMap[emailLower] || {};
                            const studentProg = studentProgressMap[emailLower] || {};
                            const noActivity = !hasAnyActivity(student.email);

                            return (
                              <tr
                                key={idx}
                                style={{
                                  borderBottom: '1px solid var(--color-border-light)',
                                  background: noActivity ? 'rgba(239, 68, 68, 0.1)' : 'transparent'
                                }}
                              >
                                <td style={parseStyle("padding: var(--space-sm); position: sticky; left: 0; background: inherit;")}>
                                  <div style={parseStyle("font-weight: 500;")}>{student.name || '-'}</div>
                                  <div style={parseStyle("font-size: 0.75rem; color: var(--color-text-muted);")}>{student.email || '-'}</div>
                                  {noActivity && (
                                    <div style={parseStyle("font-size: 0.7rem; color: var(--color-error); font-style: italic;")}>No attempts</div>
                                  )}
                                </td>
                                {assignedEssayIds.map(essayId => {
                                  const submission = studentSubs[essayId];
                                  const inProgress = studentProg[essayId];

                                  // Get 1st draft and final scores
                                  let firstDraftScore = null;
                                  let firstDraftGrade = null;
                                  let finalScore = null;
                                  let finalGrade = null;

                                  if (submission) {
                                    // Check for official grading first (more accurate)
                                    if (submission.officialGrading) {
                                      if (submission.officialGrading.initialVersion) {
                                        firstDraftScore = submission.officialGrading.initialVersion.percentage || submission.officialGrading.initialVersion.totalMark;
                                        firstDraftGrade = submission.officialGrading.initialVersion.grade;
                                      }
                                      if (submission.officialGrading.improvedVersion) {
                                        finalScore = submission.officialGrading.improvedVersion.percentage || submission.officialGrading.improvedVersion.totalMark;
                                        finalGrade = submission.officialGrading.improvedVersion.grade;
                                      }
                                    }
                                    // Fallback to general score/grade if no official grading
                                    if (finalScore === null && submission.score !== undefined) {
                                      finalScore = submission.score;
                                      finalGrade = submission.grade;
                                    }
                                  }

                                  return (
                                    <React.Fragment key={essayId}>
                                      {/* 1st Draft */}
                                      <td style={parseStyle("padding: var(--space-xs); text-align: center; border-left: 2px solid var(--color-border);")}>
                                        {submission ? (
                                          firstDraftScore !== null ? (
                                            <div>
                                              <div style={{ fontWeight: '600', color: getScoreColor(firstDraftScore) }}>
                                                {typeof firstDraftScore === 'number' && firstDraftScore <= 100 ? `${firstDraftScore}%` : firstDraftScore}
                                              </div>
                                              {firstDraftGrade && (
                                                <div style={{ fontSize: '0.7rem', color: getGradeColor(firstDraftGrade) }}>{firstDraftGrade}</div>
                                              )}
                                            </div>
                                          ) : (
                                            <span style={parseStyle("color: var(--color-text-muted); font-size: 0.75rem;")}>N/A</span>
                                          )
                                        ) : inProgress ? (
                                          <span style={parseStyle("color: var(--color-warning); font-size: 0.75rem;")}>In progress</span>
                                        ) : (
                                          <span style={parseStyle("color: var(--color-text-muted);")}>-</span>
                                        )}
                                      </td>
                                      {/* Final */}
                                      <td style={parseStyle("padding: var(--space-xs); text-align: center;")}>
                                        {submission ? (
                                          finalScore !== null ? (
                                            <div>
                                              <div style={{ fontWeight: '600', color: getScoreColor(finalScore) }}>
                                                {typeof finalScore === 'number' && finalScore <= 100 ? `${finalScore}%` : finalScore}
                                              </div>
                                              {finalGrade && (
                                                <div style={{ fontSize: '0.7rem', color: getGradeColor(finalGrade) }}>{finalGrade}</div>
                                              )}
                                            </div>
                                          ) : (
                                            <span style={parseStyle("color: var(--color-text-muted); font-size: 0.75rem;")}>N/A</span>
                                          )
                                        ) : inProgress ? (
                                          <div>
                                            <div style={parseStyle("width: 40px; height: 4px; background: var(--color-border); border-radius: 2px; margin: 0 auto;")}>
                                              <div style={{ width: `${inProgress.percentComplete || 0}%`, height: '100%', background: 'var(--color-warning)', borderRadius: '2px' }} />
                                            </div>
                                            <div style={parseStyle("font-size: 0.65rem; color: var(--color-warning);")}>
                                              {inProgress.percentComplete || 0}%
                                            </div>
                                          </div>
                                        ) : (
                                          <span style={parseStyle("color: var(--color-text-muted);")}>-</span>
                                        )}
                                      </td>
                                    </React.Fragment>
                                  );
                                })}
                              </tr>
                            );
                          })
                        )}
                      </tbody>
                    </table>

                    {/* Legend */}
                    <div style={parseStyle("margin-top: var(--space-lg); padding-top: var(--space-md); border-top: 1px solid var(--color-border);")}>
                      <div style={parseStyle("display: flex; gap: var(--space-lg); flex-wrap: wrap; font-size: 0.8rem;")}>
                        <div style={parseStyle("display: flex; align-items: center; gap: var(--space-xs);")}>
                          <span style={parseStyle("color: var(--color-success);")}></span> 80%+ (Excellent)
                        </div>
                        <div style={parseStyle("display: flex; align-items: center; gap: var(--space-xs);")}>
                          <span style={{ color: '#22d3ee' }}></span> 60-79% (Good)
                        </div>
                        <div style={parseStyle("display: flex; align-items: center; gap: var(--space-xs);")}>
                          <span style={parseStyle("color: var(--color-warning);")}></span> 40-59% (Developing)
                        </div>
                        <div style={parseStyle("display: flex; align-items: center; gap: var(--space-xs);")}>
                          <span style={parseStyle("color: var(--color-error);")}></span> Below 40% (Needs Support)
                        </div>
                        {selectedClass !== 'all' && studentsWithNoActivity.length > 0 && (
                          <div style={parseStyle("display: flex; align-items: center; gap: var(--space-xs);")}>
                            <span style={parseStyle("display: inline-block; width: 12px; height: 12px; background: rgba(239, 68, 68, 0.2); border: 1px solid var(--color-error);")}></span> No attempts ({studentsWithNoActivity.length} students)
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>
          )}
        </div>
      );
    }

    // =====================================================
    // STUDENT MANAGEMENT PANEL (Teacher Dashboard)
    // =====================================================

    function StudentManagementPanel() {
      const [students, setStudents] = useState([]);
      const [classes, setClasses] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedClass, setSelectedClass] = useState('');
      const [showAddStudent, setShowAddStudent] = useState(false);
      const [showImportCSV, setShowImportCSV] = useState(false);
      const [showAddClass, setShowAddClass] = useState(false);
      const [searchTerm, setSearchTerm] = useState('');

      const loadData = async () => {
        setLoading(true);
        try {
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            const [studentList, classList] = await Promise.all([
              FirebaseDB.getStudents(),
              FirebaseDB.getClasses()
            ]);
            setStudents(studentList);
            setClasses(classList);
          } else {
            const [studentsRes, classesRes] = await Promise.all([
              fetch('/.netlify/functions/manage-students'),
              fetch('/.netlify/functions/manage-classes')
            ]);
            const studentsData = await studentsRes.json();
            const classesData = await classesRes.json();
            if (studentsData.success) setStudents(studentsData.students || []);
            if (classesData.success) setClasses(classesData.classes || []);
          }
        } catch (err) {
          console.error('Load error:', err);
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadData();
      }, []);

      const filteredStudents = students.filter(s => {
        const matchesSearch = !searchTerm || 
          (s.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
          (s.email || '').toLowerCase().includes(searchTerm.toLowerCase());
        // Support both old classId format and new classIds array
        const studentClassIds = s.classIds || (s.classId ? [s.classId] : []);
        const matchesClass = !selectedClass || studentClassIds.includes(selectedClass);
        return matchesSearch && matchesClass;
      });

      const handleResetPassword = async (email) => {
        if (!confirm('Reset password for ' + email + '?')) return;
        
        try {
          let result;
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            result = await FirebaseDB.resetStudentPassword(email);
          } else {
            const response = await fetch('/.netlify/functions/manage-students', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'resetPassword', email })
            });
            result = await response.json();
          }
          
          if (result.success) {
            alert('Password reset!\n\nNew password: ' + result.newPassword + '\n\nPlease give this to the student.');
          } else {
            alert('Failed to reset password: ' + (result.error || 'Unknown error'));
          }
        } catch (err) {
          alert('Error resetting password');
        }
      };

      const handleDeleteStudent = async (email, name) => {
        if (!confirm('Delete ' + name + ' (' + email + ')? This cannot be undone.')) return;
        
        try {
          let result;
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            result = await FirebaseDB.deleteStudent(email);
          } else {
            const response = await fetch('/.netlify/functions/manage-students?email=' + encodeURIComponent(email), {
              method: 'DELETE'
            });
            result = await response.json();
          }
          
          if (result.success) {
            setStudents(students.filter(s => s.email !== email));
          } else {
            alert('Failed to delete: ' + (result.error || 'Unknown error'));
          }
        } catch (err) {
          alert('Error deleting student');
        }
      };

      if (loading) {
        return <div className="card"><p style={parseStyle("text-align: center; padding: var(--space-xl);")}> Loading students...</p></div>;
      }

      return (
        <div className="card">
          <div style={parseStyle("display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-md);")}>
            <h2 style={parseStyle("font-family: var(--font-display); margin: 0;")}>
              Students ({filteredStudents.length})
            </h2>
            <div style={parseStyle("display: flex; gap: var(--space-sm); flex-wrap: wrap;")}>
              <button className="btn btn-secondary" onClick={() => setShowAddClass(true)}>
                + Add Class
              </button>
              <button className="btn btn-secondary" onClick={() => setShowImportCSV(true)}>
                Import CSV
              </button>
              <button className="btn btn-primary" onClick={() => setShowAddStudent(true)}>
                + Add Student
              </button>
            </div>
          </div>

          <div style={parseStyle("display: flex; gap: var(--space-md); margin-bottom: var(--space-lg); flex-wrap: wrap;")}>
            <input
              type="text"
              placeholder="Search by name or email..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="paragraph-editor"
              style={parseStyle("min-height: auto; padding: var(--space-sm); flex: 1; min-width: 200px;")}
            />
            <select
              value={selectedClass}
              onChange={(e) => setSelectedClass(e.target.value)}
              style={parseStyle("padding: var(--space-sm) var(--space-md); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text);")}
            >
              <option value="">All Classes</option>
              {classes.map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
          </div>

          <div style={parseStyle("overflow-x: auto;")}>
            <table style={parseStyle("width: 100%; border-collapse: collapse;")}>
              <thead>
                <tr style={parseStyle("border-bottom: 2px solid var(--color-border);")}>
                  <th style={parseStyle("text-align: left; padding: var(--space-md); color: var(--color-text-muted);")}>Name</th>
                  <th style={parseStyle("text-align: left; padding: var(--space-md); color: var(--color-text-muted);")}>Email</th>
                  <th style={parseStyle("text-align: left; padding: var(--space-md); color: var(--color-text-muted);")}>Classes</th>
                  <th style={parseStyle("text-align: left; padding: var(--space-md); color: var(--color-text-muted);")}>Last Login</th>
                  <th style={parseStyle("text-align: right; padding: var(--space-md); color: var(--color-text-muted);")}>Actions</th>
                </tr>
              </thead>
              <tbody>
                {filteredStudents.map(student => (
                  <tr key={student.email} style={parseStyle("border-bottom: 1px solid var(--color-border);")}>
                    <td style={parseStyle("padding: var(--space-md);")}>{student.name}</td>
                    <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted); font-size: 0.9rem;")}>{student.email}</td>
                    <td style={parseStyle("padding: var(--space-md); font-size: 0.9rem;")}>
                      {(student.classNames?.length > 0 || student.className) 
                        ? (student.classNames || [student.className]).filter(Boolean).join(', ')
                        : '-'}
                    </td>
                    <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted); font-size: 0.85rem;")}>
                      {student.lastLogin ? new Date(student.lastLogin).toLocaleDateString() : 'Never'}
                    </td>
                    <td style={parseStyle("padding: var(--space-md); text-align: right;")}>
                      <button 
                        onClick={() => handleResetPassword(student.email)}
                        className="btn btn-secondary"
                        style={parseStyle("font-size: 0.8rem; padding: var(--space-xs) var(--space-sm); margin-right: var(--space-xs);")}
                        title="Reset Password"
                      >
                        Reset PW
                      </button>
                      <button 
                        onClick={() => handleDeleteStudent(student.email, student.name)}
                        className="btn btn-secondary"
                        style={parseStyle("font-size: 0.8rem; padding: var(--space-xs) var(--space-sm); color: var(--color-error);")}
                        title="Delete Student"
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {filteredStudents.length === 0 && (
            <div style={parseStyle("text-align: center; padding: var(--space-xl); color: var(--color-text-muted);")}>
              No students found. Add students using the buttons above.
            </div>
          )}

          {showAddStudent && (
            <AddStudentModal 
              classes={classes}
              onClose={() => setShowAddStudent(false)}
              onSuccess={(newStudent, password) => {
                setStudents([...students, newStudent]);
                setShowAddStudent(false);
                alert('Student created!\n\nPassword: ' + password + '\n\nPlease give this to the student.');
              }}
            />
          )}

          {showImportCSV && (
            <ImportCSVModal
              classes={classes}
              onClose={() => setShowImportCSV(false)}
              onSuccess={() => {
                loadData();
                setShowImportCSV(false);
              }}
            />
          )}

          {showAddClass && (
            <AddClassModal
              onClose={() => setShowAddClass(false)}
              onSuccess={(newClass) => {
                setClasses([...classes, newClass]);
                setShowAddClass(false);
              }}
            />
          )}
        </div>
      );
    }
    
    // =====================================================
    // ADD STUDENT MODAL
    // =====================================================
    
    function AddStudentModal({ classes, onClose, onSuccess }) {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [selectedClassIds, setSelectedClassIds] = useState([]);
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const toggleClass = (classId) => {
        if (selectedClassIds.includes(classId)) {
          setSelectedClassIds(selectedClassIds.filter(id => id !== classId));
        } else {
          setSelectedClassIds([...selectedClassIds, classId]);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        if (!name || !email) {
          setError('Name and email are required');
          return;
        }

        setIsLoading(true);

        try {
          let result;
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            result = await FirebaseDB.createStudent({
              name, email, classIds: selectedClassIds, password: password || null
            });
          } else {
            const response = await fetch('/.netlify/functions/manage-students', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: 'create', name, email, classIds: selectedClassIds, password: password || null
              })
            });
            result = await response.json();
          }

          if (result.success) {
            onSuccess(result.student, result.generatedPassword);
          } else {
            setError(result.error || 'Failed to create student');
          }
        } catch (err) {
          setError('Unable to connect. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div style={parseStyle("position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg);")}>
          <div className="card" style={parseStyle("max-width: 450px; width: 100%;")}>
            <h2 style={parseStyle("font-family: var(--font-display); margin-bottom: var(--space-lg);")}>Add Student</h2>
            
            <form onSubmit={handleSubmit}>
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Full Name *</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="e.g. John Smith"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                />
              </div>

              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Email *</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="e.g. jsmith@bb-hs.co.uk"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                />
              </div>

              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Classes (select multiple)</label>
                <div style={parseStyle("max-height: 150px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-sm);")}>
                  {classes.length === 0 ? (
                    <p style={parseStyle("color: var(--color-text-muted); font-size: 0.9rem;")}>No classes created yet</p>
                  ) : (
                    classes.map(c => (
                      <label key={c.id} style={parseStyle("display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-xs) 0; cursor: pointer;")}>
                        <input
                          type="checkbox"
                          checked={selectedClassIds.includes(c.id)}
                          onChange={() => toggleClass(c.id)}
                          style={parseStyle("width: 18px; height: 18px; cursor: pointer;")}
                        />
                        <span>{c.name}</span>
                      </label>
                    ))
                  )}
                </div>
                {selectedClassIds.length > 0 && (
                  <p style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted); margin-top: var(--space-xs);")}>
                    Selected: {selectedClassIds.length} class{selectedClassIds.length !== 1 ? 'es' : ''}
                  </p>
                )}
              </div>

              <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Password (optional)</label>
                <input
                  type="text"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="Leave blank to auto-generate"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                />
                <p style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted); margin-top: var(--space-xs);")}>
                  If left blank, a random password will be generated.
                </p>
              </div>

              {error && (
                <div style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-sm); color: var(--color-error);")}>
                  {error}
                </div>
              )}

              <div style={parseStyle("display: flex; gap: var(--space-sm); justify-content: flex-end;")}>
                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                <button type="submit" className="btn btn-primary" disabled={isLoading}>
                  {isLoading ? 'Creating...' : 'Add Student'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    // =====================================================
    // IMPORT CSV MODAL
    // =====================================================
    
    function ImportCSVModal({ classes, onClose, onSuccess }) {
      const [csvContent, setCsvContent] = useState('');
      const [selectedClassIds, setSelectedClassIds] = useState([]);
      const [results, setResults] = useState(null);
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const toggleClass = (classId) => {
        if (selectedClassIds.includes(classId)) {
          setSelectedClassIds(selectedClassIds.filter(id => id !== classId));
        } else {
          setSelectedClassIds([...selectedClassIds, classId]);
        }
      };

      const parseCSV = (content) => {
        // Split on newlines (handle Windows \r\n and Unix \n)
        const lines = content.trim().split(/\r?\n/);
        console.log('CSV parsing - lines found:', lines.length);
        if (lines.length < 2) return [];
        
        // Parse headers - normalize to lowercase, remove quotes and spaces
        const headers = lines[0].split(',').map(h => 
          h.trim().toLowerCase().replace(/['"]/g, '').replace(/\s+/g, '')
        );
        console.log('CSV headers:', headers);
        
        const students = [];
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = lines[i].split(',').map(v => v.trim().replace(/^["']|["']$/g, ''));
          
          const student = {};
          headers.forEach((header, idx) => {
            if (values[idx]) student[header] = values[idx];
          });
          
          console.log('Parsed student row:', student);
          
          if (student.email && (student.name || student.fullname || student.studentname)) {
            student.name = student.name || student.fullname || student.studentname;
            student.yearGroup = student.yeargroup || student.year || null;
            // Capture class column (can be "class" or "classes")
            student.class = student.class || student.classes || null;
            students.push(student);
          }
        }
        console.log('Valid students found:', students.length);
        return students;
      };

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          setCsvContent(event.target.result);
        };
        reader.readAsText(file);
      };

      const handleImport = async () => {
        setError('');
        setResults(null);

        if (!csvContent.trim()) {
          setError('Please paste CSV content or upload a file');
          return;
        }

        const parsedStudents = parseCSV(csvContent);
        if (parsedStudents.length === 0) {
          setError('No valid students found. CSV must have "email" and "name" columns.');
          return;
        }

        setIsLoading(true);

        try {
          let result;
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            // Pass classes array so importStudents can look up class names from CSV
            result = await FirebaseDB.importStudents(
              parsedStudents, 
              selectedClassIds.length > 0 ? selectedClassIds : null,
              classes  // All available classes for name lookup
            );
          } else {
            const response = await fetch('/.netlify/functions/manage-students', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: 'importCSV',
                csvContent,
                classIds: selectedClassIds.length > 0 ? selectedClassIds : null
              })
            });
            result = await response.json();
          }

          if (result.success) {
            setResults(result);
          } else {
            setError(result.error || 'Import failed');
          }
        } catch (err) {
          setError('Unable to connect. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div style={parseStyle("position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg); overflow-y: auto;")}>
          <div className="card" style={parseStyle("max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;")}>
            <h2 style={parseStyle("font-family: var(--font-display); margin-bottom: var(--space-lg);")}>Import Students from CSV</h2>
            
            {!results ? (
              <>
                <div style={parseStyle("margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--glass-bg); border-radius: var(--radius-md);")}>
                  <p style={parseStyle("font-size: 0.9rem; margin-bottom: var(--space-sm);")}>
                    <strong>CSV Format:</strong> Must include columns for <code>email</code> and <code>name</code>.
                  </p>
                  <p style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: var(--space-sm);")}>
                    Optional: <code>class</code> (assigns to class by name), <code>yeargroup</code>, <code>password</code>
                  </p>
                  <p style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted); font-style: italic;")}>
                    Tip: Include a "class" column to assign different students to different classes in one import.
                  </p>
                </div>

                <div style={parseStyle("margin-bottom: var(--space-md);")}>
                  <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Upload CSV File</label>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleFileUpload}
                    style={parseStyle("width: 100%;")}
                  />
                </div>

                <div style={parseStyle("margin-bottom: var(--space-md);")}>
                  <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Or Paste CSV Content</label>
                  <textarea
                    value={csvContent}
                    onChange={(e) => setCsvContent(e.target.value)}
                    placeholder="email,name,class&#10;jsmith@bb-hs.co.uk,John Smith,10B English&#10;esmith@bb-hs.co.uk,Emma Smith,10A English"
                    className="paragraph-editor"
                    style={parseStyle("min-height: 150px;")}
                  />
                </div>

                <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                  <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Also add ALL students to these classes:</label>
                  <p style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: var(--space-sm);")}>
                    (In addition to any class specified in CSV)
                  </p>
                  <div style={parseStyle("max-height: 120px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-sm);")}>
                    {classes.length === 0 ? (
                      <p style={parseStyle("color: var(--color-text-muted); font-size: 0.9rem;")}>No classes created yet</p>
                    ) : (
                      classes.map(c => (
                        <label key={c.id} style={parseStyle("display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-xs) 0; cursor: pointer;")}>
                          <input
                            type="checkbox"
                            checked={selectedClassIds.includes(c.id)}
                            onChange={() => toggleClass(c.id)}
                            style={parseStyle("width: 18px; height: 18px; cursor: pointer;")}
                          />
                          <span>{c.name}</span>
                        </label>
                      ))
                    )}
                  </div>
                  {selectedClassIds.length > 0 && (
                    <p style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted); margin-top: var(--space-xs);")}>
                      Selected: {selectedClassIds.length} class{selectedClassIds.length !== 1 ? 'es' : ''}
                    </p>
                  )}
                </div>

                {error && (
                  <div style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-sm); color: var(--color-error);")}>
                    {error}
                  </div>
                )}

                <div style={parseStyle("display: flex; gap: var(--space-sm); justify-content: flex-end;")}>
                  <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                  <button className="btn btn-primary" onClick={handleImport} disabled={isLoading}>
                    {isLoading ? 'Importing...' : 'Import'}
                  </button>
                </div>
              </>
            ) : (
              <>
                <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                  <h3 style={parseStyle("color: var(--color-success); margin-bottom: var(--space-md);")}>
                    Import Complete
                  </h3>
                  <p>
                    <strong>{results.results.created.length}</strong> students created, 
                    <strong> {results.results.skipped.length}</strong> skipped (already exist),
                    <strong> {results.results.errors.length}</strong> errors
                  </p>
                </div>

                {results.results.created.length > 0 && (
                  <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                    <h4 style={parseStyle("margin-bottom: var(--space-sm);")}>Created Students and Passwords</h4>
                    <div style={parseStyle("max-height: 200px; overflow-y: auto; background: var(--glass-bg); padding: var(--space-md); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.85rem;")}>
                      {results.results.created.map((s, i) => (
                        <div key={i} style={parseStyle("margin-bottom: var(--space-xs);")}>
                          {s.name}: <strong>{s.password}</strong>
                        </div>
                      ))}
                    </div>
                    <p style={parseStyle("font-size: 0.85rem; color: var(--color-warning); margin-top: var(--space-sm);")}>
                      Save these passwords! They will not be shown again.
                    </p>
                  </div>
                )}

                <div style={parseStyle("display: flex; justify-content: flex-end;")}>
                  <button className="btn btn-primary" onClick={() => onSuccess(results)}>
                    Done
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      );
    }
    
    // =====================================================
    // ADD CLASS MODAL
    // =====================================================
    
    function AddClassModal({ onClose, onSuccess }) {
      const [name, setName] = useState('');
      const [subject, setSubject] = useState('English');
      const [yearGroup, setYearGroup] = useState('');
      const [teacher, setTeacher] = useState('');
      const [teacherEmail, setTeacherEmail] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        if (!name) {
          setError('Class name is required');
          return;
        }

        setIsLoading(true);

        try {
          let result;
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            result = await FirebaseDB.createClass({ name, subject, yearGroup, teacher, teacherEmail });
          } else {
            const response = await fetch('/.netlify/functions/manage-classes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'create', name, subject, yearGroup, teacher, teacherEmail })
            });
            result = await response.json();
          }

          if (result.success) {
            onSuccess(result.class);
          } else {
            setError(result.error || 'Failed to create class');
          }
        } catch (err) {
          setError('Unable to connect. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div style={parseStyle("position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg);")}>
          <div className="card" style={parseStyle("max-width: 450px; width: 100%;")}>
            <h2 style={parseStyle("font-family: var(--font-display); margin-bottom: var(--space-lg);")}>Create Class</h2>
            
            <form onSubmit={handleSubmit}>
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Class Name *</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="e.g. 10B English"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                />
              </div>

              <div style={parseStyle("display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);")}>
                <div>
                  <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Subject</label>
                  <input
                    type="text"
                    value={subject}
                    onChange={(e) => setSubject(e.target.value)}
                    placeholder="e.g. English"
                    className="paragraph-editor"
                    style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  />
                </div>
                <div>
                  <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Year Group</label>
                  <input
                    type="text"
                    value={yearGroup}
                    onChange={(e) => setYearGroup(e.target.value)}
                    placeholder="e.g. Year 10"
                    className="paragraph-editor"
                    style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  />
                </div>
              </div>

              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Teacher Name</label>
                <input
                  type="text"
                  value={teacher}
                  onChange={(e) => setTeacher(e.target.value)}
                  placeholder="e.g. Mr Davies"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                />
              </div>

              <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600;")}>Teacher Email</label>
                <input
                  type="email"
                  value={teacherEmail}
                  onChange={(e) => setTeacherEmail(e.target.value)}
                  placeholder="e.g. pdavies@bb-hs.co.uk"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                />
              </div>

              {error && (
                <div style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-sm); color: var(--color-error);")}>
                  {error}
                </div>
              )}

              <div style={parseStyle("display: flex; gap: var(--space-sm); justify-content: flex-end;")}>
                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                <button type="submit" className="btn btn-primary" disabled={isLoading}>
                  {isLoading ? 'Creating...' : 'Create Class'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    // =====================================================
    // ASSIGNMENTS PANEL
    // =====================================================
    
    function AssignmentsPanel() {
      const [classes, setClasses] = useState([]);
      const [students, setStudents] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedClass, setSelectedClass] = useState(null);
      const [selectedStudent, setSelectedStudent] = useState(null);

      const essays = window.ESSAY_LIST || [];

      useEffect(() => {
        const loadData = async () => {
          try {
            const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
              const [classList, studentList] = await Promise.all([
                FirebaseDB.getClasses(),
                FirebaseDB.getStudents()
              ]);
              setClasses(classList);
              setStudents(studentList);
            } else {
              const [classesRes, studentsRes] = await Promise.all([
                fetch('/.netlify/functions/manage-classes'),
                fetch('/.netlify/functions/manage-students')
              ]);
              const classesData = await classesRes.json();
              const studentsData = await studentsRes.json();
              if (classesData.success) setClasses(classesData.classes || []);
              if (studentsData.success) setStudents(studentsData.students || []);
            }
          } catch (err) {
            console.error('Load error:', err);
          } finally {
            setLoading(false);
          }
        };
        loadData();
      }, []);

      const handleAssignToClass = async (classId, essayId, assign) => {
        try {
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            if (assign) {
              await FirebaseDB.assignToClass(classId, essayId);
            } else {
              await FirebaseDB.unassignFromClass(classId, essayId);
            }
          } else {
            await fetch('/.netlify/functions/manage-classes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: assign ? 'assignToClass' : 'unassignFromClass',
                classId, essayId
              })
            });
          }
          
          // Reload classes to get updated assignments
          if (firebaseReady) {
            const updated = await FirebaseDB.getClasses();
            setClasses(updated);
          } else {
            const res = await fetch('/.netlify/functions/manage-classes');
            const data = await res.json();
            if (data.success) setClasses(data.classes || []);
          }
        } catch (err) {
          console.error('Assignment error:', err);
        }
      };

      const handleAssignToStudent = async (studentEmail, essayId, assign) => {
        try {
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            if (assign) {
              await FirebaseDB.assignToStudent(studentEmail, essayId);
            } else {
              await FirebaseDB.unassignFromStudent(studentEmail, essayId);
            }
          } else {
            await fetch('/.netlify/functions/manage-classes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: assign ? 'assignToStudent' : 'unassignFromStudent',
                studentEmail, essayId
              })
            });
          }
          
          // Reload students
          if (firebaseReady) {
            const updated = await FirebaseDB.getStudents();
            setStudents(updated);
          } else {
            const res = await fetch('/.netlify/functions/manage-students');
            const data = await res.json();
            if (data.success) setStudents(data.students || []);
          }
        } catch (err) {
          console.error('Assignment error:', err);
        }
      };

      if (loading) {
        return <div className="card"><p style={parseStyle("text-align: center; padding: var(--space-xl);")}>Loading...</p></div>;
      }

      return (
        <div className="card">
          <h2 style={parseStyle("font-family: var(--font-display); margin-bottom: var(--space-lg);")}>
            Assign Work
          </h2>

          <div style={parseStyle("display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xl);")}>
            {/* Class Assignments */}
            <div>
              <h3 style={parseStyle("color: var(--color-primary-light); margin-bottom: var(--space-md);")}>
                Assign to Class
              </h3>
              
              <select
                value={selectedClass || ''}
                onChange={(e) => setSelectedClass(e.target.value || null)}
                style={parseStyle("width: 100%; padding: var(--space-sm); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text); margin-bottom: var(--space-md);")}
              >
                <option value="">Select a class...</option>
                {classes.map(c => (
                  <option key={c.id} value={c.id}>{c.name}</option>
                ))}
              </select>

              {selectedClass && (
                <div>
                  {essays.map(essay => {
                    const classData = classes.find(c => c.id === selectedClass);
                    const isAssigned = (classData?.assignedEssays || []).includes(essay.id);
                    
                    return (
                      <div 
                        key={essay.id}
                        style={parseStyle("display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); background: var(--glass-bg); border-radius: var(--radius-sm); margin-bottom: var(--space-sm);")}
                      >
                        <span style={parseStyle("font-size: 0.9rem;")}>{essay.title}</span>
                        <button
                          onClick={() => handleAssignToClass(selectedClass, essay.id, !isAssigned)}
                          className={isAssigned ? "btn btn-secondary" : "btn btn-primary"}
                          style={parseStyle("font-size: 0.8rem; padding: var(--space-xs) var(--space-sm);")}
                        >
                          {isAssigned ? 'Remove' : 'Assign'}
                        </button>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Individual Assignments */}
            <div>
              <h3 style={parseStyle("color: var(--color-primary-light); margin-bottom: var(--space-md);")}>
                Assign to Individual
              </h3>
              
              <select
                value={selectedStudent || ''}
                onChange={(e) => setSelectedStudent(e.target.value || null)}
                style={parseStyle("width: 100%; padding: var(--space-sm); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text); margin-bottom: var(--space-md);")}
              >
                <option value="">Select a student...</option>
                {students.map(s => (
                  <option key={s.email} value={s.email}>{s.name} ({s.className || 'No class'})</option>
                ))}
              </select>

              {selectedStudent && (
                <div>
                  {essays.map(essay => {
                    const studentData = students.find(s => s.email === selectedStudent);
                    const isAssigned = (studentData?.individualAssignments || []).includes(essay.id);
                    
                    return (
                      <div 
                        key={essay.id}
                        style={parseStyle("display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); background: var(--glass-bg); border-radius: var(--radius-sm); margin-bottom: var(--space-sm);")}
                      >
                        <span style={parseStyle("font-size: 0.9rem;")}>{essay.title}</span>
                        <button
                          onClick={() => handleAssignToStudent(selectedStudent, essay.id, !isAssigned)}
                          className={isAssigned ? "btn btn-secondary" : "btn btn-primary"}
                          style={parseStyle("font-size: 0.8rem; padding: var(--space-xs) var(--space-sm);")}
                        >
                          {isAssigned ? 'Remove' : 'Assign'}
                        </button>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
          
          {/* Assignment Overview - Shows which students have which essays */}
          <div style={parseStyle("margin-top: var(--space-xl); border-top: 1px solid var(--color-border); padding-top: var(--space-xl);")}>
            <h3 style={parseStyle("color: var(--color-primary-light); margin-bottom: var(--space-lg);")}>
               Assignment Overview
            </h3>
            
            {essays.length === 0 ? (
              <p style={parseStyle("color: var(--color-text-muted);")}> No essays configured</p>
            ) : (
              <div style={parseStyle("display: flex; flex-direction: column; gap: var(--space-lg);")}>
                {essays.map(essay => {
                  // Find all classes that have this essay assigned
                  const assignedClasses = classes.filter(c => 
                    (c.assignedEssays || []).includes(essay.id)
                  );
                  
                  // Find all students with individual assignments for this essay
                  const individuallyAssigned = students.filter(s => 
                    (s.individualAssignments || []).includes(essay.id)
                  );
                  
                  // Find all students in assigned classes (excluding individually assigned to avoid duplicates)
                  const studentsInAssignedClasses = students.filter(s => {
                    // Check if student is in any of the assigned classes
                    const studentClassIds = s.classIds || (s.classId ? [s.classId] : []);
                    return assignedClasses.some(c => studentClassIds.includes(c.id)) &&
                           !individuallyAssigned.some(ia => ia.email === s.email);
                  });
                  
                  const totalAssigned = individuallyAssigned.length + studentsInAssignedClasses.length;
                  
                  return (
                    <div 
                      key={essay.id}
                      style={parseStyle("background: var(--glass-bg); border-radius: var(--radius-md); padding: var(--space-md); border: 1px solid var(--color-border);")}
                    >
                      <div style={parseStyle("display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);")}>
                        <h4 style={parseStyle("font-family: var(--font-display); color: var(--color-text); margin: 0;")}>
                          {essay.title}
                        </h4>
                        <span style={parseStyle(`
                          font-size: 0.85rem; 
                          padding: var(--space-xs) var(--space-sm); 
                          border-radius: var(--radius-full);
                          background: ${totalAssigned > 0 ? 'var(--color-success-bg)' : 'rgba(100, 100, 120, 0.2)'};
                          color: ${totalAssigned > 0 ? 'var(--color-success)' : 'var(--color-text-muted)'};
                        `)}>
                          {totalAssigned} student{totalAssigned !== 1 ? 's' : ''} assigned
                        </span>
                      </div>
                      
                      {totalAssigned === 0 ? (
                        <p style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted); margin: 0;")}>
                          No students assigned yet
                        </p>
                      ) : (
                        <div style={parseStyle("font-size: 0.85rem;")}>
                          {/* Show assigned classes */}
                          {assignedClasses.length > 0 && (
                            <div style={parseStyle("margin-bottom: var(--space-sm);")}>
                              <span style={parseStyle("color: var(--color-primary-light); font-weight: 600;")}>
                                Classes: 
                              </span>
                              <span style={parseStyle("color: var(--color-text-secondary); margin-left: var(--space-xs);")}>
                                {assignedClasses.map(c => c.name).join(', ')}
                              </span>
                            </div>
                          )}
                          
                          {/* Show students in those classes */}
                          {studentsInAssignedClasses.length > 0 && (
                            <div style={parseStyle("margin-bottom: var(--space-sm);")}>
                              <span style={parseStyle("color: var(--color-text-muted);")}>
                                Via class ({studentsInAssignedClasses.length}): 
                              </span>
                              <span style={parseStyle("color: var(--color-text-secondary); margin-left: var(--space-xs);")}>
                                {studentsInAssignedClasses.slice(0, 5).map(s => s.name).join(', ')}
                                {studentsInAssignedClasses.length > 5 && ` +${studentsInAssignedClasses.length - 5} more`}
                              </span>
                            </div>
                          )}
                          
                          {/* Show individually assigned students */}
                          {individuallyAssigned.length > 0 && (
                            <div>
                              <span style={parseStyle("color: var(--color-accent);")}>
                                Individual ({individuallyAssigned.length}): 
                              </span>
                              <span style={parseStyle("color: var(--color-text-secondary); margin-left: var(--space-xs);")}>
                                {individuallyAssigned.map(s => s.name).join(', ')}
                              </span>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    }
    
    // =====================================================
    // ESSAY SELECTION SCREEN
    // =====================================================
    
    function EssaySelectionScreen({ onSelectEssay, onTeacherLogin }) {
      const [showTeacherLogin, setShowTeacherLogin] = useState(false);
      const [error, setError] = useState('');
      
      // Check for saved progress on each essay
      const getSavedProgress = (essayId) => {
        try {
          const config = getEssayConfig(essayId);
          if (!config) return null;
          const saved = localStorage.getItem(config.LOCAL_STORAGE_KEY);
          if (!saved) return null;
          const data = JSON.parse(saved);
          if (!data.studentName || !data.paragraphStates) return null;
          
          const completedCount = Object.values(data.paragraphStates).filter(s => s.completed).length;
          const totalParagraphs = config.paragraphs?.length || 0;
          
          return {
            studentName: data.studentName,
            completedCount,
            totalParagraphs,
            percentComplete: totalParagraphs > 0 ? Math.round((completedCount / totalParagraphs) * 100) : 0,
            isComplete: completedCount === totalParagraphs,
            savedAt: data.savedAt
          };
        } catch (e) {
          return null;
        }
      };
      
      const handleTeacherSubmit = async (teacher) => {
        // Teacher is already authenticated via TeacherLoginForm
        onTeacherLogin(teacher);
      };
      
      return (
        <div className="app-container" style={parseStyle("max-width: 1000px;")}>
          <div className="app-header" style={parseStyle("text-align: center; margin-bottom: var(--space-xl);")}>
            <h1 className="gold-glow">{GLOBAL.siteName || 'Essay Writing Practice'}</h1>
            {GLOBAL.schoolName && <p className="subtitle">{GLOBAL.schoolName}</p>}
            <p style={parseStyle("color: var(--color-text-muted); margin-top: var(--space-md);")}>
              Select an essay to begin your guided writing practice
            </p>
          </div>
          
          {!showTeacherLogin ? (
            <>
              <div className="essay-grid">
                {getEssayList().map((essay) => {
                  const savedProgress = getSavedProgress(essay.id);
                  return (
                    <div 
                      key={essay.id} 
                      className="essay-card"
                      onClick={() => onSelectEssay(essay.id)}
                      style={savedProgress ? { borderColor: 'var(--color-primary)' } : {}}
                    >
                      {savedProgress && (
                        <div style={{ position: 'absolute', top: 'var(--space-md)', right: 'var(--space-md)', background: savedProgress.isComplete ? 'var(--color-success)' : 'var(--color-primary)', color: 'white', padding: '2px 8px', borderRadius: 'var(--radius-full)', fontSize: '0.75rem', fontWeight: 600 }}>
                          {savedProgress.isComplete ? ' Complete' : `${savedProgress.percentComplete}% done`}
                        </div>
                      )}
                      <div className="essay-card-icon">{essay.icon || ''}</div>
                      <h3 className="essay-card-title">{essay.title}</h3>
                      <div className="essay-card-meta">
                        <span> {essay.subject}</span>
                        <span> {essay.yearGroup}</span>
                      </div>
                      <p className="essay-card-description">{essay.description}</p>
                      <div className="essay-card-stats">
                        <span className="essay-card-stat"><strong>{essay.paragraphs?.length || 0}</strong> paragraphs</span>
                        <span className="essay-card-stat"><strong>{essay.totalMarks}</strong> marks</span>
                      </div>
                      {savedProgress && !savedProgress.isComplete && (
                        <div style={parseStyle("margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--color-border); font-size: 0.85rem; color: var(--color-text-muted);")}>
                          <strong style={parseStyle("color: var(--color-primary-light);")}>{savedProgress.studentName}</strong>
                          <span> - {savedProgress.completedCount}/{savedProgress.totalParagraphs} paragraphs</span>
                          <div style={parseStyle("margin-top: var(--space-xs); height: 4px; background: var(--color-border); border-radius: 2px; overflow: hidden;")}>
                            <div style={{ width: `${savedProgress.percentComplete}%`, height: '100%', background: 'var(--color-primary)', borderRadius: '2px' }} />
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
              
              <div style={parseStyle("text-align: center; margin-top: var(--space-2xl);")}>
                <button 
                  className="btn btn-secondary"
                  onClick={() => setShowTeacherLogin(true)}
                >
                  Teacher Login
                </button>
              </div>
            </>
          ) : (
            <TeacherLoginForm
              onSuccess={handleTeacherSubmit}
              onBack={() => { setShowTeacherLogin(false); setError(''); }}
            />
          )}
        </div>
      );
    }
    
    // =====================================================
    // TASK PANEL (shows original exam question and source material)
    // =====================================================
    
    function TaskPanel({ isOpen, onClose, config, sourceMaterial }) {
      const hasTask = config?.originalTask;
      const hasSource = sourceMaterial;
      
      if (!hasTask && !hasSource) return null;
      
      return (
        <div className={`task-panel ${isOpen ? 'mobile-open' : ''}`}>
          <div className="task-panel-header">
            <h3 className="task-panel-title">
              <span>&#128203; Reference Materials</span>
            </h3>
            <button className="task-panel-close" onClick={onClose} aria-label="Close task panel"></button>
          </div>
          <div className="task-panel-content">
            {hasTask && (
              <div className="task-section">
                <h4 className="task-section-title">
                  <span>&#128196; Exam Question</span>
                </h4>
                <div dangerouslySetInnerHTML={{ __html: renderMarkdown(config.originalTask) }} />
              </div>
            )}
            
            {hasSource && (
              <div className="task-section">
                <h4 className="task-section-title">
                  <span>&#128214; Source Material</span>
                </h4>
                <div dangerouslySetInnerHTML={{ __html: renderMarkdown(sourceMaterial) }} />
              </div>
            )}
          </div>
        </div>
      );
    }
    
    function TaskToggleButton({ onClick, hasTask }) {
      if (!hasTask) return null;
      
      return (
        <button 
          className={`task-toggle-btn ${hasTask ? 'has-task' : ''}`}
          onClick={onClick}
          aria-label="Show original task"
          title="Show original task"
        >
          
        </button>
      );
    }
    
    // =====================================================
    // PARAGRAPH TRACKER COMPONENT
    // =====================================================
    
    function ParagraphTracker({ paragraphs, currentIndex, paragraphStates, onNavigate, previewMode }) {
      const completedCount = Object.values(paragraphStates).filter(s => s.completed).length;
      
      return (
        <div className="progress-section">
          <div className="progress-header">
            <span className="progress-label">Essay Progress</span>
            <span className="progress-stats">{completedCount} of {paragraphs.length} paragraphs complete</span>
          </div>
          
          <div className="question-tracker">
            {paragraphs.map((para, index) => {
              const state = paragraphStates[para.id];
              const isCompleted = state?.completed;
              const isInProgress = state?.attempts > 0 && !isCompleted;
              const isCurrent = index === currentIndex;
              const isLocked = !previewMode && index > currentIndex && !isCompleted;
              
              let className = 'question-tracker-item';
              if (isCurrent) className += ' current';
              else if (isCompleted) className += ' correct';
              else if (isInProgress) className += ' in-progress';
              if (isLocked) className += ' locked';
              
              return (
                <div
                  key={para.id}
                  className={className}
                  onClick={() => {
                    if (!isLocked || previewMode) {
                      onNavigate(index);
                    }
                  }}
                  title={para.title}
                >
                  {index + 1}
                </div>
              );
            })}
          </div>
          
          <div className="progress-summary">
            <div className="progress-summary-item">
              <span className="progress-summary-dot correct"></span>
              <span>Complete</span>
            </div>
            <div className="progress-summary-item">
              <span className="progress-summary-dot" style={parseStyle("background: var(--color-info);")}></span>
              <span>In Progress</span>
            </div>
            <div className="progress-summary-item">
              <span className="progress-summary-dot pending"></span>
              <span>Not Started</span>
            </div>
          </div>
        </div>
      );
    }
    
    // =====================================================
    // FEEDBACK DISPLAY COMPONENT
    // =====================================================
    
    function FeedbackDisplay({ feedback, attemptNumber, canRevise, cumulativeInfo, onRevise, onAccept, targetGrade, authenticityCheck }) {
      const scoreClass = getScoreClass(feedback.overallScore || 0);
      const grade = feedback.estimatedGrade || feedback.awardedGrade;
      const hasAuthenticGrade = Boolean(grade);
      const hasMarks = feedback.awardedMarks != null && feedback.totalMarks;
      
      // Format grade display
      const displayGrade = grade && !grade.toString().startsWith('Grade') ? `Grade ${grade}` : grade;
      
      // Cumulative grading indicator
      const isCumulative = cumulativeInfo?.isCumulative;
      const paragraphCount = cumulativeInfo?.paragraphCount;
      
      // Authenticity check results
      const hasAuthenticityWarning = authenticityCheck?.isSuspicious || !authenticityCheck?.isAuthentic;
      const authenticityFlags = authenticityCheck?.flags || {};
      
      // Build readable feedback text for TTS
      const buildFeedbackText = () => {
        let text = '';
        if (hasAuthenticGrade) {
          text += `You received ${displayGrade}. `;
          if (hasMarks) {
            text += `That's ${feedback.awardedMarks} out of ${feedback.totalMarks} marks. `;
          }
        } else if (feedback.overallScore) {
          text += `You scored ${feedback.overallScore} percent. `;
        }
        
        if (feedback.strengths && feedback.strengths.length > 0) {
          text += 'Your strengths: ';
          text += feedback.strengths.join('. ') + '. ';
        }
        
        if (feedback.improvements && feedback.improvements.length > 0) {
          text += 'Areas to improve: ';
          text += feedback.improvements.join('. ') + '. ';
        }
        
        if (feedback.detailedFeedback) {
          text += 'Detailed feedback: ' + feedback.detailedFeedback + ' ';
        }
        
        if (feedback.nextLevelHint) {
          text += 'To reach the next grade: ' + feedback.nextLevelHint + ' ';
        }
        
        return text;
      };
      
      return (
        <div className="feedback-panel ghost-appear">
          {/* Authenticity Warning - shown if suspicious */}
          {hasAuthenticityWarning && (
            <div style={{
              marginBottom: 'var(--space-lg)',
              padding: 'var(--space-md)',
              background: 'linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.08))',
              borderRadius: 'var(--radius-md)',
              border: '2px solid var(--color-error)',
              boxShadow: '0 0 20px rgba(239, 68, 68, 0.2)'
            }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: 'var(--space-sm)',
                marginBottom: 'var(--space-sm)',
                color: 'var(--color-error)',
                fontWeight: 700,
                fontSize: '1rem'
              }}>
                <span style={{ fontSize: '1.2rem' }}></span>
                Authenticity Check: Please Review
              </div>
              <p style={{
                margin: '0 0 var(--space-sm) 0',
                fontSize: '0.95rem',
                color: 'var(--color-text)'
              }}>
                This submission has been flagged for review. Please ensure this is your own original work written in your own words.
              </p>
              {authenticityCheck?.concerns && authenticityCheck.concerns.length > 0 && (
                <ul style={{
                  margin: '0',
                  paddingLeft: 'var(--space-lg)',
                  fontSize: '0.9rem',
                  color: 'var(--color-text-secondary)'
                }}>
                  {authenticityCheck.concerns.map((concern, i) => (
                    <li key={i} style={{ marginBottom: 'var(--space-xs)' }}>{concern}</li>
                  ))}
                </ul>
              )}
              <div style={{
                display: 'flex',
                flexWrap: 'wrap',
                gap: 'var(--space-sm)',
                marginTop: 'var(--space-md)'
              }}>
                {authenticityFlags.sophisticationMismatch && (
                  <span style={{
                    background: 'rgba(239, 68, 68, 0.2)',
                    color: 'var(--color-error)',
                    padding: 'var(--space-xs) var(--space-sm)',
                    borderRadius: 'var(--radius-full)',
                    fontSize: '0.75rem',
                    fontWeight: 600
                  }}>
                    Sophistication Mismatch
                  </span>
                )}
                {authenticityFlags.styleInconsistency && (
                  <span style={{
                    background: 'rgba(239, 68, 68, 0.2)',
                    color: 'var(--color-error)',
                    padding: 'var(--space-xs) var(--space-sm)',
                    borderRadius: 'var(--radius-full)',
                    fontSize: '0.75rem',
                    fontWeight: 600
                  }}>
                    Style Inconsistency
                  </span>
                )}
                {authenticityFlags.aiPatterns && (
                  <span style={{
                    background: 'rgba(239, 68, 68, 0.2)',
                    color: 'var(--color-error)',
                    padding: 'var(--space-xs) var(--space-sm)',
                    borderRadius: 'var(--radius-full)',
                    fontSize: '0.75rem',
                    fontWeight: 600
                  }}>
                    AI Writing Patterns
                  </span>
                )}
              </div>
              <p style={{
                margin: 'var(--space-md) 0 0 0',
                fontSize: '0.85rem',
                color: 'var(--color-text-muted)',
                fontStyle: 'italic'
              }}>
                 Tip: If you used AI tools, please revise this paragraph using your own words and understanding. Your teacher wants to see YOUR thinking!
              </p>
            </div>
          )}
          
          <div className="feedback-header">
            {hasAuthenticGrade ? (
              <div style={parseStyle("display: flex; align-items: center; gap: var(--space-md);")}>
                <div style={parseStyle("background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-text-inverse); padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); font-size: 1.5rem; font-weight: 700; font-family: var(--font-display);")}>
                  {displayGrade}
                </div>
                {hasMarks && (
                  <div style={parseStyle("font-size: 1rem; color: var(--color-text); background: var(--color-surface-alt); padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-sm); font-weight: 500;")}>
                    {feedback.awardedMarks}/{feedback.totalMarks} marks
                  </div>
                )}
                {isCumulative && paragraphCount > 1 && (
                  <div style={parseStyle("font-size: 0.8rem; color: var(--color-info); background: var(--color-info-bg); padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-sm); font-weight: 600;")}>
                     &#128202; Cumulative ({paragraphCount} paragraphs)
                  </div>
                )}
              </div>
            ) : (
              <div className={`feedback-score ${scoreClass}`}>
                {feedback.overallScore || 0}%
              </div>
            )}
            <div>
              <h3 style={parseStyle("margin: 0;")}>
                {isCumulative ? `Essay Grade So Far (After ${paragraphCount} Paragraph${paragraphCount > 1 ? 's' : ''})` : `Feedback on Attempt ${attemptNumber}`}
              </h3>
              <p style={parseStyle("margin: 0; font-size: 0.9rem; color: var(--color-text-muted);")}>
                {isCumulative 
                  ? `This grade reflects your complete essay written so far` 
                  : (canRevise ? 'Review the feedback and revise your paragraph' : 'Final feedback on your paragraph')
                }
              </p>
            </div>
          </div>
          
          {/* TTS Button for feedback */}
          <div style={parseStyle("margin-bottom: var(--space-md);")}>
            <TextToSpeech text={buildFeedbackText()} label="Read feedback aloud" targetGrade={targetGrade} />
          </div>
          
          {/* Grade/Marks Justification - shown when using authentic descriptors */}
          {(feedback.marksJustification || feedback.gradeJustification) && (
            <div style={parseStyle("margin-bottom: var(--space-lg); padding: var(--space-md); background: rgba(184; border-radius: var(--radius-md); border-left: 3px solid var(--color-primary);")}>
              <div style={parseStyle("font-size: 0.8rem; font-weight: 600; color: var(--color-primary-light); margin-bottom: var(--space-xs);")}>
                Indicative Mark Assessment
              </div>
              <p style={parseStyle("margin: 0; font-size: 0.95rem;")}>{feedback.marksJustification || feedback.gradeJustification}</p>
            </div>
          )}
          
          {feedback.criteriaScores && (
            <div className="criteria-scores">
              {Object.entries(feedback.criteriaScores).map(([key, score]) => {
                // Map technical keys to user-friendly labels
                const labelMap = {
                  // Authentic descriptor criteria (AO5/AO6 based)
                  'communication': 'Communication & Style',
                  'organization': 'Organisation & Structure',
                  'language': 'Language & Devices',
                  'accuracy': 'Technical Accuracy',
                  // Fallback criteria
                  'content': 'Content & Understanding',
                  'analysis': 'Analysis',
                  'structure': 'Structure',
                  'expression': 'Expression'
                };
                const label = labelMap[key] || key.charAt(0).toUpperCase() + key.slice(1);
                return (
                  <div key={key} className="criteria-item">
                    <div className="criteria-label">{label}</div>
                    <div className="criteria-score">{score}%</div>
                  </div>
                );
              })}
            </div>
          )}
          
          {feedback.strengths && feedback.strengths.length > 0 && (
            <div className="feedback-section">
              <div className="feedback-section-title"><span>&#9733; Strengths</span></div>
              <ul className="feedback-list strengths">
                {feedback.strengths.map((s, i) => <li key={i}>{s}</li>)}
              </ul>
            </div>
          )}
          
          {feedback.improvements && feedback.improvements.length > 0 && (
            <div className="feedback-section">
              <div className="feedback-section-title"><span> Areas to Improve</span></div>
              <ul className="feedback-list improvements">
                {feedback.improvements.map((s, i) => <li key={i}>{s}</li>)}
              </ul>
            </div>
          )}
          
          {feedback.detailedFeedback && (
            <div className="feedback-section">
              <div className="feedback-section-title"><span>&#9998; Detailed Feedback</span></div>
              <div className="detailed-feedback">{feedback.detailedFeedback}</div>
            </div>
          )}
          
          {feedback.exampleRevision && (
            <div className="example-revision">
              <div className="example-revision-label">&#128295; Example Improvement</div>
              {feedback.exampleRevision}
            </div>
          )}
          
          {feedback.nextLevelHint && (
            <div className="feedback-section" style={parseStyle("margin-top: var(--space-lg);")}>
              <div className="feedback-section-title"><span>&#9673; To Reach the Next Grade</span></div>
              <div className="detailed-feedback">{feedback.nextLevelHint}</div>
            </div>
          )}
          
          <div className="revision-actions">
            {canRevise ? (
              <>
                <button className="btn btn-primary" onClick={onRevise}>
                  ? Revise My Paragraph
                </button>
                <button className="btn btn-success" onClick={onAccept}>
                  ? Accept & Continue
                </button>
              </>
            ) : (
              <button className="btn btn-success btn-large" onClick={onAccept} style={parseStyle("width: 100%;")}>
                   Complete & Continue to Next Section
              </button>
            )}
          </div>
        </div>
      );
    }

    // =====================================================
    // TARGET GRADE UTILITIES
    // =====================================================

    const GRADE_SYSTEMS = {
      gcse: {
        name: "GCSE",
        grades: ["9", "8", "7", "6", "5", "4", "3", "2", "1"],
        tiers: {
          high: ["9", "8", "7"],
          middle: ["6", "5", "4"],
          foundation: ["3", "2", "1"]
        },
        descriptions: {
          high: "Challenging feedback to push toward excellence",
          middle: "Balanced support with clear improvement steps",
          foundation: "Supportive guidance with lots of encouragement"
        }
      },
      alevel: {
        name: "A-Level",
        grades: ["A*", "A", "B", "C", "D", "E"],
        tiers: {
          high: ["A*", "A"],
          middle: ["B", "C"],
          foundation: ["D", "E"]
        },
        descriptions: {
          high: "Challenging feedback to push toward excellence",
          middle: "Balanced support with clear improvement steps",
          foundation: "Supportive guidance with lots of encouragement"
        }
      }
    };

    const getAbilityTier = (grade, system) => {
      const gradeSystem = GRADE_SYSTEMS[system] || GRADE_SYSTEMS.gcse;
      for (const [tier, grades] of Object.entries(gradeSystem.tiers)) {
        if (grades.includes(grade)) return tier;
      }
      return "middle";
    };

    const getGradeSystem = (config) => {
      // Detect from config or default to GCSE
      if (config?.gradeSystem) return config.gradeSystem;
      if (config?.qualification?.toLowerCase().includes('a-level') ||
          config?.qualification?.toLowerCase().includes('alevel')) return 'alevel';
      if (config?.yearGroup?.includes('12') || config?.yearGroup?.includes('13')) return 'alevel';
      return 'gcse';
    };
// ENTRY SCREEN
    // =====================================================

    function EntryScreen({ config, onStudentStart, onBack, loggedInStudent }) {
      // If student is logged in, use their info automatically
      const [studentName, setStudentName] = useState(loggedInStudent?.name || '');
      const [studentEmail, setStudentEmail] = useState(loggedInStudent?.email || '');
      const [targetGrade, setTargetGrade] = useState('');
      const [error, setError] = useState('');
      const [checkingProgress, setCheckingProgress] = useState(false);
      const [existingProgress, setExistingProgress] = useState(null);

      const REQUIRED_EMAIL_DOMAIN = '@bb-hs.co.uk';
      
      // Check if student is already logged in
      const isLoggedIn = !!(loggedInStudent?.name && loggedInStudent?.email);

      // Determine grade system from config
      const gradeSystem = getGradeSystem(config);
      const gradeSystemInfo = GRADE_SYSTEMS[gradeSystem];
      const abilityTier = targetGrade ? getAbilityTier(targetGrade, gradeSystem) : null;
      
      // Auto-check for existing progress when logged in
      useEffect(() => {
        if (isLoggedIn && loggedInStudent?.email) {
          checkExistingProgress(loggedInStudent.email);
        }
      }, [isLoggedIn, loggedInStudent?.email]);

      // Check for existing progress when email changes
      const checkExistingProgress = async (email) => {
        const emailLower = email.trim().toLowerCase();
        if (!emailLower || !emailLower.endsWith(REQUIRED_EMAIL_DOMAIN)) {
          setExistingProgress(null);
          return;
        }
        
        setCheckingProgress(true);
        try {
          const response = await fetch(`/.netlify/functions/save-progress?email=${encodeURIComponent(emailLower)}&essayId=${config.id || ''}`);
          const data = await response.json();
          
          if (data.success && data.found && data.progress) {
            setExistingProgress(data.progress);
            // Pre-fill form with saved data
            if (data.progress.studentName) setStudentName(data.progress.studentName);
            if (data.progress.targetGrade) setTargetGrade(data.progress.targetGrade);
          } else {
            setExistingProgress(null);
          }
        } catch (err) {
          console.log('Progress check error:', err.message);
          setExistingProgress(null);
        } finally {
          setCheckingProgress(false);
        }
      };

      const handleResumeProgress = () => {
        if (existingProgress) {
          onStudentStart(
            existingProgress.studentName || studentName.trim(),
            existingProgress.studentEmail || studentEmail.trim().toLowerCase(),
            existingProgress.targetGrade || targetGrade,
            existingProgress.gradeSystem || gradeSystem,
            existingProgress // Pass full progress data for resume
          );
        }
      };

      const handleStartFresh = () => {
        setExistingProgress(null);
        // Clear any pre-filled data (only if not logged in)
        if (!isLoggedIn) {
          setStudentName('');
        }
        setTargetGrade('');
      };

      const handleStudentSubmit = (e) => {
        e.preventDefault();

        // Use logged-in student info if available
        const finalName = isLoggedIn ? loggedInStudent.name : studentName.trim();
        const finalEmail = isLoggedIn ? loggedInStudent.email : studentEmail.trim().toLowerCase();

        // Validate name (skip if logged in)
        if (!isLoggedIn && finalName.length < 2) {
          setError('Please enter your name (at least 2 characters)');
          return;
        }

        // Validate email (skip if logged in)
        if (!isLoggedIn) {
          if (!finalEmail) {
            setError('Please enter your school email address');
            return;
          }

          if (!finalEmail.endsWith(REQUIRED_EMAIL_DOMAIN)) {
            setError(`Please use your school email (must end with ${REQUIRED_EMAIL_DOMAIN})`);
            return;
          }

          // Basic email format check
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(finalEmail)) {
            setError('Please enter a valid email address');
            return;
          }
        }

        // Validate target grade
        if (!targetGrade) {
          setError('Please select your target grade');
          return;
        }

        onStudentStart(finalName, finalEmail, targetGrade, gradeSystem);
      };

      const getGradeButtonClass = (grade) => {
        const tier = getAbilityTier(grade, gradeSystem);
        let className = 'grade-button';
        if (targetGrade === grade) className += ' selected';
        if (tier === 'high') className += ' high-tier';
        if (tier === 'foundation') className += ' foundation-tier';
        return className;
      };

      if (!config) {
        return <div className="app-container"><LoadingSpinner text="Loading essay..." /></div>;
      }

      return (
        <div className="app-container">
          <div className="card ghost-appear">
            <div className="app-header" style={parseStyle("margin-bottom: 0; border: none; background: transparent; padding: var(--space-lg) 0;")}>
              <h1 className="gold-glow">{config.title}</h1>
              <p className="subtitle">{config.subject} - {config.yearGroup}</p>
              {config.essayTitle && (
                <p className="essay-title">"{config.essayTitle}"</p>
              )}
            </div>

            <div style={parseStyle("margin-top: var(--space-xl);")}>
              <p style={parseStyle("margin-bottom: var(--space-lg); line-height: 1.7;")}>
                {config.instructions}
              </p>

              <form onSubmit={handleStudentSubmit}>
                {/* Show logged-in student info or ask for name/email */}
                {isLoggedIn ? (
                  <div style={parseStyle("margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--color-success-bg); border-radius: var(--radius-md); border: 1px solid var(--color-success);")}>
                    <p style={parseStyle("color: var(--color-success); font-weight: 600; margin-bottom: var(--space-xs);")}>
                       Logged in as:
                    </p>
                    <p style={parseStyle("font-size: 1.1rem; font-weight: 600; margin: 0;")}>
                      {loggedInStudent.name}
                    </p>
                    <p style={parseStyle("font-size: 0.9rem; color: var(--color-text-muted); margin: 0;")}>
                      {loggedInStudent.email}
                    </p>
                  </div>
                ) : (
                  <>
                    <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                      <label style={parseStyle("display: block; margin-bottom: var(--space-sm); font-weight: 600;")}>
                        Your full name:
                      </label>
                      <input
                        type="text"
                        value={studentName}
                        onChange={(e) => { setStudentName(e.target.value); setError(''); }}
                        placeholder="e.g. John Smith"
                        className="paragraph-editor"
                        style={parseStyle("min-height: auto; padding: var(--space-md);")}
                        autoFocus
                      />
                    </div>

                    <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                      <label style={parseStyle("display: block; margin-bottom: var(--space-sm); font-weight: 600;")}>
                        Your school email:
                      </label>
                      <input
                        type="email"
                        value={studentEmail}
                        onChange={(e) => { setStudentEmail(e.target.value); setError(''); setExistingProgress(null); }}
                        onBlur={(e) => checkExistingProgress(e.target.value)}
                        placeholder={`e.g. jsmith${REQUIRED_EMAIL_DOMAIN}`}
                        className="paragraph-editor"
                        style={parseStyle("min-height: auto; padding: var(--space-md);")}
                      />
                      <p style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted); margin-top: var(--space-xs);")}>
                        Must end with {REQUIRED_EMAIL_DOMAIN}
                      </p>
                    </div>
                  </>
                )}
                
                {/* Progress check - shown for both logged in and not */}
                {checkingProgress && (
                  <p style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: var(--space-md);")}>
                    Checking for saved progress...
                  </p>
                )}
                  
                {existingProgress && !checkingProgress && (
                  <div style={parseStyle("margin-bottom: var(--space-lg); padding: var(--space-md); background: rgba(255, 215, 0, 0.1); border: 1px solid var(--color-gold); border-radius: var(--radius-md);")}>
                    <p style={parseStyle("font-weight: 600; margin-bottom: var(--space-sm); color: var(--color-gold);")}>
                      Saved progress found!
                    </p>
                    <p style={parseStyle("font-size: 0.9rem; margin-bottom: var(--space-sm);")}>
                      You have {existingProgress.percentComplete || 0}% completed 
                      ({existingProgress.completedParagraphs || 0} of {existingProgress.totalParagraphs || '?'} paragraphs)
                      {existingProgress.lastUpdate && (
                        <span style={parseStyle("color: var(--color-text-muted);")}> - last saved {new Date(existingProgress.lastUpdate).toLocaleDateString()}</span>
                      )}
                    </p>
                    <div style={parseStyle("display: flex; gap: var(--space-sm); flex-wrap: wrap;")}>
                      <button 
                        type="button" 
                        className="btn btn-primary"
                        onClick={handleResumeProgress}
                      >
                        Continue where I left off
                      </button>
                      <button 
                        type="button" 
                        className="btn btn-secondary"
                        onClick={handleStartFresh}
                      >
                        Start fresh instead
                      </button>
                    </div>
                  </div>
                )}

                {/* TARGET GRADE SELECTOR */}
                <div className="grade-selector">
                  <label className="grade-selector-label">
                      What grade are you aiming for?
                  </label>
                  <p className="grade-selector-hint">
                    This helps us personalise the feedback to support your learning journey
                  </p>

                  <div className="grade-buttons">
                    {gradeSystemInfo.grades.map((grade) => (
                      <button
                        key={grade}
                        type="button"
                        className={getGradeButtonClass(grade)}
                        onClick={() => { setTargetGrade(grade); setError(''); }}
                      >
                        {grade}
                      </button>
                    ))}
                  </div>

                  {abilityTier && (
                    <div className={`grade-info-box ${abilityTier}`}>
                      <div className="grade-info-title">
                        {abilityTier === 'high' ? '&#128640; Aiming High!' :
                         abilityTier === 'foundation' ? '&#128679; Building Strong Foundations' :
                         '&#128200; Solid Progress'}
                      </div>
                      <div className="grade-info-text">
                        {gradeSystemInfo.descriptions[abilityTier]}
                        {abilityTier !== 'high' && " We'll always push you to exceed your target!"}
                      </div>
                    </div>
                  )}
                </div>

                {error && <p style={parseStyle("color: var(--color-error); margin-bottom: var(--space-md);")}>{error}</p>}

                <div style={parseStyle("display: flex; gap: var(--space-md); flex-wrap: wrap;")}>
                  <button type="submit" className="btn btn-primary btn-large">
                    Start Essay
                  </button>
                  <button
                    type="button"
                    className="btn btn-secondary"
                    onClick={onBack}
                  >&#8592; Back</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // =====================================================
    // TEACHER PREVIEW ENTRY SCREEN
    // =====================================================

    function TeacherPreviewEntry({ config, gradeSystem, onStartPreview, onBack }) {
      const [targetGrade, setTargetGrade] = useState('');

      const gradeSystemInfo = GRADE_SYSTEMS[gradeSystem] || GRADE_SYSTEMS.gcse;
      const abilityTier = targetGrade ? getAbilityTier(targetGrade, gradeSystem) : null;

      const handleStartPreview = () => {
        if (!targetGrade) {
          alert('Please select a target grade to test');
          return;
        }
        onStartPreview(targetGrade);
      };

      const getGradeButtonClass = (grade) => {
        const tier = getAbilityTier(grade, gradeSystem);
        let className = 'grade-button';
        if (targetGrade === grade) className += ' selected';
        if (tier === 'high') className += ' high-tier';
        if (tier === 'foundation') className += ' foundation-tier';
        return className;
      };

      if (!config) {
        return <div className="app-container"><LoadingSpinner text="Loading essay..." /></div>;
      }

      return (
        <div className="app-container">
          <div className="card ghost-appear">
            <div className="app-header" style={parseStyle("margin-bottom: 0; border: none; background: transparent; padding: var(--space-lg) 0;")}>
              <h1 className="gold-glow">Teacher Preview</h1>
              <p className="subtitle">{config.title}</p>
              <p style={parseStyle("color: var(--color-text-muted); margin-top: var(--space-sm);")}>
                {config.subject} - {config.yearGroup}
              </p>
            </div>

            <div style={parseStyle("margin-top: var(--space-lg); padding: var(--space-md); background: linear-gradient(135deg; border: 2px solid var(--color-primary); border-radius: var(--radius-md);")}>
              <p style={parseStyle("margin: 0; color: var(--color-text);")}>
                <strong style={parseStyle("color: var(--color-primary-light);")}>Preview Mode:</strong> Test the essay as a student would experience it. Pasting is enabled and progress is not saved.
              </p>
            </div>

            <div style={parseStyle("margin-top: var(--space-xl);")}>
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <p style={parseStyle("font-weight: 600; margin-bottom: var(--space-xs);")}>
                  Grade System Detected: <span style={parseStyle("color: var(--color-primary-light);")}>{gradeSystemInfo.name}</span>
                </p>
                <p style={parseStyle("font-size: 0.9rem; color: var(--color-text-muted);")}>
                  {gradeSystem === 'alevel' ? 'Letter grades (A*-E) will be used for feedback' : 'Number grades (9-1) will be used for feedback'}
                </p>
              </div>

              {/* TARGET GRADE SELECTOR */}
              <div className="grade-selector">
                <label className="grade-selector-label">
                  Select a target grade to test:
                </label>
                <p className="grade-selector-hint">
                  This determines how feedback is personalised for different ability levels
                </p>

                <div className="grade-buttons">
                  {gradeSystemInfo.grades.map((grade) => (
                    <button
                      key={grade}
                      type="button"
                      className={getGradeButtonClass(grade)}
                      onClick={() => setTargetGrade(grade)}
                    >
                      {grade}
                    </button>
                  ))}
                </div>

                {abilityTier && (
                  <div className={`grade-info-box ${abilityTier}`}>
                    <div className="grade-info-title">
                      {abilityTier === 'high' ? 'High-achieving student' :
                       abilityTier === 'foundation' ? 'Foundation-level student' :
                       'Middle-ability student'}
                    </div>
                    <div className="grade-info-text">
                      {gradeSystemInfo.descriptions[abilityTier]}
                    </div>
                  </div>
                )}
              </div>

              <div style={parseStyle("display: flex; gap: var(--space-md); margin-top: var(--space-xl); flex-wrap: wrap;")}>
                <button className="btn btn-primary btn-large" onClick={handleStartPreview}>
                  Start Preview
                </button>
                <button className="btn btn-secondary" onClick={onBack}>
                  Back to Dashboard
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // =====================================================
    // EXPANDABLE LEARNING MATERIAL
    // =====================================================
    
    function ExpandableLearningMaterial({ content, subject, essayContext, targetGrade }) {
      const containerRef = useRef(null);
      const [expandedHint, setExpandedHint] = useState(null); // { id, text, explanation, element }
      const [isLoading, setIsLoading] = useState(false);
      
      const handleHintClick = async (e) => {
        const li = e.target.closest('li');
        if (!li) return;
        
        const hintText = li.textContent.trim();
        const hintId = li.dataset.hintId;
        
        // If clicking the same hint, close it
        if (expandedHint && expandedHint.id === hintId) {
          setExpandedHint(null);
          return;
        }
        
        setIsLoading(true);
        setExpandedHint({ id: hintId, text: hintText, explanation: null, element: li });
        
        try {
          const response = await fetch('/.netlify/functions/expand-hint', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              hint: hintText,
              context: essayContext,
              subject: subject,
              targetGrade: targetGrade
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            setExpandedHint(prev => prev ? { ...prev, explanation: data.explanation } : null);
          } else {
            console.error('Failed to expand hint:', data.error);
            setExpandedHint(null);
          }
        } catch (error) {
          console.error('Error expanding hint:', error);
          setExpandedHint(null);
        } finally {
          setIsLoading(false);
        }
      };
      
      // Add hint IDs and click handlers to list items after render
      useEffect(() => {
        if (!containerRef.current) return;
        
        const listItems = containerRef.current.querySelectorAll('li');
        listItems.forEach((li, index) => {
          li.dataset.hintId = `hint-${index}`;
          li.classList.add('expandable-hint');
        });
      }, [content]);
      
      const closeHint = () => {
        setExpandedHint(null);
      };
      
      // Render the expansion panel
      const renderExpansion = () => {
        if (!expandedHint) return null;
        
        return (
          <div className="hint-expansion" style={parseStyle("margin: var(--space-md) 0;")}>
            <div className="hint-expansion-header">
              <span className="hint-expansion-title">More Information</span>
              <button 
                className="hint-expansion-close"
                onClick={closeHint}
                title="Close"
              >x</button>
            </div>
            {isLoading ? (
              <div className="hint-loading">
                <div className="hint-loading-spinner"></div>
                Getting more information...
              </div>
            ) : expandedHint.explanation ? (
              <div 
                className="hint-expansion-content"
                dangerouslySetInnerHTML={{ __html: renderMarkdown(expandedHint.explanation) }}
              />
            ) : null}
          </div>
        );
      };
      
      return (
        <div className="learning-material">
          <div style={parseStyle("display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);")}>
            <p style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted); margin: 0; font-style: italic;")}>
              Click on any bullet point below for more information
            </p>
            <TextToSpeech text={content} label="Read hints" targetGrade={targetGrade} />
          </div>
          <div 
            ref={containerRef}
            onClick={handleHintClick}
            dangerouslySetInnerHTML={{ __html: renderMarkdown(content) }}
          />
          {renderExpansion()}
        </div>
      );
    }
    
    // =====================================================
    // SOURCE MATERIAL CARD - Prominent display for reference text
    // =====================================================
    
    function SourceMaterialCard({ sourceMaterial, defaultExpanded = true }) {
      const [isExpanded, setIsExpanded] = useState(defaultExpanded);
      
      if (!sourceMaterial) return null;
      
      // Calculate approximate word count for hint
      const wordCount = sourceMaterial.split(/\s+/).length;
      
      return (
        <div className={`source-material-card ${!isExpanded ? 'collapsed' : ''}`}>
          <div 
            className="source-material-header"
            onClick={() => setIsExpanded(!isExpanded)}
          >
            <h3 className="source-material-title">
              <span className="source-material-title-icon"></span>
              Source Text
            </h3>
            <div className="source-material-toggle">
              <span>{isExpanded ? 'Click to collapse' : 'Click to expand'}</span>
              <span className="source-material-toggle-icon"></span>
            </div>
          </div>
          
          {!isExpanded && (
            <div className="source-material-hint">
              {wordCount} words  Click header to expand and read the source text
            </div>
          )}
          
          <div className="source-material-content">
            <div 
              className="source-material-text"
              dangerouslySetInnerHTML={{ __html: renderMarkdown(sourceMaterial) }}
            />
          </div>
        </div>
      );
    }
    
    // =====================================================
    // TECHNICAL ERROR CORRECTION - Interactive error fixing
    // =====================================================
    
    function TechnicalErrorCorrection({ 
      errors, 
      originalText, 
      onAllCorrected, 
      onUpdateText,
      onSkip 
    }) {
      const [currentErrorIndex, setCurrentErrorIndex] = useState(0);
      const [correctedErrors, setCorrectedErrors] = useState([]);
      const [skippedErrors, setSkippedErrors] = useState([]); // Track skipped errors
      const [currentText, setCurrentText] = useState(originalText);
      const [correctionInput, setCorrectionInput] = useState('');
      const [correctionStatus, setCorrectionStatus] = useState(null); // null, 'checking', 'error', 'success', 'skipped'
      const [correctionMessage, setCorrectionMessage] = useState('');
      const [showCelebration, setShowCelebration] = useState(false);
      
      const currentError = errors[currentErrorIndex];
      const isComplete = currentErrorIndex >= errors.length;
      
      // Apply correction to the text
      const applyCorrection = (text, errorText, correction) => {
        // Find and replace the error text with the correction
        // Use a simple replacement strategy
        return text.replace(errorText, correction);
      };
      
      // Check if the correction is valid (different from error and not empty)
      // CASE-SENSITIVE comparison so "dickens" -> "Dickens" is valid
      const validateCorrection = (correction, errorText) => {
        if (!correction.trim()) {
          return { valid: false, message: 'Please type your correction.' };
        }
        // Case-sensitive comparison - "Dickens" is different from "dickens"
        if (correction.trim() === errorText.trim()) {
          return { valid: false, message: 'Your correction looks exactly the same as the original. Try again!' };
        }
        return { valid: true };
      };
      
      const handleSubmitCorrection = () => {
        if (!currentError) return;
        
        setCorrectionStatus('checking');
        
        const validation = validateCorrection(correctionInput, currentError.errorText);
        
        if (!validation.valid) {
          setCorrectionStatus('error');
          setCorrectionMessage(validation.message);
          return;
        }
        
        // Accept the correction
        setCorrectionStatus('success');
        setCorrectionMessage('Excellent! You\'ve corrected this error.');
        
        // Apply the correction to the text
        const updatedText = applyCorrection(currentText, currentError.errorText, correctionInput);
        setCurrentText(updatedText);
        onUpdateText(updatedText);
        
        // Mark this error as corrected
        setCorrectedErrors([...correctedErrors, currentError.id]);
        
        // Move to next error after a brief delay
        setTimeout(() => {
          moveToNextOrComplete(updatedText);
        }, 1000);
      };
      
      // Skip the current error without correcting
      const handleSkipError = () => {
        setCorrectionStatus('skipped');
        setCorrectionMessage('Skipped - you can review this later.');
        
        // Mark this error as skipped
        setSkippedErrors([...skippedErrors, currentError.id]);
        
        // Move to next error after a brief delay
        setTimeout(() => {
          moveToNextOrComplete(currentText);
        }, 500);
      };
      
      // Move to next error or complete if done
      const moveToNextOrComplete = (textToUse) => {
        if (currentErrorIndex + 1 >= errors.length) {
          // Check if any errors were actually corrected
          const totalCorrected = correctedErrors.length + (correctionStatus === 'success' ? 1 : 0);
          if (totalCorrected > 0 || skippedErrors.length < errors.length) {
            setShowCelebration(true);
            setTimeout(() => {
              onAllCorrected(textToUse);
            }, 2000);
          } else {
            // All errors were skipped - proceed without celebration
            onAllCorrected(textToUse);
          }
        } else {
          setCurrentErrorIndex(currentErrorIndex + 1);
          setCorrectionInput('');
          setCorrectionStatus(null);
          setCorrectionMessage('');
        }
      };
      
      // Highlight the error in context
      const renderErrorContext = () => {
        if (!currentError) return null;
        
        const context = currentError.errorContext || '';
        const errorText = currentError.errorText || '';
        
        // Try to highlight the error within the context (case-insensitive for highlighting)
        const parts = context.split(new RegExp(`(${errorText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'i'));
        
        return (
          <div className="error-context">
            {parts.map((part, i) => 
              part.toLowerCase() === errorText.toLowerCase() 
                ? <span key={i} className="error-highlight">{part}</span>
                : part
            )}
          </div>
        );
      };
      
      // Show celebration when all errors are handled
      if (showCelebration) {
        const correctedCount = correctedErrors.length;
        const skippedCount = skippedErrors.length;
        
        return (
          <div className="technical-check-panel">
            <div className="errors-complete-celebration">
              <div className="celebration-icon"></div>
              <h3 className="celebration-title">Technical Check Complete!</h3>
              <p className="celebration-text">
                {correctedCount > 0 ? (
                  <>
                    Great work! You fixed {correctedCount} error{correctedCount !== 1 ? 's' : ''}.
                    {skippedCount > 0 && ` (${skippedCount} skipped)`}
                  </>
                ) : (
                  'Moving on to get feedback on your writing.'
                )}
              </p>
              <div className="loading-spinner" style={{ margin: '0 auto' }}></div>
              <p style={{ color: 'var(--color-text-muted)', fontSize: '0.9rem', marginTop: 'var(--space-md)' }}>
                Submitting for feedback...
              </p>
            </div>
          </div>
        );
      }
      
      if (!currentError) return null;
      
      return (
        <div className="technical-check-panel ghost-appear">
          <div className="technical-check-header">
            <h3 className="technical-check-title">
              <span></span>
              Technical Check
            </h3>
            <div className="technical-check-progress">
              <span>Error {currentErrorIndex + 1} of {errors.length}</span>
              <div className="error-progress-dots">
                {errors.map((_, i) => (
                  <div 
                    key={i} 
                    className={`error-progress-dot ${
                      correctedErrors.includes(errors[i]?.id) ? 'completed' : 
                      skippedErrors.includes(errors[i]?.id) ? 'skipped' :
                      i === currentErrorIndex ? 'current' : ''
                    }`}
                    title={
                      correctedErrors.includes(errors[i]?.id) ? 'Corrected' :
                      skippedErrors.includes(errors[i]?.id) ? 'Skipped' :
                      i === currentErrorIndex ? 'Current' : 'Pending'
                    }
                  />
                ))}
              </div>
            </div>
          </div>
          
          <div className="error-card">
            {/* Error type badge */}
            <div className={`error-type-badge ${currentError.type}`}>
              <span>{currentError.category?.icon || ''}</span>
              {currentError.category?.name || currentError.type}
            </div>
            
            {/* Error in context */}
            <div style={{ marginBottom: 'var(--space-md)' }}>
              <div style={{ fontSize: '0.85rem', color: 'var(--color-text-muted)', marginBottom: 'var(--space-xs)' }}>
                Find the error in this section of your writing:
              </div>
              {renderErrorContext()}
            </div>
            
            {/* Rule explanation */}
            <div className="error-rule">
              <div className="error-rule-label">
                <span></span> The Rule
              </div>
              <div className="error-rule-text">{currentError.rule}</div>
            </div>
            
            {/* Hint */}
            <div className="error-hint">
              <div className="error-hint-label">
                <span></span> Hint
              </div>
              <div className="error-hint-text">{currentError.hint}</div>
            </div>
            
            {/* Correction input */}
            <div className="error-correction-area">
              <div className="error-correction-label">
                Type your correction for "<span style={{ color: 'var(--color-error)' }}>{currentError.errorText}</span>":
              </div>
              <input
                type="text"
                className={`error-correction-input ${correctionStatus === 'error' ? 'error' : correctionStatus === 'success' ? 'success' : ''}`}
                value={correctionInput}
                onChange={(e) => {
                  setCorrectionInput(e.target.value);
                  if (correctionStatus) {
                    setCorrectionStatus(null);
                    setCorrectionMessage('');
                  }
                }}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    handleSubmitCorrection();
                  }
                }}
                placeholder="Type the corrected word or phrase..."
                autoFocus
                disabled={correctionStatus === 'success'}
              />
              {correctionMessage && (
                <div className={`correction-feedback ${correctionStatus}`}>
                  {correctionStatus === 'success' ? '' : correctionStatus === 'skipped' ? '' : ''} {correctionMessage}
                </div>
              )}
            </div>
          </div>
          
          <div className="technical-check-actions">
            <button 
              className="btn btn-secondary"
              onClick={onSkip}
              style={{ opacity: 0.6, fontSize: '0.85rem' }}
              title="Skip all remaining technical checks"
            >
              Skip All Remaining
            </button>
            <button 
              className="btn btn-secondary"
              onClick={handleSkipError}
              disabled={correctionStatus === 'success' || correctionStatus === 'skipped'}
              style={{ opacity: 0.8 }}
              title="Skip just this error and move to the next one"
            >
              Skip This Error 
            </button>
            <button 
              className="btn btn-primary"
              onClick={handleSubmitCorrection}
              disabled={!correctionInput.trim() || correctionStatus === 'success' || correctionStatus === 'skipped'}
            >
              {correctionStatus === 'success' ? 'Correct! ' : 'Submit Correction'}
            </button>
          </div>
        </div>
      );
    }
    
// PARAGRAPH SCREEN
    // =====================================================
    
    function ParagraphScreen({ paragraph, paragraphState, paragraphStates, onSubmitAttempt, onComplete, previewMode, config, gradingCriteria, gradeBoundaries, totalMarks, targetGrade, gradeSystem }) {
      const [text, setText] = useState(paragraphState?.currentText || '');
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [showFeedback, setShowFeedback] = useState(false);
      const [currentFeedback, setCurrentFeedback] = useState(null);
      const [cumulativeInfo, setCumulativeInfo] = useState(null);  // For cumulative grading display
      const [authenticityCheck, setAuthenticityCheck] = useState(null);  // For authenticity check results
      
      // Two-stage submission states
      const [submissionStage, setSubmissionStage] = useState('writing'); // 'writing', 'technical-check', 'correcting', 'grading'
      const [technicalErrors, setTechnicalErrors] = useState([]);
      const [isCheckingTechnical, setIsCheckingTechnical] = useState(false);
      const [originalTextBeforeCorrections, setOriginalTextBeforeCorrections] = useState(null); // Captures text before any corrections
      
      const textareaRef = useRef(null);
      
      const wordCount = countWords(text);
      const minWords = config?.minWordsPerParagraph || 50;
      const targetWords = config?.targetWordsPerParagraph || 100;
      const attemptNumber = (paragraphState?.attempts || 0) + 1;
      const maxAttempts = config?.maxAttempts || 3;
      const canSubmit = wordCount >= minWords && !isSubmitting;
      
      // Check if we have authentic grade boundaries
      const hasAuthenticDescriptors = gradeBoundaries && Array.isArray(gradeBoundaries) && gradeBoundaries.length > 0;
      
      // Determine ability tier from target grade
      const getAbilityTier = (grade) => {
        const highGrades = ['9', '8', '7', 'A*', 'A'];
        const foundationGrades = ['3', '2', '1', 'D', 'E'];
        if (highGrades.includes(grade)) return 'advanced';
        if (foundationGrades.includes(grade)) return 'foundation';
        return 'intermediate';
      };
      
      // Get the appropriate learning material for student's level
      const getLearningMaterial = () => {
        if (typeof paragraph.learningMaterial === 'string') {
          return paragraph.learningMaterial;
        }
        if (typeof paragraph.learningMaterial === 'object') {
          const tier = getAbilityTier(targetGrade || '5');
          return paragraph.learningMaterial[tier] || paragraph.learningMaterial.intermediate || '';
        }
        return '';
      };
      
      useEffect(() => {
        if (paragraphState?.lastFeedback && !paragraphState?.completed) {
          setCurrentFeedback(paragraphState.lastFeedback);
          setShowFeedback(true);
        }
      }, [paragraphState]);
      
      // Stage 1: Technical Check
      const handleTechnicalCheck = async () => {
        if (!canSubmit) return;
        setIsCheckingTechnical(true);
        setSubmissionStage('technical-check');
        
        // Capture the original text BEFORE any corrections
        // This is the student's raw first attempt
        if (!originalTextBeforeCorrections) {
          setOriginalTextBeforeCorrections(text);
        }
        
        try {
          const response = await fetch('/.netlify/functions/check-technical', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paragraphText: text,
              paragraphTitle: paragraph.title,
              targetGrade: targetGrade,
              gradeSystem: gradeSystem
            })
          });
          
          const data = await response.json();
          console.log('[ParagraphScreen] Technical check:', {
            success: data.success,
            hasErrors: data.hasErrors,
            errorCount: data.errorCount
          });
          
          if (data.success) {
            if (data.hasErrors && data.errors.length > 0) {
              // Errors found - switch to correction mode
              setTechnicalErrors(data.errors);
              setSubmissionStage('correcting');
              setIsCheckingTechnical(false);
            } else {
              // No errors - proceed directly to grading
              setIsCheckingTechnical(false);
              await handleMainGrading(text, text); // original and corrected are the same
            }
          } else {
            throw new Error(data.error || 'Technical check failed');
          }
        } catch (error) {
          console.error('Technical check error:', error);
          // On error, skip technical check and proceed to grading
          setIsCheckingTechnical(false);
          await handleMainGrading(text, text);
        }
      };
      
      // Called when all technical errors are corrected
      const handleErrorsCorrected = async (correctedText) => {
        setText(correctedText);
        setSubmissionStage('grading');
        setTechnicalErrors([]);
        // Pass both original and corrected text
        await handleMainGrading(correctedText, originalTextBeforeCorrections || text);
      };
      
      // Called when user updates text during correction
      const handleUpdateTextDuringCorrection = (updatedText) => {
        setText(updatedText);
      };
      
      // Skip technical check and go straight to grading
      const handleSkipTechnicalCheck = async () => {
        setSubmissionStage('grading');
        setTechnicalErrors([]);
        // When skipping, original and corrected are the same
        await handleMainGrading(text, originalTextBeforeCorrections || text);
      };
      
      // Stage 2: Main Grading (original handleSubmit logic)
      const handleMainGrading = async (textToGrade, originalText) => {
        const paragraphText = textToGrade || text;
        const originalParagraphText = originalText || originalTextBeforeCorrections || paragraphText;
        setIsSubmitting(true);
        setShowFeedback(false);
        setSubmissionStage('grading');
        
        // Collect completed paragraphs for cumulative grading
        const completedParagraphs = config?.paragraphs
          ?.filter(p => {
            const state = paragraphStates?.[p.id];
            return state?.completed && p.id !== paragraph.id;
          })
          .map(p => ({
            title: p.title,
            type: p.type,
            text: paragraphStates[p.id]?.finalText || ''
          })) || [];
        
        // Log what we're sending to help debug
        console.log('[ParagraphScreen] Cumulative grading:', {
          completedCount: completedParagraphs.length,
          currentParagraph: paragraph.title,
          hasGradeBoundaries: !!gradeBoundaries,
          hasOriginalText: originalParagraphText !== paragraphText
        });
        
        try {
          const requestBody = {
            paragraphText: paragraphText,
            paragraphConfig: paragraph,
            attemptNumber: attemptNumber,
            maxAttempts: maxAttempts,
            previousFeedback: paragraphState?.feedbackHistory || [],
            completedParagraphs: completedParagraphs,  // For cumulative grading
            essayTitle: config?.essayTitle,
            gradingCriteria: gradingCriteria,
            gradeBoundaries: gradeBoundaries,  // Pass authentic grade descriptors if available
            totalMarks: totalMarks,            // Pass total marks for the essay
            targetGrade: targetGrade,
            gradeSystem: gradeSystem
          };
          
          const response = await fetch('/.netlify/functions/grade-paragraph', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });
          
          const data = await response.json();
          console.log('[ParagraphScreen] API response:', {
            success: data.success,
            usedAuthenticDescriptors: data.usedAuthenticDescriptors,
            estimatedGrade: data.feedback?.estimatedGrade,
            authenticityCheck: data.authenticityCheck
          });
          
          if (data.success) {
            setCurrentFeedback(data.feedback);
            setCumulativeInfo({
              isCumulative: data.isCumulative,
              paragraphCount: data.paragraphCount,
              currentParagraphTitle: data.currentParagraphTitle
            });
            // Store authenticity check results
            setAuthenticityCheck(data.authenticityCheck || null);
            
            // Log if authenticity warning triggered
            if (data.authenticityCheck?.isSuspicious) {
              console.warn('[ParagraphScreen] Authenticity warning:', data.authenticityCheck);
            }
            
            setSubmissionStage('writing');
            setShowFeedback(true);
            onSubmitAttempt({
              text: paragraphText,
              originalText: originalParagraphText, // Pass original text for comparison
              feedback: data.feedback,
              attemptNumber: attemptNumber,
              canRevise: data.canRevise,
              isLastAttempt: data.isLastAttempt,
              estimatedGrade: data.feedback.estimatedGrade || null,
              usedAuthenticDescriptors: data.usedAuthenticDescriptors || false,
              authenticityCheck: data.authenticityCheck || null
            });
          } else {
            throw new Error(data.error || 'Failed to grade paragraph');
          }
        } catch (error) {
          console.error('Grading error:', error);
          alert('Failed to submit. Please try again.');
          setSubmissionStage('writing');
        } finally {
          setIsSubmitting(false);
        }
      };
      
      // Legacy handleSubmit - now starts the two-stage process
      const handleSubmit = async () => {
        await handleTechnicalCheck();
      };
      
      const handleRevise = () => {
        setShowFeedback(false);
        setCurrentFeedback(null);
        setAuthenticityCheck(null);  // Reset authenticity check on revision
        setSubmissionStage('writing');
        setTechnicalErrors([]);
        textareaRef.current?.focus();
      };
      
      const handleAccept = () => {
        onComplete(text, currentFeedback);
      };
      
      const wordCountClass = wordCount < minWords ? 'warning' : wordCount >= targetWords ? 'success' : '';
      
      return (
        <div className="card ghost-appear">
          <div style={parseStyle("margin-bottom: var(--space-lg);")}>
            <div style={parseStyle("display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);")}>
              <span style={{
                background: paragraph.type === 'introduction'
                  ? 'var(--color-info-bg)'
                  : (paragraph.type === 'conclusion'
                      ? 'var(--color-success-bg)'
                      : 'var(--color-surface-hover)'),
                color: paragraph.type === 'introduction'
                  ? 'var(--color-info)'
                  : (paragraph.type === 'conclusion'
                      ? 'var(--color-success)'
                      : 'var(--color-primary-light)'),
                padding: 'var(--space-xs) var(--space-md)',
                borderRadius: 'var(--radius-full)',
                fontSize: '0.8rem',
                fontWeight: 600,
                textTransform: 'uppercase'
              }}>
                {paragraph.type}
              </span>
              <h2 style={parseStyle("margin: 0;")}>{paragraph.title}</h2>
            </div>
          </div>
          
          {/* Source Material Card - Prominent display at top */}
          <SourceMaterialCard 
            sourceMaterial={config?.sourceMaterial || paragraph?.sourceMaterial}
            defaultExpanded={true}
          />
          
          <ExpandableLearningMaterial 
            content={getLearningMaterial()} 
            subject={config?.subject || 'English'}
            essayContext={config?.essayTitle || paragraph.writingPrompt}
            targetGrade={targetGrade}
          />
          
          <div className="writing-prompt">
            <div className="writing-prompt-label">Your Task</div>
            <div className="writing-prompt-text">{paragraph.writingPrompt}</div>
          </div>
          
          <div className="attempt-indicator">
            <span className="attempt-badge">Attempt {attemptNumber} of {maxAttempts}</span>
            {attemptNumber < maxAttempts && (
              <span className="attempts-remaining">
                {maxAttempts - attemptNumber} revision{maxAttempts - attemptNumber !== 1 ? 's' : ''} remaining
              </span>
            )}
          </div>
          
          {/* Technical Error Correction Stage */}
          {submissionStage === 'correcting' && technicalErrors.length > 0 && (
            <TechnicalErrorCorrection
              errors={technicalErrors}
              originalText={text}
              onAllCorrected={handleErrorsCorrected}
              onUpdateText={handleUpdateTextDuringCorrection}
              onSkip={handleSkipTechnicalCheck}
            />
          )}
          
          {/* Technical Check Loading */}
          {isCheckingTechnical && (
            <div style={parseStyle("margin-top: var(--space-lg); margin-bottom: var(--space-lg);")}>
              <LoadingSpinner text="Checking spelling, grammar and punctuation..." />
            </div>
          )}
          
          {/* Writing Stage - Show textarea when not in correction mode */}
          {!showFeedback && submissionStage !== 'correcting' && !isCheckingTechnical && (
            <>
              <textarea
                ref={textareaRef}
                className="paragraph-editor"
                value={text}
                onChange={(e) => setText(e.target.value)}
                onPaste={previewMode ? undefined : (e) => {
                  e.preventDefault();
                  alert('Pasting is not allowed. Please type your response.');
                }}
                onDrop={previewMode ? undefined : (e) => {
                  e.preventDefault();
                  alert('Drag and drop is not allowed. Please type your response.');
                }}
                placeholder="Start writing your paragraph here..."
                disabled={isSubmitting || submissionStage === 'grading'}
                spellCheck={false}
                autoCorrect="off"
                autoCapitalize="off"
                autoComplete="off"
                data-gramm="false"
                data-gramm_editor="false"
                data-enable-grammarly="false"
              />
              
              <div className={`word-count ${wordCountClass}`}>
                <span>{wordCount} words {wordCount < minWords && `(minimum ${minWords})`}</span>
                <span>Target: {targetWords} words</span>
              </div>
              
              {isSubmitting || submissionStage === 'grading' ? (
                <div style={parseStyle("margin-top: var(--space-lg);")}>
                  <LoadingSpinner text="Grading your writing..." />
                </div>
              ) : (
                <div style={parseStyle("margin-top: var(--space-lg);")}>
                  <button className="btn btn-primary btn-large" onClick={handleSubmit} disabled={!canSubmit}>
                     Check & Submit for Feedback
                  </button>
                  <p style={{ 
                    fontSize: '0.85rem', 
                    color: 'var(--color-text-muted)', 
                    marginTop: 'var(--space-sm)',
                    textAlign: 'center'
                  }}>
                    We'll first check for spelling and grammar, then give you detailed feedback
                  </p>
                </div>
              )}
            </>
          )}
          
          {showFeedback && currentFeedback && (
            <FeedbackDisplay
              feedback={currentFeedback}
              attemptNumber={paragraphState?.attempts || attemptNumber}
              canRevise={(paragraphState?.attempts || attemptNumber) < maxAttempts}
              cumulativeInfo={cumulativeInfo}
              onRevise={handleRevise}
              onAccept={handleAccept}
              targetGrade={targetGrade}
              authenticityCheck={authenticityCheck}
            />
          )}
        </div>
      );
    }
    
    // =====================================================
    // ESSAY COMPILATION SCREEN
    // =====================================================
    
    function EssayCompilationScreen({ studentName, paragraphs, paragraphStates, onRequestFeedback, onRequestOfficialGrading, essayFeedback, officialGrading, isLoadingFeedback, isLoadingOfficialGrading, config }) {
      const [showFeedback, setShowFeedback] = useState(!!essayFeedback);
      const [showOfficialGrading, setShowOfficialGrading] = useState(!!officialGrading);
      const [autoRequestedFeedback, setAutoRequestedFeedback] = useState(false);
      
      // Comparison states
      const [essayComparison, setEssayComparison] = useState(null);
      const [isLoadingComparison, setIsLoadingComparison] = useState(false);
      const [autoRequestedComparison, setAutoRequestedComparison] = useState(false);
      
      // Check if there are differences between original and final
      const hasOriginalVersions = paragraphs.some(p => {
        const state = paragraphStates[p.id];
        return state?.originalBeforeCorrections && state?.finalText && 
               state.originalBeforeCorrections !== state.finalText;
      });
      
      // Auto-request feedback when compilation screen loads (if not already done)
      useEffect(() => {
        if (!essayFeedback && !isLoadingFeedback && !autoRequestedFeedback) {
          console.log('[EssayCompilationScreen] Auto-requesting essay feedback');
          setAutoRequestedFeedback(true);
          onRequestFeedback();
        }
      }, [essayFeedback, isLoadingFeedback, autoRequestedFeedback, onRequestFeedback]);
      
      // Auto-request comparison after feedback loads (if originals exist)
      useEffect(() => {
        if (essayFeedback && hasOriginalVersions && !essayComparison && !isLoadingComparison && !autoRequestedComparison) {
          console.log('[EssayCompilationScreen] Auto-requesting essay comparison');
          setAutoRequestedComparison(true);
          fetchEssayComparison();
        }
      }, [essayFeedback, hasOriginalVersions, essayComparison, isLoadingComparison, autoRequestedComparison]);
      
      // Fetch comparison between original and improved essays
      const fetchEssayComparison = async () => {
        setIsLoadingComparison(true);
        
        try {
          const originalParagraphs = paragraphs.map(p => ({
            title: p.title,
            type: p.type,
            text: paragraphStates[p.id]?.originalBeforeCorrections || paragraphStates[p.id]?.initialText || paragraphStates[p.id]?.finalText || ''
          }));
          
          const improvedParagraphs = paragraphs.map(p => ({
            title: p.title,
            type: p.type,
            text: paragraphStates[p.id]?.finalText || ''
          }));
          
          const response = await fetch('/.netlify/functions/compare-essays', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              studentName,
              essayTitle: config?.essayTitle,
              originalParagraphs,
              improvedParagraphs,
              gradeBoundaries: config?.gradeBoundaries || null,
              totalMarks: config?.totalMarks || 40,
              targetGrade: essayFeedback?.targetGrade || '5',
              gradeSystem: config?.gradeSystem || 'gcse'
            })
          });
          
          const data = await response.json();
          if (data.success) {
            setEssayComparison(data.comparison);
            console.log('[EssayCompilationScreen] Comparison loaded:', data.comparison);
          }
        } catch (error) {
          console.error('Failed to fetch essay comparison:', error);
        } finally {
          setIsLoadingComparison(false);
        }
      };
      
      useEffect(() => {
        if (essayFeedback) setShowFeedback(true);
      }, [essayFeedback]);
      
      useEffect(() => {
        if (officialGrading) setShowOfficialGrading(true);
      }, [officialGrading]);
      
      const hasOfficialMarkScheme = !!config?.officialMarkScheme;
      
      const compiledParagraphs = paragraphs.map(p => ({
        ...p,
        text: paragraphStates[p.id]?.finalText || '',
        initialText: paragraphStates[p.id]?.initialText || '',
        score: paragraphStates[p.id]?.score || 0
      }));
      
      // Generate printable report
      const generatePrintableReport = () => {
        const fullEssay = compiledParagraphs.map(p => p.text).join('\n\n');
        const date = new Date().toLocaleDateString('en-GB', { 
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });
        
        let report = `
========================================================
                        ESSAY ASSESSMENT REPORT
========================================================

Student: ${studentName}
Date: ${date}
Subject: ${config?.subject || ''}
Essay Title: ${config?.essayTitle || ''}
========================================================
                           YOUR ESSAY
========================================================

${fullEssay}

`;
        
        // Add Feedback if available
        if (essayFeedback) {
          report += `
========================================================
                        FEEDBACK
========================================================

OVERALL SCORE: ${essayFeedback.finalScore || essayFeedback.overallScore}%
GRADE: ${essayFeedback.overallGrade}
========================================================
SUMMARY
========================================================
${essayFeedback.essaySummary || 'No summary available.'}

`;
          if (essayFeedback.bestQuotation) {
            report += `
========================================================
YOUR BEST WRITING
========================================================
"${essayFeedback.bestQuotation}"

`;
          }
          
          if (essayFeedback.holisticStrengths && essayFeedback.holisticStrengths.length > 0) {
            report += `
========================================================
STRENGTHS
========================================================
${essayFeedback.holisticStrengths.map((s, i) => `${i + 1}. ${s}`).join('\n')}

`;
          }
          
          if (essayFeedback.holisticImprovements && essayFeedback.holisticImprovements.length > 0) {
            report += `
========================================================
AREAS FOR DEVELOPMENT
========================================================
${essayFeedback.holisticImprovements.map((s, i) => `${i + 1}. ${s}`).join('\n')}

`;
          }
          
          if (essayFeedback.closingEncouragement) {
            report += `
========================================================
TEACHER'S ENCOURAGEMENT
========================================================
${essayFeedback.closingEncouragement}

`;
          }
        }
        
        // Add Official Grading if available
        if (officialGrading) {
          const { initialVersion, improvedVersion, comparison, examinerComment } = officialGrading;
          
          report += `
========================================================
              OFFICIAL MARK SCHEME GRADING
          ${config.officialMarkScheme.examBoard} ${config.officialMarkScheme.qualification}
========================================================
========================================================
IMPROVEMENT SUMMARY
========================================================

Initial Version:  ${initialVersion.totalMark}/${config.officialMarkScheme.totalMarks} (Grade ${initialVersion.grade})
Final Version:    ${improvedVersion.totalMark}/${config.officialMarkScheme.totalMarks} (Grade ${improvedVersion.grade})
Improvement:      +${comparison.marksImproved} marks (${comparison.gradeChange})

Most Improved Area: ${comparison.mostImprovedArea}
${comparison.improvementSummary}
========================================================
INITIAL VERSION ASSESSMENT
========================================================
Mark: ${initialVersion.totalMark}/${config.officialMarkScheme.totalMarks} | Grade: ${initialVersion.grade} | Level: ${initialVersion.level}

Assessment Objectives:
${Object.entries(initialVersion.aoBreakdown).map(([ao, data]) => 
  `  ${ao}: ${data.mark} marks (Level ${data.level})\n    ${data.justification}`
).join('\n\n')}

Strengths:
${initialVersion.keyStrengths.map((s, i) => `  ${i + 1}. ${s}`).join('\n')}

Areas to Improve:
${initialVersion.keyWeaknesses.map((w, i) => `  ${i + 1}. ${w}`).join('\n')}
========================================================
FINAL VERSION ASSESSMENT
========================================================
Mark: ${improvedVersion.totalMark}/${config.officialMarkScheme.totalMarks} | Grade: ${improvedVersion.grade} | Level: ${improvedVersion.level}

Assessment Objectives:
${Object.entries(improvedVersion.aoBreakdown).map(([ao, data]) => 
  `  ${ao}: ${data.mark} marks (Level ${data.level})\n    ${data.justification}`
).join('\n\n')}

Strengths:
${improvedVersion.keyStrengths.map((s, i) => `  ${i + 1}. ${s}`).join('\n')}

Areas to Improve:
${improvedVersion.keyWeaknesses.map((w, i) => `  ${i + 1}. ${w}`).join('\n')}

`;
          
          if (comparison.remainingTargets && comparison.remainingTargets.length > 0) {
            report += `
========================================================
NEXT STEPS TO IMPROVE FURTHER
========================================================
${comparison.remainingTargets.map((t, i) => `${i + 1}. ${t}`).join('\n')}

`;
          }
          
          report += `
========================================================
EXAMINER'S COMMENT
========================================================
${examinerComment}

`;
        }
        
        report += `
========================================================
                      END OF REPORT
========================================================
`;
        
        return report;
      };
      
      // Print full report
      const handlePrintReport = () => {
        const report = generatePrintableReport();
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Essay Assessment Report - ${studentName}</title>
            <style>
              body {
                font-family: 'Courier New', monospace;
                font-size: 12px;
                line-height: 1.5;
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
                white-space: pre-wrap;
                word-wrap: break-word;
              }
              @media print {
                body { padding: 0; }
              }
            </style>
          </head>
          <body>${report.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      };
      
      // Copy report to clipboard
      const handleCopyReport = async () => {
        const report = generatePrintableReport();
        try {
          await navigator.clipboard.writeText(report);
          alert('Report copied to clipboard!');
        } catch (err) {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = report;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          alert('Report copied to clipboard!');
        }
      };
      
      const handlePrint = () => window.print();
      
      // Official grading display component
      const OfficialGradingDisplay = ({ grading }) => {
        const { initialVersion, improvedVersion, comparison, examinerComment } = grading;
        
        const VersionCard = ({ version, title, isImproved }) => (
          <div className="card" style={{
                    flex: 1,
                    background: isImproved
                      ? 'linear-gradient(145deg, rgba(34, 197, 94, 0.12), rgba(34, 197, 94, 0.06))'
                      : 'var(--color-bg)',
                    border: isImproved ? '2px solid var(--color-success)' : '1px solid var(--color-border)',
                    borderRadius: 'var(--radius-md)',
                    padding: 'var(--space-md)'
                  }}>
            <h4 style={{ marginBottom: 'var(--space-md)', color: isImproved ? 'var(--color-success)' : 'var(--color-text-muted)' }}>
              {title}
            </h4>
            
            <div style={parseStyle("display: flex; align-items: center; gap: var(--space-lg); margin-bottom: var(--space-lg);")}>
              <div style={parseStyle("font-size: 3rem; font-weight: 700; font-family: var(--font-display); color: var(--color-primary-light);")}>
                {version.totalMark}<span style={parseStyle("font-size: 1.5rem; color: var(--color-text-muted);")}>/{config.officialMarkScheme.totalMarks}</span>
              </div>
              <div>
                <div style={parseStyle("font-size: 2rem; font-weight: 700; background: linear-gradient(135deg; webkit-background-clip: text; webkit-text-fill-color: transparent;")}>
                  Grade {version.grade}
                </div>
                <div style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted);")}>
                  Level {version.level}  {version.percentage}%
                </div>
              </div>
            </div>
            
            <div style={parseStyle("margin-bottom: var(--space-md);")}>
              <strong>Assessment Objective Breakdown:</strong>
            </div>
            
            {Object.entries(version.aoBreakdown).map(([ao, data]) => (
              <div key={ao} style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-md); background: var(--color-bg); border-radius: var(--radius-md); border-left: 3px solid var(--color-primary);")}>
                <div style={parseStyle("display: flex; justify-content: space-between; margin-bottom: var(--space-xs);")}>
                  <strong>{ao}</strong>
                  <span style={parseStyle("color: var(--color-primary-light);")}>
                    {data.mark} marks (Level {data.level})
                  </span>
                </div>
                <p style={parseStyle("font-size: 0.9rem; color: var(--color-text-secondary); margin: 0;")}>
                  {data.justification}
                </p>
              </div>
            ))}
            
            <div style={parseStyle("margin-top: var(--space-lg);")}>
              <p style={parseStyle("font-style: italic; color: var(--color-text-secondary);")}>
                {version.overallComment}
              </p>
            </div>
            
            <div style={parseStyle("display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-top: var(--space-md);")}>
              <div>
                <strong style={parseStyle("color: var(--color-success); font-size: 0.85rem;")}> Strengths</strong>
                <ul style={parseStyle("margin: var(--space-xs) 0 0 var(--space-md); padding: 0; font-size: 0.85rem;")}>
                  {version.keyStrengths.map((s, i) => <li key={i}>{s}</li>)}
                </ul>
              </div>
              <div>
                <strong style={parseStyle("color: var(--color-warning); font-size: 0.85rem;")}> To Improve</strong>
                <ul style={parseStyle("margin: var(--space-xs) 0 0 var(--space-md); padding: 0; font-size: 0.85rem;")}>
                  {version.keyWeaknesses.map((w, i) => <li key={i}>{w}</li>)}
                </ul>
              </div>
            </div>
          </div>
        );
        
        return (
          <div className="ghost-appear">
            <div className="holistic-feedback" style={parseStyle("margin-top: var(--space-xl);")}>
              <div className="holistic-header">
                <div>
                  <h2 style={parseStyle("margin-bottom: var(--space-sm);")}> Official Mark Scheme Grading</h2>
                  <p style={parseStyle("color: var(--color-text-muted);")}>
                    {config.officialMarkScheme.examBoard} {config.officialMarkScheme.qualification}  {config.officialMarkScheme.paper}
                  </p>
                </div>
              </div>
              
              {/* Improvement Summary */}
              <div className="card" style={parseStyle("background: linear-gradient(135deg; border: 2px solid var(--color-primary); margin-bottom: var(--space-xl);")}>
                <div style={parseStyle("display: flex; justify-content: space-around; align-items: center; text-align: center; flex-wrap: wrap; gap: var(--space-lg);")}>
                  <div>
                    <div style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: var(--space-xs);")}>Initial</div>
                    <div style={parseStyle("font-size: 2rem; font-weight: 700;")}>{initialVersion.totalMark}</div>
                    <div style={parseStyle("color: var(--color-text-muted);")}>Grade {initialVersion.grade}</div>
                  </div>
                  
                  <div style={parseStyle("font-size: 2rem; color: var(--color-primary);")}></div>
                  
                  <div>
                    <div style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: var(--space-xs);")}>Improved</div>
                    <div style={parseStyle("font-size: 2rem; font-weight: 700; color: var(--color-success);")}>{improvedVersion.totalMark}</div>
                    <div style={parseStyle("color: var(--color-success);")}>Grade {improvedVersion.grade}</div>
                  </div>
                  
                  <div style={parseStyle("padding: var(--space-md) var(--space-lg); background: var(--color-success-bg); border-radius: var(--radius-md); border: 1px solid var(--color-success);")}>
                    <div style={parseStyle("font-size: 0.85rem; color: var(--color-success); margin-bottom: var(--space-xs);")}>Improvement</div>
                    <div style={parseStyle("font-size: 1.5rem; font-weight: 700; color: var(--color-success);")}>
                      +{comparison.marksImproved} marks
                    </div>
                    <div style={parseStyle("font-size: 0.85rem; color: var(--color-success);")}>{comparison.gradeChange}</div>
                  </div>
                </div>
                
                <div style={parseStyle("margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--color-border);")}>
                  <p style={parseStyle("margin: 0;")}><strong>Most improved:</strong> {comparison.mostImprovedArea}</p>
                  <p style={parseStyle("margin: var(--space-sm) 0 0 0; color: var(--color-text-secondary);")}>{comparison.improvementSummary}</p>
                </div>
              </div>
              
              {/* Side by side comparison */}
              <div style={parseStyle("display: flex; gap: var(--space-lg); margin-bottom: var(--space-xl); flex-wrap: wrap;")}>
                <VersionCard version={initialVersion} title=" Initial Version (First Attempt)" isImproved={false} />
                <VersionCard version={improvedVersion} title=" Improved Version (Final)" isImproved={true} />
              </div>
              
              {/* Remaining targets */}
              {comparison.remainingTargets && comparison.remainingTargets.length > 0 && (
                <div className="card" style={parseStyle("margin-bottom: var(--space-xl);")}>
                  <h4 style={parseStyle("margin-bottom: var(--space-md);")}>  Next Steps to Improve Further</h4>
                  <ul style={parseStyle("margin: 0; padding-left: var(--space-lg);")}>
                    {comparison.remainingTargets.map((target, i) => (
                      <li key={i} style={parseStyle("margin-bottom: var(--space-sm);")}>{target}</li>
                    ))}
                  </ul>
                </div>
              )}
              
              {/* Examiner comment */}
              <div className="encouragement-box">
                <p><strong>Examiner's Comment:</strong> {examinerComment}</p>
              </div>
            </div>
          </div>
        );
      };
      
      return (
        <div className="ghost-appear">
          {/* Show loading indicator while feedback is being generated */}
          {isLoadingFeedback && (
            <div className="card" style={parseStyle("text-align: center; padding: var(--space-lg); margin-bottom: var(--space-lg); background: linear-gradient(135deg, rgba(184, 134, 11, 0.1), rgba(184, 134, 11, 0.05)); border: 1px solid var(--color-primary);")}>
              <LoadingSpinner text="Generating feedback on your complete essay..." />
            </div>
          )}
          
          {/* Essay Section */}
          <div className="essay-compilation">
            <div className="essay-compilation-header">
              <h1 className="essay-compilation-title">{config?.essayTitle}</h1>
              <p className="essay-compilation-meta">By {studentName}  {config?.subject}  {formatDateTime(new Date())}</p>
            </div>
            
            <div className="compiled-essay">
              {compiledParagraphs.map((para) => (
                <p key={para.id} className="compiled-paragraph">{para.text}</p>
              ))}
            </div>
          </div>
          
          {/* Feedback Section - shows automatically when ready */}
          {showFeedback && essayFeedback && (
                <div className="holistic-feedback">
                  <div className="holistic-header">
                    <div>
                      <h2 style={parseStyle("margin-bottom: var(--space-sm);")}> Essay Feedback</h2>
                      <p style={parseStyle("color: var(--color-text-muted);")}>Overall assessment of your complete essay</p>
                    </div>
                    <div className="final-grade">
                      <div className={`grade-badge ${getGradeClass(essayFeedback.overallGrade)}`}>
                        {essayFeedback.overallGrade}
                      </div>
                      <div style={parseStyle("text-align: center;")}>
                        <div style={parseStyle("font-size: 2rem; font-weight: 700; font-family: var(--font-display);")}>
                          {essayFeedback.finalScore || essayFeedback.overallScore}%
                        </div>
                        <div style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted);")}>Final Score</div>
                      </div>
                    </div>
                  </div>
                  
                  {essayFeedback.essaySummary && (
                    <div className="feedback-section">
                      <div className="feedback-section-title"><span>&#9733; Summary</span></div>
                      <div className="detailed-feedback">{essayFeedback.essaySummary}</div>
                    </div>
                  )}
                  
                  {essayFeedback.bestQuotation && (
                    <div className="best-quote">
                      <div className="best-quote-label"> Your Best Writing</div>
                      "{essayFeedback.bestQuotation}"
                    </div>
                  )}
                  
                  <div style={parseStyle("display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-top: var(--space-xl);")}>
                    {essayFeedback.holisticStrengths && (
                      <div className="feedback-section">
                        <div className="feedback-section-title"><span> Improved Version</span></div>
                        <ul className="feedback-list strengths">
                          {essayFeedback.holisticStrengths.map((s, i) => <li key={i}>{s}</li>)}
                        </ul>
                      </div>
                    )}
                    
                    {essayFeedback.holisticImprovements && (
                      <div className="feedback-section">
                        <div className="feedback-section-title"><span> Areas for Development</span></div>
                        <ul className="feedback-list improvements">
                          {essayFeedback.holisticImprovements.map((s, i) => <li key={i}>{s}</li>)}
                        </ul>
                      </div>
                    )}
                  </div>
                  
                  {essayFeedback.closingEncouragement && (
                    <div className="encouragement-box">
                      <p>{essayFeedback.closingEncouragement}</p>
                    </div>
                  )}
                </div>
              )}
              
              {/* Essay Comparison - Original vs Improved */}
              {isLoadingComparison && (
                <div className="card" style={parseStyle("text-align: center; padding: var(--space-xl); margin-top: var(--space-xl);")}>
                  <LoadingSpinner text="Comparing your original and improved essays..." />
                </div>
              )}
              
              {essayComparison && (
                <div className="essay-comparison ghost-appear">
                  <div className="comparison-header">
                    <h2 className="comparison-title"> Your Progress: Original vs Improved</h2>
                    <p className="comparison-subtitle">See how your corrections and revisions improved your essay</p>
                  </div>
                  
                  <div className="grade-comparison-boxes">
                    <div className="grade-box original">
                      <div className="grade-box-label">Original Essay</div>
                      <div className="grade-box-grade">
                        Grade {essayComparison.originalGrade}
                      </div>
                      <div className="grade-box-marks">
                        {essayComparison.originalMarks}/{essayComparison.totalMarks} marks
                      </div>
                    </div>
                    
                    <div className="comparison-arrow"></div>
                    
                    <div className="grade-box improved">
                      <div className="grade-box-label">Improved Essay</div>
                      <div className="grade-box-grade">
                        Grade {essayComparison.improvedGrade}
                      </div>
                      <div className="grade-box-marks">
                        {essayComparison.improvedMarks}/{essayComparison.totalMarks} marks
                      </div>
                    </div>
                  </div>
                  
                  <div className="improvement-summary">
                    <div className="improvement-headline">
                      {essayComparison.gradeImprovement}
                    </div>
                    {essayComparison.marksGained > 0 ? (
                      <div className="marks-gained">
                        <span></span>
                        +{essayComparison.marksGained} marks gained through improvements!
                      </div>
                    ) : (
                      <div style={{ color: 'var(--color-text-muted)', fontSize: '0.9rem' }}>
                        {essayComparison.essaysAreDifferent 
                          ? 'Your corrections maintained your grade level'
                          : 'No changes were made between versions'}
                      </div>
                    )}
                  </div>
                  
                  {essayComparison.keyImprovements && essayComparison.keyImprovements.length > 0 && (
                    <div className="improvement-details">
                      <h3 className="improvement-details-title">
                        <span></span> Key Improvements Made
                      </h3>
                      {essayComparison.keyImprovements.map((improvement, i) => (
                        <div key={i} className="improvement-item">
                          <div className="improvement-item-area">{improvement.area}</div>
                          <div className="improvement-item-before">{improvement.before}</div>
                          <div className="improvement-item-after">{improvement.after}</div>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {essayComparison.overallProgressComment && (
                    <div className="comparison-progress-comment">
                      <div className="comparison-progress-label">
                        <span></span> Overall Progress
                      </div>
                      <div className="comparison-progress-text">
                        {essayComparison.overallProgressComment}
                      </div>
                    </div>
                  )}
                  
                  {essayComparison.wouldHaveBeenGrade && (
                    <div style={{
                      marginTop: 'var(--space-lg)',
                      padding: 'var(--space-md)',
                      background: 'rgba(0, 0, 0, 0.2)',
                      borderRadius: 'var(--radius-md)',
                      textAlign: 'center'
                    }}>
                      <span style={{ color: 'var(--color-text-muted)', fontSize: '0.9rem' }}>
                         Without your improvements, your original would have received: 
                      </span>
                      <span style={{ color: 'var(--color-warning)', fontWeight: 600, marginLeft: 'var(--space-xs)' }}>
                        Grade {essayComparison.wouldHaveBeenGrade}
                      </span>
                    </div>
                  )}
                </div>
              )}
          
          {/* Official Grading Section - shown when mark scheme available */}
          {hasOfficialMarkScheme && (
            <>
              {!showOfficialGrading && !isLoadingOfficialGrading && (
                <div className="card" style={parseStyle("margin-top: var(--space-xl); text-align: center; padding: var(--space-xl); background: linear-gradient(135deg, rgba(25, 35, 55, 0.95), rgba(20, 30, 50, 0.98)); border: 2px solid var(--color-primary);")}>
                  <h3 style={parseStyle("margin-bottom: var(--space-md);")}>  Official Mark Scheme Grading</h3>
                  <p style={parseStyle("margin-bottom: var(--space-md); color: var(--color-text-secondary);")}>
                    Grade your essay against the official <strong>{config.officialMarkScheme.examBoard}</strong> mark scheme for {config.officialMarkScheme.qualification}.
                  </p>
                  <p style={parseStyle("margin-bottom: var(--space-lg); color: var(--color-text-muted); font-size: 0.9rem;")}>
                    This will compare your <strong>initial attempt</strong> with your <strong>improved version</strong> to show your progress.
                  </p>
                  <button className="btn btn-primary btn-large" onClick={onRequestOfficialGrading}>
                     Get Official Grading
                  </button>
                </div>
              )}
              
              {isLoadingOfficialGrading && (
                <div className="card" style={parseStyle("margin-top: var(--space-xl); text-align: center; padding: var(--space-2xl);")}>
                  <LoadingSpinner text="Grading against official mark scheme..." />
                  <p style={parseStyle("margin-top: var(--space-md); color: var(--color-text-muted);")}>
                    Comparing initial and improved versions...
                  </p>
                </div>
              )}
              
              {showOfficialGrading && officialGrading && (
                <div style={parseStyle("margin-top: var(--space-xl);")}>
                  <OfficialGradingDisplay grading={officialGrading} />
                </div>
              )}
            </>
          )}
          
          {/* Print Full Report Section - shown when any feedback is available */}
          {(essayFeedback || officialGrading) && (
            <div className="card" style={parseStyle("margin-top: var(--space-xl); background: linear-gradient(135deg; border: 2px solid var(--color-primary); text-align: center;")}>
              <h3 style={parseStyle("margin-bottom: var(--space-md);")}> Download Your Full Report</h3>
              <p style={parseStyle("margin-bottom: var(--space-lg); color: var(--color-text-secondary);")}>
                Get a complete printable report including your essay, feedback{officialGrading ? ', and official mark scheme grading' : ''}.
              </p>
              <div style={parseStyle("display: flex; gap: var(--space-md); justify-content: center; flex-wrap: wrap;")}>
                <button className="btn btn-primary btn-large" onClick={handlePrintReport}>
                   Print Full Report
                </button>
                <button className="btn btn-secondary btn-large" onClick={handleCopyReport}>
                   Copy to Clipboard
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }
    
    // =====================================================
    // TEACHER DASHBOARD
    // =====================================================
    
    function TeacherDashboard({ onLogout, onPreview }) {
      const [submissions, setSubmissions] = useState([]);
      const [inProgress, setInProgress] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedSubmission, setSelectedSubmission] = useState(null);
      const [error, setError] = useState(null);
      const [filterEssayId, setFilterEssayId] = useState('all');
      const [isRealtime, setIsRealtime] = useState(FIREBASE_ENABLED);
      const [activeTab, setActiveTab] = useState('submissions');
      
      // Teacher auth state
      const [teacherData, setTeacherData] = useState(TeacherAuth.getTeacher());
      const [showChangePassword, setShowChangePassword] = useState(false);
      const isAdmin = TeacherAuth.isAdmin();
      
      // Fetch data from Netlify Blobs (fallback)
      const fetchFromNetlify = useCallback(async () => {
        try {
          setError(null);
          const sessionToken = TeacherAuth.getSessionToken();
          const authParam = sessionToken 
            ? encodeURIComponent(sessionToken)
            : encodeURIComponent(GLOBAL.teacherPassword || 'teacher123');
          
          const [submissionsRes, progressRes] = await Promise.all([
            fetch(`/.netlify/functions/get-submissions?auth=${authParam}`),
            fetch(`/.netlify/functions/save-progress?auth=${authParam}`)
          ]);
          
          const submissionsData = await submissionsRes.json();
          const progressData = await progressRes.json();
          
          if (!submissionsRes.ok) {
            throw new Error(submissionsData.error || 'Failed to fetch submissions');
          }
          
          if (submissionsData.submissions) {
            setSubmissions(submissionsData.submissions);
          }
          
          if (progressData.inProgress) {
            setInProgress(progressData.inProgress);
          }
        } catch (error) {
          console.error('Failed to fetch data:', error);
          setError(error.message);
        } finally {
          setLoading(false);
        }
      }, []);
      
      // Set up Firebase real-time listeners or Netlify polling
      useEffect(() => {
        let unsubscribeSubmissions = null;
        let unsubscribeProgress = null;
        let interval = null;
        
        const setup = async () => {
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            // Real-time Firebase listeners
            setLoading(true);
            
            unsubscribeSubmissions = FirebaseDB.subscribeToSubmissions((data) => {
              setSubmissions(data);
              setLoading(false);
            });
            
            unsubscribeProgress = FirebaseDB.subscribeToProgress((data) => {
              setInProgress(data);
            });
          } else {
            // Fallback to Netlify polling
            fetchFromNetlify();
            interval = setInterval(fetchFromNetlify, 15000);
          }
        };
        
        setup();
        
        return () => {
          if (unsubscribeSubmissions) unsubscribeSubmissions();
          if (unsubscribeProgress) unsubscribeProgress();
          if (interval) clearInterval(interval);
        };
      }, [fetchFromNetlify]);
      
      // Manual refresh function
      const handleRefresh = async () => {
        const firebaseReady = await FirebaseDB.isReady();
        if (firebaseReady) {
          setLoading(true);
          try {
            const [subs, prog] = await Promise.all([
              FirebaseDB.getSubmissions(),
              FirebaseDB.getProgress()
            ]);
            if (subs) setSubmissions(subs);
            if (prog) setInProgress(prog);
          } catch (err) {
            console.error('Refresh error:', err);
          } finally {
            setLoading(false);
          }
        } else {
          fetchFromNetlify();
        }
      };
      
      // Filter submissions and progress by selected essay
      const filteredSubmissions = filterEssayId === 'all' 
        ? submissions 
        : submissions.filter(s => s.essayId === filterEssayId);
      
      const filteredInProgress = filterEssayId === 'all'
        ? inProgress
        : inProgress.filter(p => p.essayId === filterEssayId);
      
      // Get unique essay IDs from submissions for filter
      const availableEssays = [...new Set([
        ...submissions.map(s => s.essayId).filter(Boolean),
        ...inProgress.map(p => p.essayId).filter(Boolean)
      ])];
      
      if (loading) {
        return (
          <div className="app-container dashboard-container">
            <LoadingSpinner text="Loading submissions..." />
          </div>
        );
      }
      
      if (error) {
        return (
          <div className="app-container dashboard-container">
            <div className="card">
              <h3 style={parseStyle("color: var(--color-error); margin-bottom: var(--space-md);")}>Error Loading Dashboard</h3>
              <p style={parseStyle("margin-bottom: var(--space-lg);")}>{error}</p>
              <div style={parseStyle("display: flex; gap: var(--space-md);")}>
                <button className="btn btn-primary" onClick={handleRefresh}>Try Again</button>
                <button className="btn btn-secondary" onClick={onLogout}>Back to Home</button>
              </div>
            </div>
          </div>
        );
      }
      
      return (
        <div className="app-container dashboard-container">
          <div className="app-header">
            <div style={parseStyle("display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md);")}>
              <div>
                <h1 className="gold-glow">Teacher Dashboard</h1>
                <p className="subtitle">
                  {teacherData?.name || 'Teacher'}
                  {isAdmin && <span style={parseStyle("color: var(--color-warning); margin-left: var(--space-sm);")}>(Admin)</span>}
                </p>
                {FIREBASE_ENABLED && (
                  <span style={parseStyle("display: inline-flex; align-items: center; gap: var(--space-xs); margin-top: var(--space-xs); font-size: 0.8rem; color: var(--color-success);")}>
                    <span style={parseStyle("width: 8px; height: 8px; background: var(--color-success); border-radius: 50%; animation: pulse 2s infinite;")}></span>
                    Real-time updates enabled
                  </span>
                )}
              </div>
              <div style={parseStyle("display: flex; gap: var(--space-md); flex-wrap: wrap;")}>
                <button className="btn btn-secondary" onClick={handleRefresh}> Refresh</button>
                <button className="btn btn-secondary" onClick={() => setShowChangePassword(true)}>Change Password</button>
                <button className="btn btn-secondary" onClick={async () => {
                  await TeacherAuth.logout();
                  onLogout();
                }}>Logout</button>
              </div>
            </div>
          </div>
          
          {/* Tab Navigation */}
          <div className="card" style={parseStyle("margin-bottom: var(--space-lg); padding: var(--space-md);")}>
            <div style={parseStyle("display: flex; gap: var(--space-sm); flex-wrap: wrap;")}>
              <button 
                className={activeTab === 'submissions' ? 'btn btn-primary' : 'btn btn-secondary'}
                onClick={() => setActiveTab('submissions')}
              >
                Submissions
              </button>
              <button 
                className={activeTab === 'students' ? 'btn btn-primary' : 'btn btn-secondary'}
                onClick={() => setActiveTab('students')}
              >
                Students
              </button>
              <button
                className={activeTab === 'assignments' ? 'btn btn-primary' : 'btn btn-secondary'}
                onClick={() => setActiveTab('assignments')}
              >
                Assignments
              </button>
              <button
                className={activeTab === 'performance' ? 'btn btn-primary' : 'btn btn-secondary'}
                onClick={() => setActiveTab('performance')}
              >
                Performance
              </button>
              {isAdmin && (
                <button
                  className={activeTab === 'teachers' ? 'btn btn-primary' : 'btn btn-secondary'}
                  onClick={() => setActiveTab('teachers')}
                >
                  Teachers
                </button>
              )}
            </div>
          </div>
          
          {/* Tab Content */}
          {activeTab === 'students' && <StudentManagementPanel />}
          {activeTab === 'assignments' && <AssignmentsPanel />}
          {activeTab === 'performance' && <StudentPerformancePanel />}
          {activeTab === 'teachers' && isAdmin && <TeacherManagementPanel />}
          
          {activeTab === 'submissions' && (
          <>
          {/* Essay Filter */}
          {getEssayList().length > 1 && (
            <div className="card" style={parseStyle("margin-bottom: var(--space-lg);")}>
              <h4 style={parseStyle("margin-bottom: var(--space-md);")}>Filter by Essay</h4>
              <div className="essay-filter">
                <button 
                  className={`essay-filter-btn ${filterEssayId === 'all' ? 'active' : ''}`}
                  onClick={() => setFilterEssayId('all')}
                >
                  All Essays
                </button>
                {getEssayList().map(essay => (
                  <button 
                    key={essay.id}
                    className={`essay-filter-btn ${filterEssayId === essay.id ? 'active' : ''}`}
                    onClick={() => setFilterEssayId(essay.id)}
                  >
                    {essay.icon} {essay.title}
                  </button>
                ))}
              </div>
            </div>
          )}
          
          {/* Preview Essays */}
          <div className="card" style={parseStyle("margin-bottom: var(--space-lg);")}>
            <h4 style={parseStyle("margin-bottom: var(--space-md);")}> Preview Essays</h4>
            <div style={parseStyle("display: flex; gap: var(--space-md); flex-wrap: wrap;")}>
              {getEssayList().map(essay => (
                <button 
                  key={essay.id}
                  className="btn btn-primary"
                  onClick={() => onPreview(essay.id)}
                >
                  {essay.icon} {essay.title}
                </button>
              ))}
            </div>
          </div>
          
          {/* In-Progress Students */}
          <div className="card" style={parseStyle("margin-bottom: var(--space-xl);")}>
            <h3 style={parseStyle("margin-bottom: var(--space-lg);")}> In Progress ({filteredInProgress.length})</h3>
            
            {filteredInProgress.length === 0 ? (
              <p style={parseStyle("color: var(--color-text-muted); text-align: center; padding: var(--space-lg);")}>
                No students currently working on essays.
              </p>
            ) : (
              <div style={parseStyle("overflow-x: auto;")}>
                <table style={parseStyle("width: 100%; border-collapse: collapse;")}>
                  <thead>
                    <tr style={parseStyle("border-bottom: 2px solid var(--color-border);")}>
                      <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Student</th>
                      <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Email</th>
                      {filterEssayId === 'all' && <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Essay</th>}
                      <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Current Section</th>
                      <th style={parseStyle("padding: var(--space-md); text-align: center;")}>Progress</th>
                      <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Last Active</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredInProgress.map((student, index) => {
                      const essayInfo = getEssayList().find(e => e.id === student.essayId);
                      return (
                        <tr key={index} style={parseStyle("border-bottom: 1px solid var(--color-border-light);")}>
                          <td style={parseStyle("padding: var(--space-md);")}>{student.studentName}</td>
                          <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted); font-size: 0.85rem;")}>{student.studentEmail || '-'}</td>
                          {filterEssayId === 'all' && (
                            <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted); font-size: 0.9rem;")}>
                              {essayInfo?.icon} {essayInfo?.title || student.essayTitle || '-'}
                            </td>
                          )}
                          <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted);")}>
                            {student.currentParagraph || `Paragraph ${student.currentParagraphIndex || 1}`}
                          </td>
                          <td style={parseStyle("padding: var(--space-md); text-align: center;")}>
                            <div style={parseStyle("display: flex; align-items: center; justify-content: center; gap: var(--space-sm);")}>
                              <div style={parseStyle("width: 100px; height: 8px; background: var(--color-border); border-radius: 4px; overflow: hidden;")}>
                                <div style={{ width: `${student.percentComplete || 0}%`, height: '100%', background: 'var(--color-primary)', borderRadius: '4px', transition: 'width 0.3s ease' }} />
                              </div>
                              <span style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted);")}>
                                {student.completedParagraphs || 0}/{student.totalParagraphs || '?'}
                              </span>
                            </div>
                          </td>
                          <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted); font-size: 0.9rem;")}>
                            {student.lastUpdate ? formatDateTime(student.lastUpdate) : '-'}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>
          
          {/* Completed Submissions */}
          <div className="card">
            <h3 style={parseStyle("margin-bottom: var(--space-lg);")}> Completed Essays ({filteredSubmissions.length})</h3>
            
            {filteredSubmissions.length === 0 ? (
              <p style={parseStyle("color: var(--color-text-muted); text-align: center; padding: var(--space-xl);")}>
                No essays submitted yet.
              </p>
            ) : (
              <div style={parseStyle("overflow-x: auto;")}>
                <table style={parseStyle("width: 100%; border-collapse: collapse;")}>
                  <thead>
                    <tr style={parseStyle("border-bottom: 2px solid var(--color-border);")}>
                      <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Student</th>
                      <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Email</th>
                      {filterEssayId === 'all' && <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Essay</th>}
                      <th style={parseStyle("padding: var(--space-md); text-align: center;")}>Score</th>
                      <th style={parseStyle("padding: var(--space-md); text-align: center;")}>Grade</th>
                      <th style={parseStyle("padding: var(--space-md); text-align: center;")}>Feedback</th>
                      <th style={parseStyle("padding: var(--space-md); text-align: left;")}>Submitted</th>
                      <th style={parseStyle("padding: var(--space-md); text-align: center;")}>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredSubmissions.map((sub, index) => {
                      const essayInfo = getEssayList().find(e => e.id === sub.essayId);
                      const hasFeedback = !!sub.feedback;
                      const hasOfficial = !!sub.officialGrading;
                      return (
                        <tr key={index} style={parseStyle("border-bottom: 1px solid var(--color-border-light);")}>
                          <td style={parseStyle("padding: var(--space-md);")}>{sub.studentName}</td>
                          <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted); font-size: 0.85rem;")}>{sub.studentEmail || '-'}</td>
                          {filterEssayId === 'all' && (
                            <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted); font-size: 0.9rem;")}>
                              {essayInfo?.icon} {essayInfo?.title || sub.essayTitle || '-'}
                            </td>
                          )}
                          <td style={parseStyle("padding: var(--space-md); text-align: center; font-weight: 600; color: var(--color-success);")}>{sub.score}%</td>
                          <td style={parseStyle("padding: var(--space-md); text-align: center;")}>{sub.grade || '-'}</td>
                          <td style={parseStyle("padding: var(--space-md); text-align: center;")}>
                            <span title={hasFeedback ? 'Has feedback' : 'No feedback'} style={{ opacity: hasFeedback ? 1 : 0.3 }}> Feedback</span>
                            <span title={hasOfficial ? 'Has official grading' : 'No official grading'} style={{ opacity: hasOfficial ? 1 : 0.3, marginLeft: '4px' }}> Official Grading</span>
                          </td>
                          <td style={parseStyle("padding: var(--space-md); color: var(--color-text-muted);")}>{formatDateTime(sub.submittedAt)}</td>
                          <td style={parseStyle("padding: var(--space-md); text-align: center;")}>
                            <button className="btn btn-secondary" style={parseStyle("padding: var(--space-xs) var(--space-md); font-size: 0.85rem;")} onClick={() => setSelectedSubmission(sub)}>View</button>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>
          
          {selectedSubmission && (
            <div style={parseStyle("position: fixed; inset: 0; background: rgba(0; display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg); overflow: auto;")} onClick={() => setSelectedSubmission(null)}>
              <div className="card" style={parseStyle("max-width: 900px; width: 100%; max-height: 90vh; overflow: auto;")} onClick={(e) => e.stopPropagation()}>
                <div style={parseStyle("display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);")}>
                  <div>
                    <h3 style={parseStyle("margin-bottom: var(--space-xs);")}>{selectedSubmission.studentName}'s Essay</h3>
                    {selectedSubmission.studentEmail && (
                      <p style={parseStyle("color: var(--color-text-muted); font-size: 0.9rem; margin: 0;")}>{selectedSubmission.studentEmail}</p>
                    )}
                  </div>
                  <button className="btn btn-secondary" onClick={() => setSelectedSubmission(null)}>Close</button>
                </div>
                
                <div style={parseStyle("margin-bottom: var(--space-lg); display: flex; gap: var(--space-lg); flex-wrap: wrap;")}>
                  <div>
                    <strong>Score:</strong> {selectedSubmission.score}%
                    {selectedSubmission.grade && <>  <strong>Grade:</strong> {selectedSubmission.grade}</>}
                  </div>
                  {selectedSubmission.officialGrading && (
                    <div style={parseStyle("color: var(--color-success);")}>
                      <strong>Official:</strong> {selectedSubmission.officialGrading.improvedVersion?.totalMark} marks
                      {selectedSubmission.officialGrading.improvedVersion?.grade && <> (Grade {selectedSubmission.officialGrading.improvedVersion.grade})</>}
                    </div>
                  )}
                </div>
                
                {/* Essay Text - Show both Original and Final if different */}
                {selectedSubmission.essay && (
                  <div style={parseStyle("margin-bottom: var(--space-xl);")}>
                    {selectedSubmission.originalEssay && selectedSubmission.essaysAreDifferent ? (
                      <>
                        <h4 style={parseStyle("margin-bottom: var(--space-md);")}> Essays: Original vs Improved</h4>
                        <div style={parseStyle("display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);")}>
                          {/* Original Essay */}
                          <div>
                            <div style={parseStyle("font-size: 0.85rem; font-weight: 600; color: var(--color-text-muted); margin-bottom: var(--space-sm); text-transform: uppercase; letter-spacing: 1px;")}>
                               Original (First Attempt)
                            </div>
                            <div className="compiled-essay" style={parseStyle("background: var(--color-bg); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--color-border); max-height: 400px; overflow-y: auto; font-size: 0.9rem;")}>
                              {selectedSubmission.originalEssay.split('\n\n').map((para, i) => (
                                <p key={i} className="compiled-paragraph" style={parseStyle("margin-bottom: var(--space-sm);")}>{para}</p>
                              ))}
                            </div>
                          </div>
                          {/* Improved Essay */}
                          <div>
                            <div style={parseStyle("font-size: 0.85rem; font-weight: 600; color: var(--color-success); margin-bottom: var(--space-sm); text-transform: uppercase; letter-spacing: 1px;")}>
                               Improved (Final Version)
                            </div>
                            <div className="compiled-essay" style={parseStyle("background: var(--color-bg); padding: var(--space-md); border-radius: var(--radius-md); border: 2px solid var(--color-success); max-height: 400px; overflow-y: auto; font-size: 0.9rem;")}>
                              {selectedSubmission.essay.split('\n\n').map((para, i) => (
                                <p key={i} className="compiled-paragraph" style={parseStyle("margin-bottom: var(--space-sm);")}>{para}</p>
                              ))}
                            </div>
                          </div>
                        </div>
                      </>
                    ) : (
                      <>
                        <h4 style={parseStyle("margin-bottom: var(--space-md);")}> Essay</h4>
                        <div className="compiled-essay" style={parseStyle("background: var(--color-bg); padding: var(--space-lg); border-radius: var(--radius-md);")}>
                          {selectedSubmission.essay.split('\n\n').map((para, i) => (
                            <p key={i} className="compiled-paragraph">{para}</p>
                          ))}
                        </div>
                      </>
                    )}
                  </div>
                )}
                
                {/* Feedback Section */}
                {selectedSubmission.feedback && (
                  <div style={parseStyle("margin-bottom: var(--space-xl);")}>
                    <h4 style={parseStyle("margin-bottom: var(--space-md);")}>  Feedback</h4>
                    <div style={parseStyle("background: var(--color-bg); padding: var(--space-lg); border-radius: var(--radius-md);")}>
                      {selectedSubmission.feedback.essaySummary && (
                        <p style={parseStyle("margin-bottom: var(--space-md);")}>{selectedSubmission.feedback.essaySummary}</p>
                      )}
                      
                      {selectedSubmission.feedback.bestQuotation && (
                        <div style={parseStyle("font-style: italic; padding: var(--space-md); background: rgba(184; border-left: 3px solid var(--color-primary); margin-bottom: var(--space-md);")}>
                          "Best Writing: {selectedSubmission.feedback.bestQuotation}"
                        </div>
                      )}
                      
                      <div style={parseStyle("display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);")}>
                        {selectedSubmission.feedback.holisticStrengths && (
                          <div>
                            <strong style={parseStyle("color: var(--color-success);")}>  Strengths</strong>
                            <ul style={parseStyle("margin: var(--space-sm) 0 0 var(--space-md); padding: 0; font-size: 0.9rem;")}>
                              {selectedSubmission.feedback.holisticStrengths.map((s, i) => <li key={i}>{s}</li>)}
                            </ul>
                          </div>
                        )}
                        {selectedSubmission.feedback.holisticImprovements && (
                          <div>
                            <strong style={parseStyle("color: var(--color-warning);")}> To Improve</strong>
                            <ul style={parseStyle("margin: var(--space-sm) 0 0 var(--space-md); padding: 0; font-size: 0.9rem;")}>
                              {selectedSubmission.feedback.holisticImprovements.map((s, i) => <li key={i}>{s}</li>)}
                            </ul>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Official Grading Section */}
                {selectedSubmission.officialGrading && (
                  <div>
                    <h4 style={parseStyle("margin-bottom: var(--space-md);")}>  Official Mark Scheme Grading</h4>
                    <div style={parseStyle("background: var(--color-bg); padding: var(--space-lg); border-radius: var(--radius-md);")}>
                      {/* Improvement Summary */}
                      <div style={parseStyle("display: flex; justify-content: space-around; align-items: center; text-align: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-md);")}>
                        <div>
                          <div style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted);")}>Initial</div>
                          <div style={parseStyle("font-size: 1.5rem; font-weight: 700;")}>{selectedSubmission.officialGrading.initialVersion?.totalMark}</div>
                          <div style={parseStyle("font-size: 0.85rem; color: var(--color-text-muted);")}>Grade {selectedSubmission.officialGrading.initialVersion?.grade}</div>
                        </div>
                        <div style={parseStyle("font-size: 1.5rem; color: var(--color-primary);")}></div>
                        <div>
                          <div style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted);")}>Final</div>
                          <div style={parseStyle("font-size: 1.5rem; font-weight: 700; color: var(--color-success);")}>{selectedSubmission.officialGrading.improvedVersion?.totalMark}</div>
                          <div style={parseStyle("font-size: 0.85rem; color: var(--color-success);")}>Grade {selectedSubmission.officialGrading.improvedVersion?.grade}</div>
                        </div>
                        <div style={parseStyle("padding: var(--space-sm) var(--space-md); background: var(--color-success-bg); border-radius: var(--radius-md);")}>
                          <div style={parseStyle("font-size: 0.8rem; color: var(--color-success);")}>Improvement</div>
                          <div style={parseStyle("font-weight: 700; color: var(--color-success);")}>+{selectedSubmission.officialGrading.comparison?.marksImproved} marks</div>
                        </div>
                      </div>
                      
                      {selectedSubmission.officialGrading.comparison && (
                        <p style={parseStyle("font-size: 0.9rem; color: var(--color-text-secondary);")}>
                          <strong>Most improved:</strong> {selectedSubmission.officialGrading.comparison.mostImprovedArea}<br/>
                          {selectedSubmission.officialGrading.comparison.improvementSummary}
                        </p>
                      )}
                      
                      {selectedSubmission.officialGrading.examinerComment && (
                        <div style={parseStyle("margin-top: var(--space-md); font-style: italic; padding: var(--space-md); background: rgba(184; border-radius: var(--radius-md);")}>
                          <strong>Examiner:</strong> {selectedSubmission.officialGrading.examinerComment}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
          </>
          )}
          
          {showChangePassword && (
            <TeacherChangePasswordModal
              onClose={() => setShowChangePassword(false)}
              onSuccess={() => {
                setShowChangePassword(false);
                alert('Password changed successfully');
              }}
            />
          )}
        </div>
      );
    }
    
    // =====================================================
    // TEACHER AUTHENTICATION SYSTEM
    // =====================================================
    
    const TeacherAuth = {
      // Store session token
      setSession(token, teacher) {
        localStorage.setItem('teacherSessionToken', token);
        localStorage.setItem('teacherData', JSON.stringify(teacher));
      },
      
      // Get session token
      getSessionToken() {
        return localStorage.getItem('teacherSessionToken');
      },
      
      // Get teacher data
      getTeacher() {
        try {
          const data = localStorage.getItem('teacherData');
          return data ? JSON.parse(data) : null;
        } catch (e) {
          return null;
        }
      },
      
      // Clear session
      clearSession() {
        localStorage.removeItem('teacherSessionToken');
        localStorage.removeItem('teacherData');
      },
      
      // Check if logged in
      isLoggedIn() {
        return !!this.getSessionToken();
      },
      
      // Check if admin
      isAdmin() {
        const teacher = this.getTeacher();
        return teacher && teacher.role === 'admin';
      },
      
      // Verify session with server
      async verifySession() {
        const token = this.getSessionToken();
        if (!token) return { valid: false };
        
        try {
          const response = await fetch('/.netlify/functions/teacher-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'verify', sessionToken: token })
          });
          const result = await response.json();
          
          if (result.success) {
            localStorage.setItem('teacherData', JSON.stringify(result.teacher));
            return { valid: true, teacher: result.teacher, isAdmin: result.isAdmin };
          } else {
            this.clearSession();
            return { valid: false };
          }
        } catch (e) {
          return { valid: false, error: e.message };
        }
      },
      
      // Login
      async login(email, password) {
        try {
          const response = await fetch('/.netlify/functions/teacher-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'login', email, password })
          });
          const result = await response.json();
          
          if (result.success) {
            this.setSession(result.sessionToken, result.teacher);
            return { success: true, teacher: result.teacher };
          } else {
            return { success: false, error: result.error };
          }
        } catch (e) {
          return { success: false, error: 'Connection failed. Please try again.' };
        }
      },
      
      // Logout
      async logout() {
        const token = this.getSessionToken();
        if (token) {
          try {
            await fetch('/.netlify/functions/teacher-auth', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'logout', sessionToken: token })
            });
          } catch (e) {
            // Ignore logout errors
          }
        }
        this.clearSession();
      },
      
      // Check if teacher system is enabled (any teachers exist)
      async isTeacherAuthEnabled() {
        try {
          // Try to access a protected endpoint
          const response = await fetch('/.netlify/functions/manage-classes');
          const result = await response.json();
          return result.requiresAuth === true;
        } catch (e) {
          return false;
        }
      }
    };
    
    // =====================================================
    // TEACHER LOGIN FORM COMPONENT
    // =====================================================
    
    function TeacherLoginForm({ onSuccess, onBack, onCreateFirstAdmin }) {
      const [mode, setMode] = React.useState('login'); // 'login' or 'setup'
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [name, setName] = React.useState('');
      const [confirmPassword, setConfirmPassword] = React.useState('');
      const [error, setError] = React.useState('');
      const [isLoading, setIsLoading] = React.useState(false);
      const [checkingSetup, setCheckingSetup] = React.useState(true);
      const [teachersExist, setTeachersExist] = React.useState(true); // Default to true (hide setup button)

      // Check if any teachers exist (to show/hide First-time Setup button)
      React.useEffect(() => {
        const checkSetup = async () => {
          try {
            // Try to register with empty credentials - the error message tells us if teachers exist
            const response = await fetch('/.netlify/functions/teacher-auth', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'checkSetup' })
            });
            const result = await response.json();
            
            // If we get "Admin authentication required", teachers exist
            // If we get "Email, password, and name required", no teachers exist yet
            if (result.error && result.error.includes('Admin authentication required')) {
              setTeachersExist(true);
            } else if (result.error && (result.error.includes('required') || result.teachersExist === false)) {
              setTeachersExist(false);
            } else if (result.teachersExist !== undefined) {
              setTeachersExist(result.teachersExist);
            }
          } catch (e) {
            // Network error, assume teachers exist (safer default)
            setTeachersExist(true);
          }
          setCheckingSetup(false);
        };
        checkSetup();
      }, []);

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!email || !password) {
          setError('Please enter email and password');
          return;
        }
        
        setIsLoading(true);
        
        const result = await TeacherAuth.login(email, password);
        
        if (result.success) {
          onSuccess(result.teacher);
        } else {
          setError(result.error);
        }
        
        setIsLoading(false);
      };

      const handleSetup = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!email || !password || !name) {
          setError('Please fill in all fields');
          return;
        }
        
        if (password.length < 8) {
          setError('Password must be at least 8 characters');
          return;
        }
        
        if (password !== confirmPassword) {
          setError('Passwords do not match');
          return;
        }
        
        setIsLoading(true);
        
        try {
          const response = await fetch('/.netlify/functions/teacher-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'register',
              email,
              password,
              name
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Auto-login after registration
            const loginResult = await TeacherAuth.login(email, password);
            if (loginResult.success) {
              if (onCreateFirstAdmin) {
                onCreateFirstAdmin(loginResult.teacher);
              } else {
                onSuccess(loginResult.teacher);
              }
            } else {
              setError('Account created. Please log in.');
              setMode('login');
            }
          } else {
            if (result.error && result.error.includes('Admin authentication required')) {
              setError('Teacher accounts already exist. Please log in.');
              setMode('login');
            } else {
              setError(result.error || 'Failed to create account');
            }
          }
        } catch (e) {
          setError('Connection failed. Please try again.');
        }
        
        setIsLoading(false);
      };

      if (checkingSetup) {
        return (
          <div className="card" style={parseStyle("max-width: 400px; margin: 0 auto; text-align: center;")}>
            <div className="loading-spinner"></div>
            <p style={parseStyle("margin-top: var(--space-md); color: var(--color-text-muted);")}>
              Checking authentication...
            </p>
          </div>
        );
      }

      return (
        <div className="card" style={parseStyle("max-width: 420px; margin: 0 auto;")}>
          <h3 style={parseStyle("font-family: var(--font-display); margin-bottom: var(--space-lg); text-align: center;")}>
            {mode === 'setup' ? 'Create Admin Account' : 'Teacher Login'}
          </h3>
          
          {mode === 'setup' && (
            <div style={parseStyle("margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--color-info-bg); border: 1px solid var(--color-info); border-radius: var(--radius-md);")}>
              <p style={parseStyle("font-size: 0.9rem; color: var(--color-info);")}>
                <strong>First-time setup:</strong> Create the first admin account. This account will be able to create other teacher accounts.
              </p>
            </div>
          )}
          
          <form onSubmit={mode === 'setup' ? handleSetup : handleLogin}>
            {mode === 'setup' && (
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Your Name
                </label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Enter your full name"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>
            )}
            
            <div style={parseStyle("margin-bottom: var(--space-md);")}>
              <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                Email
              </label>
              <input
                type="email"
                value={email}
                onChange={(e) => { setEmail(e.target.value); setError(''); }}
                placeholder="teacher@school.com"
                className="paragraph-editor"
                style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                disabled={isLoading}
                autoFocus
              />
            </div>
            
            <div style={parseStyle("margin-bottom: var(--space-md);")}>
              <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                Password
              </label>
              <input
                type="password"
                value={password}
                onChange={(e) => { setPassword(e.target.value); setError(''); }}
                placeholder={mode === 'setup' ? 'At least 8 characters' : 'Enter password'}
                className="paragraph-editor"
                style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                disabled={isLoading}
              />
            </div>
            
            {mode === 'setup' && (
              <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Confirm Password
                </label>
                <input
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => { setConfirmPassword(e.target.value); setError(''); }}
                  placeholder="Confirm your password"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>
            )}
            
            {error && (
              <div style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-sm); color: var(--color-error); font-size: 0.9rem;")}>
                {error}
              </div>
            )}
            
            <div style={parseStyle("display: flex; gap: var(--space-sm); justify-content: space-between; align-items: center; flex-wrap: wrap;")}>
              <button type="button" className="btn btn-secondary" onClick={onBack} disabled={isLoading}>
                Back
              </button>
              
              <div style={parseStyle("display: flex; gap: var(--space-sm);")}>
                {mode === 'login' && !teachersExist && (
                  <button
                    type="button"
                    className="btn btn-secondary"
                    onClick={() => { setMode('setup'); setError(''); }}
                    disabled={isLoading}
                    style={parseStyle("font-size: 0.85rem;")}
                  >
                    First-time Setup
                  </button>
                )}
                {mode === 'setup' && (
                  <button
                    type="button"
                    className="btn btn-secondary"
                    onClick={() => { setMode('login'); setError(''); }}
                    disabled={isLoading}
                  >
                    Back to Login
                  </button>
                )}
                <button type="submit" className="btn btn-primary" disabled={isLoading}>
                  {isLoading ? 'Please wait...' : (mode === 'setup' ? 'Create Account' : 'Login')}
                </button>
              </div>
            </div>
          </form>
        </div>
      );
    }
    
    // =====================================================
    // TEACHER MANAGEMENT PANEL (Admin Only)
    // =====================================================
    
    function TeacherManagementPanel() {
      const [teachers, setTeachers] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState('');
      const [showAddTeacher, setShowAddTeacher] = React.useState(false);
      const [actionLoading, setActionLoading] = React.useState(null);
      
      const sessionToken = TeacherAuth.getSessionToken();
      const currentTeacher = TeacherAuth.getTeacher();

      const loadTeachers = async () => {
        setLoading(true);
        setError('');
        
        try {
          const response = await fetch('/.netlify/functions/teacher-auth?sessionToken=' + encodeURIComponent(sessionToken));
          const result = await response.json();
          
          if (result.success) {
            setTeachers(result.teachers || []);
          } else {
            setError(result.error || 'Failed to load teachers');
          }
        } catch (e) {
          setError('Connection failed');
        }
        
        setLoading(false);
      };

      React.useEffect(() => {
        loadTeachers();
      }, []);

      const handleResetPassword = async (email) => {
        if (!confirm('Reset password for ' + email + '?')) return;
        
        setActionLoading(email);
        
        try {
          const response = await fetch('/.netlify/functions/teacher-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'resetPassword',
              sessionToken,
              teacherEmail: email
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('New password: ' + result.newPassword + '\n\nPlease save this password and share it securely with the teacher.');
          } else {
            alert('Error: ' + result.error);
          }
        } catch (e) {
          alert('Connection failed');
        }
        
        setActionLoading(null);
      };

      const handleDeleteTeacher = async (email) => {
        if (!confirm('Delete teacher account for ' + email + '?\n\nThis will unassign all their classes.')) return;
        
        setActionLoading(email);
        
        try {
          const response = await fetch('/.netlify/functions/teacher-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'deleteTeacher',
              sessionToken,
              teacherEmail: email
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            loadTeachers();
          } else {
            alert('Error: ' + result.error);
          }
        } catch (e) {
          alert('Connection failed');
        }
        
        setActionLoading(null);
      };

      const handleToggleRole = async (email, currentRole) => {
        const newRole = currentRole === 'admin' ? 'teacher' : 'admin';
        if (!confirm('Change ' + email + ' to ' + newRole + '?')) return;
        
        setActionLoading(email);
        
        try {
          const response = await fetch('/.netlify/functions/teacher-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'updateRole',
              sessionToken,
              teacherEmail: email,
              newRole
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            loadTeachers();
          } else {
            alert('Error: ' + result.error);
          }
        } catch (e) {
          alert('Connection failed');
        }
        
        setActionLoading(null);
      };

      if (loading) {
        return (
          <div className="card">
            <div className="loading-spinner"></div>
            <p style={parseStyle("text-align: center; margin-top: var(--space-md); color: var(--color-text-muted);")}>
              Loading teachers...
            </p>
          </div>
        );
      }

      return (
        <div>
          <div className="card" style={parseStyle("margin-bottom: var(--space-lg);")}>
            <div style={parseStyle("display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md); margin-bottom: var(--space-lg);")}>
              <h3 style={parseStyle("margin: 0;")}>Teacher Accounts</h3>
              <button className="btn btn-primary" onClick={() => setShowAddTeacher(true)}>
                + Add Teacher
              </button>
            </div>
            
            {error && (
              <div style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-sm); color: var(--color-error);")}>
                {error}
              </div>
            )}
            
            {teachers.length === 0 ? (
              <p style={parseStyle("color: var(--color-text-muted); text-align: center; padding: var(--space-xl);")}>
                No teachers found. Add one to get started.
              </p>
            ) : (
              <div style={parseStyle("overflow-x: auto;")}>
                <table style={parseStyle("width: 100%; border-collapse: collapse;")}>
                  <thead>
                    <tr style={parseStyle("border-bottom: 2px solid var(--color-border);")}>
                      <th style={parseStyle("text-align: left; padding: var(--space-sm); font-size: 0.85rem; color: var(--color-text-muted);")}>Name</th>
                      <th style={parseStyle("text-align: left; padding: var(--space-sm); font-size: 0.85rem; color: var(--color-text-muted);")}>Email</th>
                      <th style={parseStyle("text-align: left; padding: var(--space-sm); font-size: 0.85rem; color: var(--color-text-muted);")}>Role</th>
                      <th style={parseStyle("text-align: left; padding: var(--space-sm); font-size: 0.85rem; color: var(--color-text-muted);")}>Last Login</th>
                      <th style={parseStyle("text-align: right; padding: var(--space-sm); font-size: 0.85rem; color: var(--color-text-muted);")}>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {teachers.map(teacher => (
                      <tr key={teacher.email} style={parseStyle("border-bottom: 1px solid var(--color-border-light);")}>
                        <td style={parseStyle("padding: var(--space-sm);")}>
                          <strong>{teacher.name}</strong>
                          {teacher.email === currentTeacher?.email && (
                            <span style={parseStyle("margin-left: var(--space-xs); font-size: 0.75rem; color: var(--color-primary); background: var(--color-primary-glow); padding: 2px 6px; border-radius: var(--radius-full);")}>(you)</span>
                          )}
                        </td>
                        <td style={parseStyle("padding: var(--space-sm); color: var(--color-text-muted);")}>{teacher.email}</td>
                        <td style={parseStyle("padding: var(--space-sm);")}>
                          <span style={parseStyle("display: inline-block; padding: 2px 8px; border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; " + (teacher.role === 'admin' ? "background: var(--color-warning-bg); color: var(--color-warning);" : "background: var(--color-info-bg); color: var(--color-info);"))}>
                            {teacher.role || 'teacher'}
                          </span>
                        </td>
                        <td style={parseStyle("padding: var(--space-sm); color: var(--color-text-muted); font-size: 0.9rem;")}>
                          {teacher.lastLogin ? new Date(teacher.lastLogin).toLocaleDateString() : 'Never'}
                        </td>
                        <td style={parseStyle("padding: var(--space-sm); text-align: right;")}>
                          <div style={parseStyle("display: flex; gap: var(--space-xs); justify-content: flex-end; flex-wrap: wrap;")}>
                            <button
                              className="btn btn-secondary"
                              style={parseStyle("padding: var(--space-xs) var(--space-sm); font-size: 0.8rem;")}
                              onClick={() => handleResetPassword(teacher.email)}
                              disabled={actionLoading === teacher.email}
                            >
                              Reset Password
                            </button>
                            {teacher.email !== currentTeacher?.email && (
                              <>
                                <button
                                  className="btn btn-secondary"
                                  style={parseStyle("padding: var(--space-xs) var(--space-sm); font-size: 0.8rem;")}
                                  onClick={() => handleToggleRole(teacher.email, teacher.role)}
                                  disabled={actionLoading === teacher.email}
                                >
                                  Make {teacher.role === 'admin' ? 'Teacher' : 'Admin'}
                                </button>
                                <button
                                  className="btn btn-secondary"
                                  style={parseStyle("padding: var(--space-xs) var(--space-sm); font-size: 0.8rem; color: var(--color-error);")}
                                  onClick={() => handleDeleteTeacher(teacher.email)}
                                  disabled={actionLoading === teacher.email}
                                >
                                  Delete
                                </button>
                              </>
                            )}
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
          
          {showAddTeacher && (
            <AddTeacherModal
              sessionToken={sessionToken}
              onClose={() => setShowAddTeacher(false)}
              onSuccess={() => {
                setShowAddTeacher(false);
                loadTeachers();
              }}
            />
          )}
        </div>
      );
    }
    
    // =====================================================
    // ADD TEACHER MODAL
    // =====================================================
    
    function AddTeacherModal({ sessionToken, onClose, onSuccess }) {
      const [email, setEmail] = React.useState('');
      const [name, setName] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [role, setRole] = React.useState('teacher');
      const [error, setError] = React.useState('');
      const [isLoading, setIsLoading] = React.useState(false);
      const [createdPassword, setCreatedPassword] = React.useState('');

      // Generate random password
      React.useEffect(() => {
        const chars = 'abcdefghjkmnpqrstuvwxyzABCDEFGHJKMNPQRSTUVWXYZ23456789';
        let pwd = '';
        for (let i = 0; i < 12; i++) {
          pwd += chars[Math.floor(Math.random() * chars.length)];
        }
        setPassword(pwd);
      }, []);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!email || !name || !password) {
          setError('Please fill in all fields');
          return;
        }
        
        if (password.length < 8) {
          setError('Password must be at least 8 characters');
          return;
        }
        
        setIsLoading(true);
        
        try {
          const response = await fetch('/.netlify/functions/teacher-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'register',
              sessionToken,
              email,
              name,
              password,
              role
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            setCreatedPassword(password);
          } else {
            setError(result.error || 'Failed to create teacher');
          }
        } catch (e) {
          setError('Connection failed');
        }
        
        setIsLoading(false);
      };

      if (createdPassword) {
        return (
          <div style={parseStyle("position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg);")}>
            <div className="card" style={parseStyle("max-width: 450px; width: 100%;")}>
              <div style={parseStyle("text-align: center; margin-bottom: var(--space-lg);")}>
                <div style={parseStyle("font-size: 3rem; margin-bottom: var(--space-md);")}>&#10003;</div>
                <h3 style={parseStyle("color: var(--color-success);")}>Teacher Account Created</h3>
              </div>
              
              <div style={parseStyle("background: var(--glass-bg); padding: var(--space-lg); border-radius: var(--radius-md); margin-bottom: var(--space-lg);")}>
                <p style={parseStyle("margin-bottom: var(--space-md);")}>
                  <strong>Email:</strong> {email}
                </p>
                <p style={parseStyle("margin-bottom: var(--space-md);")}>
                  <strong>Password:</strong>{' '}
                  <code style={parseStyle("background: var(--color-bg); padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-sm); font-family: var(--font-mono);")}>{createdPassword}</code>
                </p>
                <p style={parseStyle("margin-bottom: 0;")}>
                  <strong>Role:</strong> {role}
                </p>
              </div>
              
              <div style={parseStyle("padding: var(--space-md); background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-md); margin-bottom: var(--space-lg);")}>
                <p style={parseStyle("color: var(--color-warning); font-size: 0.9rem; margin: 0;")}>
                  <strong>Important:</strong> Save this password and share it securely with the teacher. It will not be shown again.
                </p>
              </div>
              
              <button className="btn btn-primary" style={parseStyle("width: 100%;")} onClick={onSuccess}>
                Done
              </button>
            </div>
          </div>
        );
      }

      return (
        <div style={parseStyle("position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg);")}>
          <div className="card" style={parseStyle("max-width: 450px; width: 100%;")}>
            <h3 style={parseStyle("font-family: var(--font-display); margin-bottom: var(--space-lg);")}>Add Teacher</h3>
            
            <form onSubmit={handleSubmit}>
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Name
                </label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Teacher's full name"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>
              
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Email
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="teacher@school.com"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>
              
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Password
                </label>
                <input
                  type="text"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm); font-family: var(--font-mono);")}
                  disabled={isLoading}
                />
                <p style={parseStyle("font-size: 0.8rem; color: var(--color-text-muted); margin-top: var(--space-xs);")}>
                  Auto-generated. You can modify it if needed.
                </p>
              </div>
              
              <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Role
                </label>
                <select
                  value={role}
                  onChange={(e) => setRole(e.target.value)}
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                >
                  <option value="teacher">Teacher</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              
              {error && (
                <div style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-sm); color: var(--color-error); font-size: 0.9rem;")}>
                  {error}
                </div>
              )}
              
              <div style={parseStyle("display: flex; gap: var(--space-sm); justify-content: flex-end;")}>
                <button type="button" className="btn btn-secondary" onClick={onClose} disabled={isLoading}>
                  Cancel
                </button>
                <button type="submit" className="btn btn-primary" disabled={isLoading}>
                  {isLoading ? 'Creating...' : 'Create Teacher'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    // =====================================================
    // MIGRATION WIZARD (For existing classes)
    // =====================================================
    
    function MigrationWizard({ onComplete }) {
      const [status, setStatus] = React.useState(null);
      const [loading, setLoading] = React.useState(true);
      const [assigning, setAssigning] = React.useState(false);
      const [selectedAssignments, setSelectedAssignments] = React.useState({});
      const [error, setError] = React.useState('');
      
      const sessionToken = TeacherAuth.getSessionToken();

      const loadStatus = async () => {
        setLoading(true);
        
        try {
          const response = await fetch('/.netlify/functions/migrate-classes?sessionToken=' + encodeURIComponent(sessionToken));
          const result = await response.json();
          
          if (result.success) {
            setStatus(result);
          } else {
            setError(result.error);
          }
        } catch (e) {
          setError('Failed to load migration status');
        }
        
        setLoading(false);
      };

      React.useEffect(() => {
        loadStatus();
      }, []);

      const handleClaimAll = async () => {
        if (!confirm('Assign all unassigned classes to yourself?')) return;
        
        setAssigning(true);
        
        try {
          const response = await fetch('/.netlify/functions/migrate-classes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'claimUnassigned',
              sessionToken
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            loadStatus();
          } else {
            setError(result.error);
          }
        } catch (e) {
          setError('Failed to claim classes');
        }
        
        setAssigning(false);
      };

      const handleAssignClass = async (classId, teacherEmail) => {
        setAssigning(true);
        
        try {
          const response = await fetch('/.netlify/functions/migrate-classes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'assignClass',
              sessionToken,
              classId,
              teacherEmail
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            loadStatus();
          } else {
            setError(result.error);
          }
        } catch (e) {
          setError('Failed to assign class');
        }
        
        setAssigning(false);
      };

      if (loading) {
        return (
          <div className="card">
            <div className="loading-spinner"></div>
            <p style={parseStyle("text-align: center; margin-top: var(--space-md);")}>Loading migration status...</p>
          </div>
        );
      }

      if (!status || status.status.unassignedClasses === 0) {
        return (
          <div className="card" style={parseStyle("text-align: center;")}>
            <div style={parseStyle("font-size: 3rem; margin-bottom: var(--space-md);")}>&#10003;</div>
            <h3 style={parseStyle("color: var(--color-success); margin-bottom: var(--space-md);")}>All Classes Assigned</h3>
            <p style={parseStyle("color: var(--color-text-muted); margin-bottom: var(--space-lg);")}>
              All {status?.status.totalClasses || 0} classes have been assigned to teachers.
            </p>
            <button className="btn btn-primary" onClick={onComplete}>
              Continue to Dashboard
            </button>
          </div>
        );
      }

      return (
        <div className="card">
          <h3 style={parseStyle("margin-bottom: var(--space-lg);")}>Class Migration</h3>
          
          <div style={parseStyle("margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-md);")}>
            <p style={parseStyle("color: var(--color-warning); margin: 0;")}>
              <strong>{status.status.unassignedClasses}</strong> classes need to be assigned to teachers.
            </p>
          </div>
          
          {error && (
            <div style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-sm); color: var(--color-error);")}>
              {error}
            </div>
          )}
          
          <div style={parseStyle("margin-bottom: var(--space-xl);")}>
            <h4 style={parseStyle("margin-bottom: var(--space-md);")}>Quick Actions</h4>
            <button 
              className="btn btn-primary" 
              onClick={handleClaimAll}
              disabled={assigning}
            >
              {assigning ? 'Assigning...' : 'Assign All to Me'}
            </button>
          </div>
          
          <h4 style={parseStyle("margin-bottom: var(--space-md);")}>Unassigned Classes</h4>
          
          <div style={parseStyle("display: flex; flex-direction: column; gap: var(--space-md);")}>
            {status.unassignedClasses.map(cls => (
              <div key={cls.id} style={parseStyle("display: flex; justify-content: space-between; align-items: center; padding: var(--space-md); background: var(--glass-bg); border: 1px solid var(--color-border); border-radius: var(--radius-md); flex-wrap: wrap; gap: var(--space-md);")}>
                <div>
                  <strong>{cls.name}</strong>
                  <span style={parseStyle("margin-left: var(--space-sm); color: var(--color-text-muted); font-size: 0.9rem;")}>
                    ({cls.studentCount} students)
                  </span>
                </div>
                <div style={parseStyle("display: flex; gap: var(--space-sm); align-items: center;")}>
                  <select
                    value={selectedAssignments[cls.id] || ''}
                    onChange={(e) => setSelectedAssignments({...selectedAssignments, [cls.id]: e.target.value})}
                    className="paragraph-editor"
                    style={parseStyle("min-height: auto; padding: var(--space-xs) var(--space-sm); min-width: 200px;")}
                  >
                    <option value="">Select teacher...</option>
                    {status.teachers.map(t => (
                      <option key={t.email} value={t.email}>{t.name}</option>
                    ))}
                  </select>
                  <button
                    className="btn btn-secondary"
                    onClick={() => handleAssignClass(cls.id, selectedAssignments[cls.id])}
                    disabled={!selectedAssignments[cls.id] || assigning}
                  >
                    Assign
                  </button>
                </div>
              </div>
            ))}
          </div>
          
          <div style={parseStyle("margin-top: var(--space-xl); display: flex; justify-content: flex-end;")}>
            <button className="btn btn-secondary" onClick={onComplete}>
              Skip for Now
            </button>
          </div>
        </div>
      );
    }
    
    // =====================================================
    // TEACHER CHANGE PASSWORD MODAL
    // =====================================================
    
    function TeacherChangePasswordModal({ onClose, onSuccess }) {
      const [currentPassword, setCurrentPassword] = React.useState('');
      const [newPassword, setNewPassword] = React.useState('');
      const [confirmPassword, setConfirmPassword] = React.useState('');
      const [error, setError] = React.useState('');
      const [isLoading, setIsLoading] = React.useState(false);
      
      const sessionToken = TeacherAuth.getSessionToken();

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!currentPassword || !newPassword || !confirmPassword) {
          setError('Please fill in all fields');
          return;
        }
        
        if (newPassword.length < 8) {
          setError('New password must be at least 8 characters');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          setError('New passwords do not match');
          return;
        }
        
        setIsLoading(true);
        
        try {
          const response = await fetch('/.netlify/functions/teacher-auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'changePassword',
              sessionToken,
              currentPassword,
              newPassword
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            onSuccess();
          } else {
            setError(result.error || 'Failed to change password');
          }
        } catch (e) {
          setError('Connection failed');
        }
        
        setIsLoading(false);
      };

      return (
        <div style={parseStyle("position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg);")}>
          <div className="card" style={parseStyle("max-width: 400px; width: 100%;")}>
            <h3 style={parseStyle("font-family: var(--font-display); margin-bottom: var(--space-lg);")}>Change Password</h3>
            
            <form onSubmit={handleSubmit}>
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Current Password
                </label>
                <input
                  type="password"
                  value={currentPassword}
                  onChange={(e) => setCurrentPassword(e.target.value)}
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>
              
              <div style={parseStyle("margin-bottom: var(--space-md);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  New Password
                </label>
                <input
                  type="password"
                  value={newPassword}
                  onChange={(e) => setNewPassword(e.target.value)}
                  placeholder="At least 8 characters"
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>
              
              <div style={parseStyle("margin-bottom: var(--space-lg);")}>
                <label style={parseStyle("display: block; margin-bottom: var(--space-xs); font-weight: 600; font-size: 0.9rem;")}>
                  Confirm New Password
                </label>
                <input
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  className="paragraph-editor"
                  style={parseStyle("min-height: auto; padding: var(--space-sm);")}
                  disabled={isLoading}
                />
              </div>
              
              {error && (
                <div style={parseStyle("margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--color-error-bg); border: 1px solid var(--color-error); border-radius: var(--radius-sm); color: var(--color-error); font-size: 0.9rem;")}>
                  {error}
                </div>
              )}
              
              <div style={parseStyle("display: flex; gap: var(--space-sm); justify-content: flex-end;")}>
                <button type="button" className="btn btn-secondary" onClick={onClose} disabled={isLoading}>
                  Cancel
                </button>
                <button type="submit" className="btn btn-primary" disabled={isLoading}>
                  {isLoading ? 'Saving...' : 'Change Password'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    // =====================================================
    // MAIN APP COMPONENT
    // =====================================================
    
    function App() {
      // Authentication state
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [currentStudent, setCurrentStudent] = useState(null);
      const [sessionToken, setSessionToken] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      
      // Teacher authentication state
      const [teacherData, setTeacherData] = useState(null);
      
      // Existing state
      const [screen, setScreen] = useState('login');
      const [selectedEssayId, setSelectedEssayId] = useState(null);
      const [studentName, setStudentName] = useState('');
      const [studentEmail, setStudentEmail] = useState('');
      const [targetGrade, setTargetGrade] = useState('');
      const [gradeSystem, setGradeSystem] = useState('gcse');
      const [currentParagraphIndex, setCurrentParagraphIndex] = useState(0);
      const [paragraphStates, setParagraphStates] = useState({});
      const [essayFeedback, setEssayFeedback] = useState(null);
      const [isLoadingEssayFeedback, setIsLoadingEssayFeedback] = useState(false);
      const [officialGrading, setOfficialGrading] = useState(null);
      const [isLoadingOfficialGrading, setIsLoadingOfficialGrading] = useState(false);
      const [taskPanelOpen, setTaskPanelOpen] = useState(false);
      const [isPreviewMode, setIsPreviewMode] = useState(false);
      
      // Get current essay config
      const CONFIG = selectedEssayId ? getEssayConfig(selectedEssayId) : null;
      const PARAGRAPHS = CONFIG?.paragraphs || [];
      const GRADING_CRITERIA = CONFIG ? getGradingCriteria(CONFIG) : {};
      
      // Check for existing session on load (both student and teacher)
      useEffect(() => {
        const checkSession = async () => {
          // Check for teacher session first
          if (TeacherAuth.isLoggedIn()) {
            const teacherResult = await TeacherAuth.verifySession();
            if (teacherResult.valid) {
              setTeacherData(teacherResult.teacher);
              setScreen('dashboard');
              setAuthLoading(false);
              return;
            }
          }
          
          // Check for student session
          const savedToken = localStorage.getItem('studentSession');
          const savedStudent = localStorage.getItem('studentData');
          
          if (savedToken && savedStudent) {
            try {
              let result;
              const firebaseReady = await FirebaseDB.isReady();
              if (firebaseReady) {
                result = await FirebaseDB.verifySession(savedToken);
              } else {
                const response = await fetch('/.netlify/functions/student-auth', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ action: 'verify', sessionToken: savedToken })
                });
                result = await response.json();
              }
              
              if (result.success) {
                setCurrentStudent(result.student);
                setSessionToken(savedToken);
                setIsAuthenticated(true);
                setStudentName(result.student.name);
                setStudentEmail(result.student.email);
                setScreen('student-dashboard');
              } else {
                localStorage.removeItem('studentSession');
                localStorage.removeItem('studentData');
              }
            } catch (err) {
              console.error('Session check error:', err);
              localStorage.removeItem('studentSession');
              localStorage.removeItem('studentData');
            }
          }
          setAuthLoading(false);
        };
        
        checkSession();
      }, []);
      
      // Handle successful student login
      const handleStudentLogin = (student, token) => {
        setCurrentStudent(student);
        setSessionToken(token);
        setIsAuthenticated(true);
        setStudentName(student.name);
        setStudentEmail(student.email);
        setScreen('student-dashboard');
      };

      // Handle student logout
      const handleStudentLogout = () => {
        setIsAuthenticated(false);
        setCurrentStudent(null);
        setSessionToken(null);
        setStudentName('');
        setStudentEmail('');
        setSelectedEssayId(null);
        setParagraphStates({});
        setCurrentParagraphIndex(0);
        setScreen('login');
      };

      // Handle essay selection from student dashboard
      const handleDashboardSelectEssay = async (essayId) => {
        setSelectedEssayId(essayId);
        
        // Check for saved progress before deciding which screen to show
        const essayConfig = getEssayConfig(essayId);
        let hasProgress = false;
        
        // Try to load from Firebase if user is authenticated
        if (studentEmail) {
          try {
            const firebaseReady = await FirebaseDB.isReady();
            if (firebaseReady) {
              const serverProgress = await FirebaseDB.getStudentEssayProgress(studentEmail, essayId);
              if (serverProgress && serverProgress.paragraphStates && Object.keys(serverProgress.paragraphStates).length > 0) {
                console.log('Loading progress from Firebase:', serverProgress);
                setStudentName(serverProgress.studentName || studentName);
                if (serverProgress.targetGrade) setTargetGrade(serverProgress.targetGrade);
                if (serverProgress.gradeSystem) setGradeSystem(serverProgress.gradeSystem);
                setParagraphStates(serverProgress.paragraphStates);
                setCurrentParagraphIndex(serverProgress.currentParagraphIndex || 0);
                
                const paragraphs = essayConfig?.paragraphs || [];
                const allComplete = paragraphs.every(p => serverProgress.paragraphStates[p.id]?.completed);
                setScreen(allComplete ? 'compilation' : 'writing');
                hasProgress = true;
              }
            }
          } catch (e) {
            console.log('Error loading Firebase progress:', e);
          }
        }
        
        // Also check localStorage if no Firebase progress
        if (!hasProgress && essayConfig) {
          const localSaved = localStorage.getItem(essayConfig.LOCAL_STORAGE_KEY);
          if (localSaved) {
            try {
              const data = JSON.parse(localSaved);
              if (data.studentName && data.paragraphStates && Object.keys(data.paragraphStates).length > 0) {
                console.log('Loading progress from localStorage:', data);
                setStudentName(data.studentName);
                if (data.studentEmail) setStudentEmail(data.studentEmail);
                if (data.targetGrade) setTargetGrade(data.targetGrade);
                if (data.gradeSystem) setGradeSystem(data.gradeSystem);
                setParagraphStates(data.paragraphStates);
                setCurrentParagraphIndex(data.currentParagraphIndex || 0);
                
                const paragraphs = essayConfig?.paragraphs || [];
                const allComplete = paragraphs.every(p => data.paragraphStates[p.id]?.completed);
                setScreen(allComplete ? 'compilation' : 'writing');
                hasProgress = true;
              }
            } catch (e) {
              console.log('Error loading localStorage:', e);
            }
          }
        }
        
        // No progress found - go to entry screen
        if (!hasProgress) {
          setScreen('entry');
        }
      };
      
      // Handle exploring non-assigned essay
      const handleExploreEssay = (essayId) => {
        setSelectedEssayId(essayId);
        setScreen('entry');
      };
      
      // Debug: log CONFIG and gradeBoundaries when essay is selected
      React.useEffect(() => {
        if (CONFIG && selectedEssayId) {
          console.log('[App] Essay config loaded:', {
            essayId: selectedEssayId,
            title: CONFIG.title,
            hasGradeBoundaries: !!CONFIG.gradeBoundaries,
            gradeBoundariesIsArray: Array.isArray(CONFIG.gradeBoundaries),
            gradeBoundariesLength: CONFIG.gradeBoundaries?.length,
            totalMarks: CONFIG.totalMarks,
            sampleGrade: CONFIG.gradeBoundaries?.[0]?.grade
          });
        }
      }, [CONFIG, selectedEssayId]);
      
      // Check URL for direct essay link (skip if not authenticated)
      useEffect(() => {
        if (!isAuthenticated) return;
        const urlParams = new URLSearchParams(window.location.search);
        const essayParam = urlParams.get('essay');
        if (essayParam && getEssays()[essayParam]) {
          setSelectedEssayId(essayParam);
          setScreen('entry');
        }
      }, [isAuthenticated]);
      
      // Load saved state for selected essay - check Firebase first, then localStorage
      useEffect(() => {
        if (!CONFIG || !selectedEssayId) return;
        
        const loadSavedProgress = async () => {
          let serverProgress = null;
          
          // Try to load from Firebase if user is authenticated
          if (studentEmail) {
            try {
              const firebaseReady = await FirebaseDB.isReady();
              if (firebaseReady) {
                serverProgress = await FirebaseDB.getStudentEssayProgress(studentEmail, selectedEssayId);
                console.log('Firebase progress loaded:', serverProgress);
              }
            } catch (e) {
              console.log('Error loading Firebase progress:', e);
            }
          }
          
          // Also check localStorage
          const localSaved = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
          let localProgress = null;
          if (localSaved) {
            try {
              localProgress = JSON.parse(localSaved);
            } catch (e) {
              console.log('Error parsing localStorage:', e);
            }
          }
          
          // Determine which progress to use (prefer more recent)
          let progressToUse = null;
          
          if (serverProgress && localProgress) {
            const serverTime = new Date(serverProgress.lastUpdate || 0).getTime();
            const localTime = new Date(localProgress.savedAt || 0).getTime();
            progressToUse = serverTime > localTime ? serverProgress : localProgress;
            console.log('Using', serverTime > localTime ? 'server' : 'local', 'progress');
          } else {
            progressToUse = serverProgress || localProgress;
          }
          
          if (progressToUse) {
            // Restore state
            if (progressToUse.studentName) setStudentName(progressToUse.studentName);
            if (progressToUse.studentEmail) setStudentEmail(progressToUse.studentEmail);
            if (progressToUse.targetGrade) setTargetGrade(progressToUse.targetGrade);
            if (progressToUse.gradeSystem) setGradeSystem(progressToUse.gradeSystem);
            if (progressToUse.paragraphStates) setParagraphStates(progressToUse.paragraphStates);
            if (progressToUse.currentParagraphIndex !== undefined) setCurrentParagraphIndex(progressToUse.currentParagraphIndex);
            
            // If has substantial progress, go directly to writing
            if (progressToUse.studentName && Object.keys(progressToUse.paragraphStates || {}).length > 0) {
              const allComplete = PARAGRAPHS.every(p => progressToUse.paragraphStates[p.id]?.completed);
              setScreen(allComplete ? 'compilation' : 'writing');
            }
          }
        };
        
        loadSavedProgress();
      }, [selectedEssayId]);
      
      // Auto-save to localStorage and server (skip in preview mode)
      useEffect(() => {
        if (!CONFIG || !studentName || screen !== 'writing' || isPreviewMode) return;
        
        // Need studentEmail for Firebase save
        if (!studentEmail) {
          console.log('Auto-save skipped: no studentEmail');
          return;
        }
        
        // Save to localStorage
        const saveData = { studentName, studentEmail, targetGrade, gradeSystem, paragraphStates, currentParagraphIndex, savedAt: new Date().toISOString() };
        localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify(saveData));
        
        // Save to server for teacher dashboard AND cross-device resume
        const completedCount = Object.values(paragraphStates).filter(s => s.completed).length;
        const percentComplete = Math.round((completedCount / PARAGRAPHS.length) * 100);
        const currentParagraph = PARAGRAPHS[currentParagraphIndex];
        
        const progressData = {
          studentName,
          studentEmail: studentEmail.toLowerCase(),
          targetGrade,
          gradeSystem,
          type: 'essay',
          essayId: selectedEssayId,
          essayTitle: CONFIG.essayTitle,
          currentParagraph: currentParagraph?.title || 'Starting',
          currentParagraphIndex: currentParagraphIndex, // Actual index for resume
          totalParagraphs: PARAGRAPHS.length,
          completedParagraphs: completedCount,
          percentComplete,
          paragraphScores: Object.entries(paragraphStates)
            .filter(([_, s]) => s.completed)
            .map(([id, s]) => ({ id, score: s.score })),
          // Include full paragraph states for cross-device resume
          paragraphStates: paragraphStates,
          lastUpdate: new Date().toISOString()
        };
        
        console.log('Auto-saving progress:', { studentEmail: progressData.studentEmail, essayId: progressData.essayId, completedCount, percentComplete });
        
        // Save to Firebase if available, otherwise Netlify Blobs
        (async () => {
          const firebaseReady = await FirebaseDB.isReady();
          if (firebaseReady) {
            FirebaseDB.saveProgress(progressData)
              .then(() => console.log('Firebase progress saved successfully'))
              .catch(err => console.log('Firebase save error:', err.message));
          } else {
            fetch('/.netlify/functions/save-progress', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(progressData)
            }).catch(err => console.log('Progress save note:', err.message));
          }
        })();
      }, [studentName, studentEmail, paragraphStates, currentParagraphIndex, screen, isPreviewMode, selectedEssayId]);
      
      const handleSelectEssay = (essayId) => {
        // Check if there's saved progress for this essay
        const essayConfig = getEssayConfig(essayId);
        const saved = essayConfig ? localStorage.getItem(essayConfig.LOCAL_STORAGE_KEY) : null;
        
        setSelectedEssayId(essayId);
        setEssayFeedback(null);
        setOfficialGrading(null);
        
        if (saved) {
          try {
            const data = JSON.parse(saved);
            // Has saved progress - load it
            if (data.studentName && Object.keys(data.paragraphStates || {}).length > 0) {
              setStudentName(data.studentName);
              setStudentEmail(data.studentEmail || '');
              setTargetGrade(data.targetGrade || '');
              setGradeSystem(data.gradeSystem || 'gcse');
              setParagraphStates(data.paragraphStates);
              setCurrentParagraphIndex(data.currentParagraphIndex || 0);
              
              // Check if all complete
              const paragraphs = essayConfig?.paragraphs || [];
              const allComplete = paragraphs.every(p => data.paragraphStates[p.id]?.completed);
              setScreen(allComplete ? 'compilation' : 'writing');
              return;
            }
          } catch (e) {
            console.error('Failed to load saved state:', e);
          }
        }
        
        // No saved progress - show entry screen
        setStudentName('');
        setStudentEmail('');
        setCurrentParagraphIndex(0);
        setParagraphStates({});
        setScreen('entry');
      };
      
      const handleStudentStart = (name, email, grade, system, resumeData = null) => {
        setStudentName(name);
        setStudentEmail(email);
        setTargetGrade(grade);
        setGradeSystem(system);
        
        // If resuming from saved progress, restore paragraph states
        if (resumeData && resumeData.paragraphStates) {
          setParagraphStates(resumeData.paragraphStates);
          if (resumeData.currentParagraphIndex !== undefined) {
            setCurrentParagraphIndex(resumeData.currentParagraphIndex);
          }
          console.log('Restored progress from server:', {
            paragraphs: Object.keys(resumeData.paragraphStates).length,
            currentIndex: resumeData.currentParagraphIndex
          });
        }
        
        setScreen('writing');
      };
      
      const handleTeacherLogin = (teacher) => {
        setTeacherData(teacher);
        setScreen('dashboard');
      };
      
      const handleTeacherLogout = async () => {
        await TeacherAuth.logout();
        setTeacherData(null);
        setScreen('login');
      };
      
      const handleSubmitAttempt = (paragraphId, attemptData) => {
        setParagraphStates(prev => {
          const current = prev[paragraphId] || { attempts: 0, feedbackHistory: [] };
          return {
            ...prev,
            [paragraphId]: {
              ...current,
              attempts: attemptData.attemptNumber,
              currentText: attemptData.text,
              // Store initial text on first attempt - use originalText if provided (before technical corrections)
              initialText: current.initialText || (attemptData.attemptNumber === 1 ? (attemptData.originalText || attemptData.text) : current.initialText),
              // Also store the raw original before any corrections
              originalBeforeCorrections: current.originalBeforeCorrections || (attemptData.attemptNumber === 1 ? (attemptData.originalText || attemptData.text) : current.originalBeforeCorrections),
              lastFeedback: attemptData.feedback,
              estimatedGrade: attemptData.estimatedGrade || attemptData.feedback?.estimatedGrade || null,
              feedbackHistory: [
                ...current.feedbackHistory,
                { 
                  text: attemptData.text, 
                  originalText: attemptData.originalText || attemptData.text,
                  feedback: attemptData.feedback.detailedFeedback, 
                  score: attemptData.feedback.overallScore,
                  estimatedGrade: attemptData.estimatedGrade || attemptData.feedback?.estimatedGrade || null
                }
              ]
            }
          };
        });
      };
      
    const handleCompleteParagraph = (paragraphId, finalText, finalFeedback) => {
  // Update paragraph state
  const newParagraphStates = {
    ...paragraphStates,
    [paragraphId]: {
      ...paragraphStates[paragraphId],
      completed: true,
      finalText: finalText,
      score: finalFeedback?.overallScore || 0,
      estimatedGrade: finalFeedback?.estimatedGrade || null
    }
  };
  setParagraphStates(newParagraphStates);
  
  const nextIndex = currentParagraphIndex + 1;
  if (nextIndex >= PARAGRAPHS.length) {
    // Last paragraph completed - go to compilation and AUTO-REQUEST feedback
    setScreen('compilation');
    
    // Automatically request essay feedback after a brief delay
    // (allows screen transition to complete)
    setTimeout(() => {
      requestEssayFeedbackWithStates(newParagraphStates);
    }, 500);
  } else {
    setCurrentParagraphIndex(nextIndex);
  }
};

// Separate function to request feedback with specific paragraph states
// (needed because setState is async and we need the updated states immediately)
const requestEssayFeedbackWithStates = async (currentParagraphStates) => {
  setIsLoadingEssayFeedback(true);
  
  try {
    const paragraphData = PARAGRAPHS.map(p => ({
      config: p,
      finalText: currentParagraphStates[p.id]?.finalText || '',
      attempts: currentParagraphStates[p.id]?.attempts || 0,
      paragraphScore: currentParagraphStates[p.id]?.score || 0,
      estimatedGrade: currentParagraphStates[p.id]?.estimatedGrade || null
    }));
    
    // Check if we have authentic grade boundaries
    const hasAuthenticDescriptors = CONFIG.gradeBoundaries && Array.isArray(CONFIG.gradeBoundaries) && CONFIG.gradeBoundaries.length > 0;
    
    const response = await fetch('/.netlify/functions/grade-essay', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        studentName,
        essayTitle: CONFIG.essayTitle,
        paragraphs: paragraphData,
        gradingCriteria: GRADING_CRITERIA,
        gradeBoundaries: CONFIG.gradeBoundaries || null,
        totalMarks: CONFIG.totalMarks || null,
        targetGrade: targetGrade,
        gradeSystem: gradeSystem
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      setEssayFeedback({ 
        ...data.feedback, 
        finalScore: data.finalScore,
        finalGrade: data.finalGrade,
        awardedMarks: data.awardedMarks,
        totalMarks: data.totalMarks,
        usedAuthenticDescriptors: data.usedAuthenticDescriptors
      });
      
      const submissionData = {
        type: 'essay',
        essayId: selectedEssayId,
        essayTitle: CONFIG.essayTitle,
        studentName,
        studentEmail,
        score: data.finalScore,
        grade: data.finalGrade || data.feedback.overallGrade,
        awardedMarks: data.awardedMarks,
        totalMarks: data.totalMarks,
        essay: data.fullEssay,
        paragraphSummary: data.paragraphSummary,
        feedback: data.feedback,
        usedAuthenticDescriptors: data.usedAuthenticDescriptors,
        submittedAt: new Date().toISOString()
      };
      
      try {
        // Save to Firebase if available, otherwise Netlify Blobs
        const firebaseReady = await FirebaseDB.isReady();
        if (firebaseReady) {
          await FirebaseDB.submitEssay(submissionData);
        } else {
          await fetch('/.netlify/functions/submit-homework', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(submissionData)
          });
        }
      } catch (submitError) {
        console.error('Failed to save submission:', submitError);
      }
      
      localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEY);
    } else {
      throw new Error(data.error || 'Failed to grade essay');
    }
  } catch (error) {
    console.error('Essay grading error:', error);
    alert('Failed to get essay feedback. Please try again.');
  } finally {
    setIsLoadingEssayFeedback(false);
  }
};
      
      const handleNavigate = (index) => {
        setCurrentParagraphIndex(index);
      };
      
      const handleRequestEssayFeedback = async () => {
        setIsLoadingEssayFeedback(true);
        
        try {
          const paragraphData = PARAGRAPHS.map(p => ({
            config: p,
            finalText: paragraphStates[p.id]?.finalText || '',
            originalText: paragraphStates[p.id]?.originalBeforeCorrections || paragraphStates[p.id]?.initialText || paragraphStates[p.id]?.finalText || '',
            attempts: paragraphStates[p.id]?.attempts || 0,
            paragraphScore: paragraphStates[p.id]?.score || 0,
            estimatedGrade: paragraphStates[p.id]?.estimatedGrade || null
          }));
          
          // Build original essay from original texts
          const originalEssay = paragraphData.map(p => p.originalText).join('\n\n');
          
          // Check if we have authentic grade boundaries
          const hasAuthenticDescriptors = CONFIG.gradeBoundaries && Array.isArray(CONFIG.gradeBoundaries) && CONFIG.gradeBoundaries.length > 0;
          
          const response = await fetch('/.netlify/functions/grade-essay', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              studentName,
              essayTitle: CONFIG.essayTitle,
              paragraphs: paragraphData,
              gradingCriteria: GRADING_CRITERIA,
              gradeBoundaries: CONFIG.gradeBoundaries || null,  // Pass authentic grade descriptors if available
              totalMarks: CONFIG.totalMarks || null,            // Pass total marks
              targetGrade: targetGrade,
              gradeSystem: gradeSystem
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            setEssayFeedback({ 
              ...data.feedback, 
              finalScore: data.finalScore,
              finalGrade: data.finalGrade,
              awardedMarks: data.awardedMarks,
              totalMarks: data.totalMarks,
              usedAuthenticDescriptors: data.usedAuthenticDescriptors
            });
            
            // Check if original and final essays are different
            const essaysAreDifferent = originalEssay.trim() !== data.fullEssay.trim();
            
            const submissionData = {
              type: 'essay',
              essayId: selectedEssayId,
              essayTitle: CONFIG.essayTitle,
              studentName,
              studentEmail,
              score: data.finalScore,
              grade: data.finalGrade || data.feedback.overallGrade,
              awardedMarks: data.awardedMarks,
              totalMarks: data.totalMarks,
              essay: data.fullEssay,
              originalEssay: originalEssay, // Original essay before corrections
              essaysAreDifferent: essaysAreDifferent, // Flag if improvements were made
              paragraphSummary: data.paragraphSummary,
              feedback: data.feedback,
              usedAuthenticDescriptors: data.usedAuthenticDescriptors,
              submittedAt: new Date().toISOString()
            };
            
            try {
              // Save to Firebase if available, otherwise Netlify Blobs
              const firebaseReady = await FirebaseDB.isReady();
              if (firebaseReady) {
                await FirebaseDB.submitEssay(submissionData);
              } else {
                await fetch('/.netlify/functions/submit-homework', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(submissionData)
                });
              }
            } catch (submitError) {
              console.error('Failed to save submission:', submitError);
            }
            
            localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEY);
          } else {
            throw new Error(data.error || 'Failed to grade essay');
          }
        } catch (error) {
          console.error('Essay grading error:', error);
          alert('Failed to get essay feedback. Please try again.');
        } finally {
          setIsLoadingEssayFeedback(false);
        }
      };
      
      const handleRequestOfficialGrading = async () => {
        if (!CONFIG?.officialMarkScheme) {
          alert('No official mark scheme configured for this essay.');
          return;
        }
        
        setIsLoadingOfficialGrading(true);
        
        try {
          const paragraphData = PARAGRAPHS.map(p => ({
            config: p,
            finalText: paragraphStates[p.id]?.finalText || '',
            initialText: paragraphStates[p.id]?.initialText || paragraphStates[p.id]?.finalText || '',
            attempts: paragraphStates[p.id]?.attempts || 0
          }));
          
          const response = await fetch('/.netlify/functions/grade-official', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              studentName,
              essayTitle: CONFIG.essayTitle,
              paragraphs: paragraphData,
              officialMarkScheme: CONFIG.officialMarkScheme,
              examBoard: CONFIG.officialMarkScheme.examBoard
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            setOfficialGrading(data.grading);
            
            // Update the submission with official grading
            const updateData = {
              type: 'essay',
              essayId: selectedEssayId,
              studentName,
              officialGrading: data.grading,
              updatedAt: new Date().toISOString()
            };
            
            try {
              const firebaseReady = await FirebaseDB.isReady();
              if (firebaseReady) {
                await FirebaseDB.updateSubmission(studentName, selectedEssayId, { officialGrading: data.grading });
              } else {
                await fetch('/.netlify/functions/submit-homework', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ...updateData, updateOnly: true })
                });
              }
            } catch (updateError) {
              console.error('Failed to update submission with official grading:', updateError);
            }
          } else {
            throw new Error(data.error || 'Failed to get official grading');
          }
        } catch (error) {
          console.error('Official grading error:', error);
          alert('Failed to get official grading. Please try again.');
        } finally {
          setIsLoadingOfficialGrading(false);
        }
      };
      
      const handleLogout = () => {
        setScreen('select-essay');
        setSelectedEssayId(null);
        setIsPreviewMode(false);
        setStudentName('');
        setStudentEmail('');
        setTargetGrade('');
        setGradeSystem('gcse');
        setParagraphStates({});
        setCurrentParagraphIndex(0);
        setEssayFeedback(null);
        setOfficialGrading(null);
      };
      
      const handleBackToEssayList = () => {
        setScreen('select-essay');
        setSelectedEssayId(null);
        setStudentName('');
        setStudentEmail('');
        setTargetGrade('');
        setGradeSystem('gcse');
        setParagraphStates({});
        setCurrentParagraphIndex(0);
        setEssayFeedback(null);
        setOfficialGrading(null);
      };
      
      const handlePreviewMode = (essayId, selectedTargetGrade = null) => {
        if (essayId) {
          setSelectedEssayId(essayId);
        }
        const config = getEssayConfig(essayId || selectedEssayId);
        const detectedGradeSystem = getGradeSystem(config);
        
        // If no grade provided, show the preview entry screen
        if (!selectedTargetGrade) {
          setGradeSystem(detectedGradeSystem);
          setIsPreviewMode(true);
          setScreen('preview-entry');
          return;
        }
        
        setStudentName('Teacher Preview');
        setStudentEmail('teacher@preview.mode');
        setTargetGrade(selectedTargetGrade);
        setGradeSystem(detectedGradeSystem);
        setCurrentParagraphIndex(0);
        setParagraphStates({});
        setEssayFeedback(null);
        setOfficialGrading(null);
        setIsPreviewMode(true);
        setScreen('writing');
      };
      
      // Render screens
      
      // Show loading while checking authentication
      if (authLoading) {
        return <LoadingSpinner text="Loading..." />;
      }
      
      // Login screen
      if (screen === 'login') {
        return (
          <StudentLoginScreen 
            onLoginSuccess={handleStudentLogin}
            onTeacherLogin={handleTeacherLogin}
          />
        );
      }
      
      // Student dashboard
      if (screen === 'student-dashboard') {
        return (
          <StudentDashboard
            student={currentStudent}
            sessionToken={sessionToken}
            onSelectEssay={handleDashboardSelectEssay}
            onExploreEssay={handleExploreEssay}
            onLogout={handleStudentLogout}
          />
        );
      }
      
      if (screen === 'select-essay') {
        return <EssaySelectionScreen onSelectEssay={handleSelectEssay} onTeacherLogin={handleTeacherLogin} />;
      }
      
      if (screen === 'entry') {
        return <EntryScreen config={CONFIG} onStudentStart={handleStudentStart} onBack={isAuthenticated ? () => setScreen('student-dashboard') : handleBackToEssayList} loggedInStudent={isAuthenticated ? currentStudent : null} />;
      }
      
      if (screen === 'dashboard') {
        return <TeacherDashboard onLogout={handleTeacherLogout} onPreview={handlePreviewMode} />;
      }
      
      if (screen === 'preview-entry') {
        return (
          <TeacherPreviewEntry 
            config={CONFIG} 
            gradeSystem={gradeSystem}
            onStartPreview={(grade) => handlePreviewMode(selectedEssayId, grade)}
            onBack={() => {
              setIsPreviewMode(false);
              setScreen('dashboard');
            }}
          />
        );
      }
      
      if (screen === 'compilation') {
        if (!CONFIG) return <LoadingSpinner text="Loading..." />;
        return (
          <div className="app-container">
            <div className="app-header">
              <h1 className="gold-glow">{CONFIG.title}</h1>
              <p className="subtitle">Essay Complete - {studentName}</p>
            </div>
            <EssayCompilationScreen
              studentName={studentName}
              paragraphs={PARAGRAPHS}
              paragraphStates={paragraphStates}
              onRequestFeedback={handleRequestEssayFeedback}
              onRequestOfficialGrading={handleRequestOfficialGrading}
              essayFeedback={essayFeedback}
              officialGrading={officialGrading}
              isLoadingFeedback={isLoadingEssayFeedback}
              isLoadingOfficialGrading={isLoadingOfficialGrading}
              config={CONFIG}
            />
          </div>
        );
      }
      
      // Writing screen
      const currentParagraph = PARAGRAPHS[currentParagraphIndex];
      if (!CONFIG || !currentParagraph) return <LoadingSpinner text="Loading essay..." />;
      const hasOriginalTask = !!CONFIG.originalTask;
      const hasReferenceContent = hasOriginalTask || !!CONFIG?.sourceMaterial || !!currentParagraph?.sourceMaterial;
      
      return (
        <div className="app-container" style={{ maxWidth: hasReferenceContent ? '1400px' : '880px' }}>
          <div className="app-header">
            <h1 className="gold-glow">{CONFIG.title}</h1>
            <p className="subtitle">{CONFIG.subject}  {studentName}</p>
            {CONFIG.essayTitle && <p className="essay-title">"{CONFIG.essayTitle}"</p>}
            {targetGrade && (
              <div className="target-grade-badge" style={parseStyle("margin-top: var(--space-sm);")}>
                Target: <strong>{gradeSystem === 'alevel' ? targetGrade : `Grade ${targetGrade}`}</strong>
              </div>
            )}
          </div>
          
          {isPreviewMode && (
            <div className="card" style={parseStyle("margin-bottom: var(--space-lg); background: linear-gradient(135deg; border: 2px solid var(--color-primary); display: flex; justify-content: space-between; align-items: center; padding: var(--space-md) var(--space-lg);")}>
              <div>
                <strong style={parseStyle("color: var(--color-primary-light);")}> Teacher Preview Mode</strong>
                <span style={parseStyle("margin-left: var(--space-md); color: var(--color-text-muted);")}>
                  Paste enabled  Free navigation  Progress not saved
                </span>
              </div>
              <button className="btn btn-secondary" onClick={() => {
                setScreen('dashboard');
                setIsPreviewMode(false);
                setStudentName('');
                setParagraphStates({});
                setCurrentParagraphIndex(0);
              }}>
                 Exit Preview
              </button>
            </div>
          )}
          
          <ParagraphTracker
            paragraphs={PARAGRAPHS}
            currentIndex={currentParagraphIndex}
            paragraphStates={paragraphStates}
            onNavigate={handleNavigate}
            previewMode={isPreviewMode}
          />
          
          <div className="writing-layout">
            <div className="writing-main">
              <ParagraphScreen
                key={currentParagraph.id}
                paragraph={currentParagraph}
                paragraphState={paragraphStates[currentParagraph.id]}
                paragraphStates={paragraphStates}
                onSubmitAttempt={(data) => handleSubmitAttempt(currentParagraph.id, data)}
                onComplete={(text, feedback) => handleCompleteParagraph(currentParagraph.id, text, feedback)}
                previewMode={isPreviewMode}
                config={CONFIG}
                gradingCriteria={GRADING_CRITERIA}
                gradeBoundaries={CONFIG?.gradeBoundaries}
                totalMarks={CONFIG?.totalMarks}
                targetGrade={targetGrade}
                gradeSystem={gradeSystem}
              />
            </div>
            
            {(hasOriginalTask || CONFIG?.sourceMaterial || currentParagraph?.sourceMaterial) && (
              <TaskPanel 
                isOpen={taskPanelOpen} 
                onClose={() => setTaskPanelOpen(false)}
                config={CONFIG}
                sourceMaterial={CONFIG?.sourceMaterial || currentParagraph?.sourceMaterial}
              />
            )}
          </div>
          
          <TaskToggleButton 
            onClick={() => setTaskPanelOpen(true)} 
            hasTask={hasReferenceContent}
          />
        </div>
      );
    }
    
    // =====================================================
    // RENDER
    // =====================================================
    
    // Wait for essays to load before rendering the app
    loadEssays().then(() => {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    });
  </script>
</body>
</html>
